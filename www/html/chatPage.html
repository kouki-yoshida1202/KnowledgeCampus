<ons-page id="chatPage">
  <ons-toolbar>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
    >
      取引メッセージ
    </div>
  </ons-toolbar>
  <div class="mainHeader">
    <ons-carousel
      id="tabChatCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="50%"
      initial-index="0"
      style="height:40px;"
    >
      <ons-carousel-item class="active_tabCarousel">
        <div class="item-label" style="line-height: 35px;">
          購入サービス
        </div>
      </ons-carousel-item>
      <ons-carousel-item style="line-height: 35px;">
        <div class="item-label">出品サービス</div>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <div class="content">
    <ons-carousel
      id="chatCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="100%"
      initial-index="0"
      reflesh="console.log('Changed to ' + $event.activeIndex)"
    >
      <ons-carousel-item style="min-height: 500px;">
        <ons-list id="buyProductCommentsList" style="background-image: none;">
        </ons-list>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <ons-list
          id="syuppinProductCommentsList"
          style="background-image: none;"
        >
        </ons-list>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <script>
    ("use strict");
    setTimeout(function() {
      var chatCarousel = document.getElementById("chatCarousel");
      chatCarousel.addEventListener("postchange", function(e) {
        // alert(e.activeIndex);
        tabChatCarouselChange(e.activeIndex);
      });
    }, 100);

    function tabChatCarouselChange(carouselIndex) {
      $("#tabChatCarousel ons-carousel-item").removeClass("active_tabCarousel");
      $("#tabChatCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
    }
    ons.ready(function() {
      var page = document.getElementById("chatPage");
      var toolbar = page.querySelector(".toolbar");
      var header = page.querySelector(".mainHeader");
      var content = page.querySelector(".content");
      header.style.top = toolbar.clientHeight + "px";
      content.style.marginTop = 40 + "px";
    });

    document.addEventListener(
      "init",
      function(event) {
        if (event.target.matches("#chatPage")) {
          buyProductComments();
          syuppinProductComments();
        }
      },
      false
    );

    function buyProductComments() {
      $("#buyProductCommentsList").empty();
      var torihikiChatCounter = 1;
      var user = firebase.auth().currentUser;
      db.collection("negotiations")
        .where("buyUserId", "==", user.uid)
        .get()
        .then(function(negotiations) {
          negotiations.forEach(nego => {
            var negotiationId = nego.id;
            var productUserId = nego.data().productUserId;
            db.collection("negotiations")
              .doc(negotiationId)
              .collection("comments")
              .where("userId", "==", productUserId)
              .limit(10)
              .orderBy("createTime", "desc")
              .get()
              .then(function(commentResults) {
                commentResults.forEach(comment => {
                  var buycommentlist =
                    `
                      <ons-list-item id="torihikiChat_` +
                    torihikiChatCounter +
                    `">
                        <div
                          class="left"
                        >
                          <img id="torihikiChatImage_` +
                    torihikiChatCounter +
                    `"
                            class="list-item__thumbnail"
                            src="img/userSampleImageMan.png"
                            style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                          />
                        </div>
                        <div
                          class="center"
                          style="width:50%;"
                        >
                          <span
                            class="list-item__subtitle light-navy-font"
                            style="height:55px;overflow: hidden;"
                            ><span id="torihikiChatName_` +
                    torihikiChatCounter +
                    `"></span>さんから取引メッセージが届きました。</span
                          >
                        </div>
                        <div class="right">
                          <span id="torihikiChatTime_` +
                    torihikiChatCounter +
                    `" class="list-item__subtitle light-navy-font"></span>
                        </div>
                      </ons-list-item>
                    `;
                  $("#buyProductCommentsList").append(buycommentlist);
                  torihikiChatIndicate(
                    nego.id,
                    productUserId,
                    comment.data().createTime,
                    torihikiChatCounter
                  );
                  torihikiChatCounter++;
                });
              })
              .catch(function(error) {
                console.log(error);
              });
          });
        })
        .catch(function(error) {
          console.log(error);
        });
    }

    function torihikiChatIndicate(
      negotiationId,
      productUserId,
      commentCreateTime,
      torihikiChatCounter
    ) {
      db.collection("users")
        .doc(productUserId)
        .get()
        .then(function(productUser) {
          var username = productUser.data().username;
          //「月」を取得する
          var commentTime = firebaseTimeControl(commentCreateTime);
          $("#torihikiChatName_" + torihikiChatCounter).html(username);
          $("#torihikiChatTime_" + torihikiChatCounter).html(commentTime);
          db.collection("negotiations")
            .doc(negotiationId)
            .get()
            .then(function(negoResult) {
              document.getElementById(
                "torihikiChat_" + torihikiChatCounter
              ).onclick = new Function(
                "torihikiPageJump('" +
                  negoResult.data().productId +
                  "','" +
                  negoResult.data().buyUserId +
                  "','" +
                  negoResult.data().productUserId +
                  "')"
              );
            });

          firebase
            .storage()
            .ref()
            .child("profilePicture/" + productUserId)
            .getDownloadURL()
            .then(url => {
              document.getElementById(
                "torihikiChatImage_" + torihikiChatCounter
              ).src = url;
            })
            .catch(function() {
              document.getElementById(
                "torihikiChatImage_" + torihikiChatCounter
              ).src = "img/userSampleImageMan.png";
            });
        });
    }

    function syuppinProductComments() {
      $("#syuppinProductCommentsList").empty();
      var syuppinChatCounter = 1;
      var user = firebase.auth().currentUser;
      db.collection("negotiations")
        .where("productUserId", "==", user.uid)
        .get()
        .then(function(negotiations) {
          negotiations.forEach(nego => {
            var negotiationId = nego.id;
            var buyUserId = nego.data().buyUserId;
            db.collection("negotiations")
              .doc(negotiationId)
              .collection("comments")
              .where("userId", "==", buyUserId)
              .limit(10)
              .orderBy("createTime", "desc")
              .get()
              .then(function(commentResults) {
                commentResults.forEach(comment => {
                  var syuppincommentlist =
                    `
                      <ons-list-item id="syuppinChat_` +
                    syuppinChatCounter +
                    `">
                        <div
                          class="left"
                        >
                          <img id="syuppinChatImage_` +
                    syuppinChatCounter +
                    `"
                            class="list-item__thumbnail"
                            src="img/userSampleImageMan.png"
                            style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                          />
                        </div>
                        <div
                          class="center"
                          style="width:50%;"
                        >
                          <span
                            class="list-item__subtitle light-navy-font"
                            style="height:55px;overflow: hidden;"
                            ><span id="syuppinChatName_` +
                    syuppinChatCounter +
                    `"></span>さんから取引メッセージが届きました。</span
                          >
                        </div>
                        <div class="right">
                          <span id="syuppinChatTime_` +
                    syuppinChatCounter +
                    `" class="list-item__subtitle light-navy-font"></span>
                        </div>
                      </ons-list-item>
                    `;
                  $("#syuppinProductCommentsList").append(syuppincommentlist);
                  syuppinChatIndicate(
                    nego.id,
                    buyUserId,
                    comment.data().createTime,
                    syuppinChatCounter
                  );
                  syuppinChatCounter++;
                });
              })
              .catch(function(error) {
                console.log(error);
              });
          });
        })
        .catch(function(error) {
          console.log(error);
        });
    }

    function syuppinChatIndicate(
      negotiationId,
      buyUserId,
      commentCreateTime,
      syuppinChatCounter
    ) {
      db.collection("users")
        .doc(buyUserId)
        .get()
        .then(function(buyUser) {
          var username = buyUser.data().username;
          //「月」を取得する
          var commentTime = firebaseTimeControl(commentCreateTime);
          $("#syuppinChatName_" + syuppinChatCounter).html(username);
          $("#syuppinChatTime_" + syuppinChatCounter).html(commentTime);
          db.collection("negotiations")
            .doc(negotiationId)
            .get()
            .then(function(negoResult) {
              document.getElementById(
                "syuppinChat_" + syuppinChatCounter
              ).onclick = new Function(
                "torihikiPageJump('" +
                  negoResult.data().productId +
                  "','" +
                  negoResult.data().buyUserId +
                  "','" +
                  negoResult.data().productUserId +
                  "')"
              );
            });

          firebase
            .storage()
            .ref()
            .child("profilePicture/" + buyUserId)
            .getDownloadURL()
            .then(url => {
              document.getElementById(
                "syuppinChatImage_" + syuppinChatCounter
              ).src = url;
            })
            .catch(function() {});
        });
    }
  </script>
</ons-page>
