<ons-page id="chatPage">
  <style>
    #chatPage ons-list-item {
      border-bottom: 1px solid #efeff4;
    }
    #chatPage .list-item__center {
      background-image: none;
    }
  </style>

  <ons-toolbar>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
    >
      取引メッセージ
    </div>
    ns-toolbar>
    <div
      class="right"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content:flex-end;padding-right:5%;"
    >
      <i
        class="fas fa-redo fa-fw"
        style="color:#515c6f;"
        onclick="buyProductComments();syuppinProductComments();showChatLoad();"
      ></i>
    </div>
  </ons-toolbar>
  <div class="mainHeader">
    <ons-carousel
      id="tabChatCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="50%"
      initial-index="0"
      auto-scroll-ratio="0.2"
      style="height:40px;"
    >
      <ons-carousel-item
        class="active_tabCarousel"
        onclick="chatPageTapCarouselChange(0)"
      >
        <div class="item-label" style="line-height: 35px;">
          購入サービス
        </div>
      </ons-carousel-item>
      <ons-carousel-item
        style="line-height: 35px;"
        onclick="chatPageTapCarouselChange(1)"
      >
        <div class="item-label">出品サービス</div>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <div class="content">
    <ons-carousel
      id="chatCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="100%"
      initial-index="0"
      auto-scroll-ratio="0.2"
      reflesh="console.log('Changed to ' + $event.activeIndex)"
    >
      <ons-carousel-item style="min-height: 500px;">
        <ons-list id="buyProductCommentsList" style="background-image: none;">
        </ons-list>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <ons-list
          id="syuppinProductCommentsList"
          style="background-image: none;"
        >
        </ons-list>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <script>
    ("use strict");
    setTimeout(function() {
      var chatCarousel = document.getElementById("chatCarousel");
      chatCarousel.addEventListener("postchange", function(e) {
        // alert(e.activeIndex);
        tabChatCarouselChange(e.activeIndex);
      });
    }, 100);

    function showChatLoad() {
      showLoad();
      setTimeout(function() {
        hideLoad();
      }, 3000);
    }
    function chatPageTapCarouselChange(carouselIndex) {
      $("#tabChatCarousel ons-carousel-item").removeClass("active_tabCarousel");
      $("#tabChatCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
      var chatCarousel = document.getElementById("chatCarousel");
      chatCarousel.setActiveIndex(carouselIndex);
    }
    function tabChatCarouselChange(carouselIndex) {
      $("#tabChatCarousel ons-carousel-item").removeClass("active_tabCarousel");
      $("#tabChatCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
    }
    ons.ready(function() {
      var page = document.getElementById("chatPage");
      var toolbar = page.querySelector(".toolbar");
      var header = page.querySelector(".mainHeader");
      var content = page.querySelector(".content");
      header.style.top = toolbar.clientHeight + "px";
      content.style.marginTop = 40 + "px";
    });

    document.addEventListener(
      "init",
      function(event) {
        if (event.target.matches("#chatPage")) {
          buyProductComments();
          syuppinProductComments();
        }
      },
      false
    );

    function buyProductComments() {
      $("#buyProductCommentsList").empty();
      var torihikiChatCounter = 1;
      var user = firebase.auth().currentUser;
      db.collection("negotiations")
        .where("buyUserId", "==", user.uid)
        .get()
        .then(function(negotiations) {
          negotiations.forEach(nego => {
            var negotiationId = nego.id;
            var productUserId = nego.data().productUserId;
            db.collection("negotiations")
              .doc(negotiationId)
              .collection("comments")
              .where("sendUserId", "==", productUserId)
              .limit(20)
              .orderBy("createTime", "desc")
              .get()
              .then(function(commentResults) {
                commentResults.forEach(comment => {
                  var buycommentlist =
                    `
                      <ons-list-item id="torihikiChat_` +
                    torihikiChatCounter +
                    `">
                        <div
                          class="left"
                        >
                          <img id="torihikiChatImage_` +
                    torihikiChatCounter +
                    `"
                            class="list-item__thumbnail"
                            src="img/userSampleImageMan.png"
                            style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                          />
                        </div>
                        <div
                          class="center"
                          style="padding-right:10px;"
                        >
                          <p
                            class="list-item__subtitle light-navy-font"
                            style="overflow: hidden;margin-bottom:3px;"
                            ><span id="torihikiChatName_` +
                    torihikiChatCounter +
                    `"></span>さんから取引メッセージが届きました。</p
                          >
                          <p id="torihikiChatTime_` +
                    torihikiChatCounter +
                    `" class="list-item__subtitle light-navy-font" style="margin-top:3px;text-align:right;margin-bottom:5px;"></p>
                        </div>
                      </ons-list-item>
                    `;
                  $("#buyProductCommentsList").append(buycommentlist);
                  torihikiChatIndicate(
                    nego.id,
                    productUserId,
                    comment,
                    torihikiChatCounter
                  );
                  torihikiChatCounter++;
                });
              })
              .catch(function(error) {
                console.log(error);
              });
          });
        })
        .catch(function(error) {
          console.log(error);
        });
    }

    function torihikiChatIndicate(
      negotiationId,
      productUserId,
      commentData,
      torihikiChatCounter
    ) {
      db.collection("users")
        .doc(productUserId)
        .get()
        .then(function(productUser) {
          var username = productUser.data().username;
          //「月」を取得する
          var commentTime = jikanCulc(commentData.data().createTime);
          $("#torihikiChatName_" + torihikiChatCounter).html(username);
          $("#torihikiChatTime_" + torihikiChatCounter).html(commentTime);
          if (commentData.data().readStatus == "Unread") {
            $(
              "#torihikiChat_" + torihikiChatCounter + " .list-item__subtitle"
            ).css({
              "font-weight": "bold",
              color: "black"
            });
          }
          db.collection("negotiations")
            .doc(negotiationId)
            .get()
            .then(function(negoResult) {
              $("#torihikiChat_" + torihikiChatCounter).click(function() {
                db.collection("negotiations")
                  .doc(negotiationId)
                  .collection("comments")
                  .doc(commentData.id)
                  .set(
                    {
                      readStatus: "read"
                    },
                    { merge: true }
                  );
                torihikiPageJump(
                  negoResult.data().productId,
                  negoResult.data().buyUserId,
                  negoResult.data().productUserId
                );
                torihikiGet();
                buyProductComments();
              });
            });

          firebase
            .storage()
            .ref()
            .child("profilePicture/" + productUserId)
            .getDownloadURL()
            .then(url => {
              document.getElementById(
                "torihikiChatImage_" + torihikiChatCounter
              ).src = url;
            })
            .catch(function() {
              document.getElementById(
                "torihikiChatImage_" + torihikiChatCounter
              ).src = "img/userSampleImageMan.png";
            });
        });
    }

    function syuppinProductComments() {
      $("#syuppinProductCommentsList").empty();
      var syuppinChatCounter = 1;
      var user = firebase.auth().currentUser;
      db.collection("negotiations")
        .where("productUserId", "==", user.uid)
        .get()
        .then(function(negotiations) {
          negotiations.forEach(nego => {
            var negotiationId = nego.id;
            var buyUserId = nego.data().buyUserId;
            db.collection("negotiations")
              .doc(negotiationId)
              .collection("comments")
              .where("sendUserId", "==", buyUserId)
              .limit(10)
              .orderBy("createTime", "desc")
              .get()
              .then(function(commentResults) {
                commentResults.forEach(comment => {
                  var syuppincommentlist =
                    `
                      <ons-list-item id="syuppinChat_` +
                    syuppinChatCounter +
                    `">
                        <div
                          class="left"
                        >
                          <img id="syuppinChatImage_` +
                    syuppinChatCounter +
                    `"
                            class="list-item__thumbnail"
                            src="img/userSampleImageMan.png"
                            style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                          />
                        </div>
                        <div
                          class="center"
                          style="padding-right:10px;"
                        >
                          <p
                            class="list-item__subtitle light-navy-font"
                            style="overflow: hidden;margin-bottom:3px;"
                            ><span id="syuppinChatName_` +
                    syuppinChatCounter +
                    `"></span>さんから取引メッセージが届きました。</p
                          >
                          <p id="syuppinChatTime_` +
                    syuppinChatCounter +
                    `" class="list-item__subtitle light-navy-font"style="margin-top:3px;text-align:right;margin-bottom:5px;"></p>
                        </div>
                      </ons-list-item>
                    `;
                  $("#syuppinProductCommentsList").append(syuppincommentlist);
                  syuppinChatIndicate(
                    nego.id,
                    buyUserId,
                    comment,
                    syuppinChatCounter
                  );
                  syuppinChatCounter++;
                });
              })
              .catch(function(error) {
                console.log(error);
              });
          });
        })
        .catch(function(error) {
          console.log(error);
        });
    }

    function syuppinChatIndicate(
      negotiationId,
      buyUserId,
      commentData,
      syuppinChatCounter
    ) {
      db.collection("users")
        .doc(buyUserId)
        .get()
        .then(function(buyUser) {
          var username = buyUser.data().username;
          //「月」を取得する
          var commentTime = jikanCulc(commentData.data().createTime);
          $("#syuppinChatName_" + syuppinChatCounter).html(username);
          $("#syuppinChatTime_" + syuppinChatCounter).html(commentTime);
          if (commentData.data().readStatus == "Unread") {
            $(
              "#syuppinChat_" + syuppinChatCounter + " .list-item__subtitle"
            ).css({
              "font-weight": "bold",
              color: "black"
            });
          }
          db.collection("negotiations")
            .doc(negotiationId)
            .get()
            .then(function(negoResult) {
              $("#syuppinChat_" + syuppinChatCounter).click(function() {
                db.collection("negotiations")
                  .doc(negotiationId)
                  .collection("comments")
                  .doc(commentData.id)
                  .set(
                    {
                      readStatus: "read"
                    },
                    { merge: true }
                  );
                torihikiPageJump(
                  negoResult.data().productId,
                  negoResult.data().buyUserId,
                  negoResult.data().productUserId
                );
                torihikiGet();
                syuppinProductComments();
              });
            });

          firebase
            .storage()
            .ref()
            .child("profilePicture/" + buyUserId)
            .getDownloadURL()
            .then(url => {
              document.getElementById(
                "syuppinChatImage_" + syuppinChatCounter
              ).src = url;
            })
            .catch(function() {});
        });
    }
  </script>
</ons-page>
