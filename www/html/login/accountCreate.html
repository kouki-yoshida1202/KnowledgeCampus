<ons-page id="accountCreate">
  <ons-toolbar>
    <div class="left">
      <ons-back-button> </ons-back-button>
    </div>
    <div class="center">新規登録</div>
  </ons-toolbar>

  <ons-list style="padding-top:11px;">
    <ons-list-item>
      <ons-row>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: left;padding:0px 3%;"
        >
          ユーザーネーム
        </ons-col>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: right;"
        >
          <div class="cp_iptxt">
            <input
              type="text"
              placeholder="表示名を入力してください"
              id="newUserName"
            />
            <i class="fas fa-user fa-lg fa-fw" aria-hidden="true"></i>
          </div>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: left;padding:0px 3%;"
        >
          メールアドレス
        </ons-col>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: right;"
        >
          <div class="cp_iptxt">
            <input
              type="email"
              placeholder="メールアドレスを入力してください"
              id="newMailAddress"
            />
            <i class="fas fa-envelope fa-lg fa-fw" aria-hidden="true"></i>
          </div>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: left;padding:0px 3%;"
        >
          パスワード
        </ons-col>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: right;"
        >
          <div class="cp_iptxt">
            <input type="password" placeholder="6文字以上" id="newPassword" />
            <i class="fas fa-unlock-alt fa-lg fa-fw" aria-hidden="true"></i>
          </div>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: left;padding:0px 3%;"
        >
          パスワード再確認
        </ons-col>
        <ons-col
          vertical-align="center"
          width="100%"
          style="text-align: right;"
        >
          <div class="cp_iptxt">
            <input
              type="password"
              placeholder="確認のため再度"
              id="newPasswordCheck"
            />
            <i class="fas fa-unlock-alt fa-lg fa-fw" aria-hidden="true"></i>
          </div>
        </ons-col>
      </ons-row>
    </ons-list-item>
  </ons-list>
  <div style="width:90%;margin:0 auto;">
    <p style="font-size:0.8em;padding:0.5em;">
      「新規登録」のボタンを押すことで、<span
        style="color:#0799d7;"
        id="riyouKiyaku"
        onclick='cordova.InAppBrowser.open("https://knowledgecampus-test.web.app/riyouKiyaku.html", "_blank", "location=yes");'
        >利用規約</span
      >および
      <span style="color:#0799d7;" id="privacyPolicy" onclick=""
        >プライバシーポリシー</span
      >に同意したものと判断します。
    </p>
  </div>
  <div class="cp_iptxt" style="margin-top:20px;margin-bottom:50px;">
    <ons-button
      class="button--large--cta"
      style="margin: 0 auto;border-radius: 10px;padding:0.5em;background-color:#ff9831;width:90%"
      ripple
      onclick="newUserCreate()"
    >
      新規登録
    </ons-button>
  </div>
  <script>
    var successCallback = function() {
      //端末登録後の処理
      alert("成功");
    };
    var errorCallback = function(err) {
      //端末登録でエラーが発生した場合の処理
      alert(err);
    };

    firebase
      .storage()
      .ref()
      .child("riyoukiyaku.pdf")
      .getDownloadURL()
      .then(url => {
        document.getElementById("riyouKiyaku").onclick = new Function(
          'cordova.InAppBrowser.open("' + url + '", "_blank", "location=yes");'
        );
      });

    firebase
      .storage()
      .ref()
      .child("privacypolicy.pdf")
      .getDownloadURL()
      .then(url => {
        document.getElementById("privacyPolicy").onclick = new Function(
          'cordova.InAppBrowser.open("' + url + '", "_blank", "location=yes");'
        );
      });

    function newUserCreate() {
      var userName = $("#newUserName").val();
      var mailAddress = $("#newMailAddress").val();
      var password = $("#newPassword").val();
      var passwordCheck = $("#newPasswordCheck").val();
      if (userName == "") {
        ons.notification.alert({
          message: "ユーザーネームが未入力です"
        });
      } else if (mailAddress == "") {
        ons.notification.alert({
          message: "メールアドレスが未入力です"
        });
      } else if (password == "") {
        ons.notification.alert({
          message: "パスワードが未入力です。"
        });
      } else if (password.length < 6) {
        ons.notification.alert({
          message: "パスワードは6文字以上でお願いします"
        });
      } else if (password != passwordCheck) {
        ons.notification.alert({
          message: "再確認パスワードが異なります。"
        });
      } else {
        showLoad();
        var mailcheck = MailCheck(mailAddress);
        if (mailcheck) {
          firebase
            .auth()
            .createUserWithEmailAndPassword(mailAddress, password)
            .then(function() {
              var user = firebase.auth().currentUser;
              user
                .sendEmailVerification()
                .then(function() {
                  // Email sent.
                  db.collection("users")
                    .doc(user.uid)
                    .set(
                      {
                        username: userName,
                        point: 0,
                        text: "",
                        ginkoukind: "",
                        ginkoumeigi: "",
                        ginkouname: "",
                        ginkounumber: "",
                        ginkoushiten: "",
                        invitecode: "",
                        uriagenow: 0,
                        invitedcode: ""
                      },
                      { merge: true }
                    )
                    .then(function() {
                      ons.notification.alert({
                        title: "メール送信",
                        message:
                          "認証メールを送信しました。メールに記載のURLを押下することで登録が完了します。"
                      });
                      hideLoad();
                    })
                    .catch(function(error) {
                      // An error happened.
                      console.log(error);
                      hideLoad();
                    });
                })
                .catch(function(error) {
                  // An error happened.
                  console.log(error);
                  hideLoad();
                });
            })
            .catch(function(error) {
              // Handle Errors here.
              var errorCode = error.code;
              var errorMessage = error.message;
              ons.notification.alert({
                title: "登録失敗",
                message:
                  "アカウント登録に失敗しました。既にメールアドレスが使用されている可能性があります。"
              });
              hideLoad();
            });
        } else {
          ons.notification.alert({
            title: "登録失敗",
            message: "メールアドレスの形式が正しくありません。"
          });
          hideLoad();
        }
      }
    }
  </script>
</ons-page>
