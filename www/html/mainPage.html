<ons-page id="mainPage">
  <style>
    #mainPage .toolbar__left,
    #mainPage .toolbar__right {
      width: 15%;
    }

    #mainPage .toolbar {
      background-image: none;
    }

    #mainPage .toolbar__center {
      width: 70%;
    }
    #tabCarousel .item-label,
    #tabChatCarousel .item-label,
    #tabMySyuppinCarousel .item-label,
    #tabMyBoughtCarousel .item-label {
      text-align: center;
      font-size: 0.8em;
      padding: 3px;
    }

    .active_tabCarousel {
      color: #0799d7;
      border-bottom: 3px solid #0799d7;
      font-weight: bold;
    }

    .user_icon_mainPage {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    #mainPage .toolbar {
      background: white !important;
    }

    .fa-star,
    .reviewAverage {
      color: #ffd43b;
    }

    #mainCarousel p {
      margin-top: 3px;
      margin-bottom: 3px;
    }
    #mainCarousel ons-col {
      padding: 5px 7px;
    }

    .mainPageItemText {
      padding: 5px 7px;
      text-align: left;
      font-size: 0.8em;
      width: 100%;
    }

    .salaly {
      float: left;
      padding-left: 5px;
      line-height: 24px;
      font-size: 0.8em;
    }

    .howto {
      float: right;
      padding-right: 5px;
      font-size: 0.8em;
      line-height: 24px;
    }

    .mainHeader {
      position: absolute;
      margin: 0;
      padding: 0;
      border: 0;
      top: 0px;
      left: 0;
      width: 100%;
      z-index: 2;
      background-color: white;
    }

    .mainUserName {
      font-size: 0.9em;
    }

    #mainPage ons-card {
      text-align: center;
      padding: 7px;
      margin: 0px;
      height: 190px;
      padding-top: 15px;
      padding-bottom: 10px;
    }
    #mainPage .mainReview {
      font-size: 0.8em;
    }
  </style>
  <ons-toolbar>
    <div
      class="left"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
      onclick="window.location.href = 'index.html';"
    >
      <img
        src="img/knowledgeLogo.png"
        alt=""
        style="height:30px;width:30px;margin:0 auto;"
      />
    </div>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
      onclick="myNavigator.bringPageTop('html/top/searchBefore.html');"
    >
      <ons-search-input
        style="width:100%;display:flex;align-items: center;justify-content: center;"
        readonly
      ></ons-search-input>
    </div>
    <div
      class="right"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
      onclick="myNavigator.bringPageTop('html/top/notificationPage.html');"
    >
      <i class="far fa-bell fa-lg fa-fw"></i>
    </div>
  </ons-toolbar>

  <div class="mainHeader">
    <ons-carousel
      id="tabCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="20%"
      initial-index="2"
      style="height:28px;border-bottom:1px solid #f0f0f0;"
    >
      <ons-carousel-item>
        <div class="item-label">キャリア</div>
      </ons-carousel-item>
      <ons-carousel-item>
        <div class="item-label">学業</div>
      </ons-carousel-item>
      <ons-carousel-item class="active_tabCarousel">
        <div class="item-label">全て</div>
      </ons-carousel-item>
      <ons-carousel-item>
        <div class="item-label">ランキング</div>
      </ons-carousel-item>
      <ons-carousel-item>
        <div class="item-label">ビジネス</div>
      </ons-carousel-item>
    </ons-carousel>
  </div>

  <div class="content page__content">
    <ons-pull-hook id="pull-hook" style="margin-top:28px;" height="100px">
      <i class="fas fa-spinner" style="font-size:1.3em;"></i>
    </ons-pull-hook>
    <ons-carousel
      id="mainCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="100%"
      initial-index="2"
      reflesh="console.log('Changed to ' + $event.activeIndex)"
    >
      <ons-carousel-item>
        <div
          class="item-label"
          id="careerProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;"
        ></div>
      </ons-carousel-item>
      <ons-carousel-item>
        <div
          class="item-label"
          id="studyProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;"
        ></div>
      </ons-carousel-item>
      <ons-carousel-item>
        <div
          id="allProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;"
        ></div>
      </ons-carousel-item>
      <ons-carousel-item>
        <div class="item-label" style="padding:0.5rem;">
          <ons-row>
            <h4 style="padding-left:0.5rem;font-weight: bold;">
              全てのカテゴリー
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            overscrollable
            item-width="150px"
            id="carousel"
            style="padding-right:50px;"
          >
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#ffd43b;"></i>
                </div>
              </div>
            </ons-carousel-item>
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#AEB3B5;"></i>
                </div>
              </div>
            </ons-carousel-item>
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#BA6E40;"></i>
                </div>
              </div>
            </ons-carousel-item>
          </ons-carousel>
          <ons-row>
            <h4
              style="padding-left:0.5rem;font-weight: bold;margin-top:1.0rem;"
            >
              学業
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            overscrollable
            item-width="150px"
            id="carousel"
            style="padding-right:50px;"
          >
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#ffd43b;"></i>
                </div>
              </div>
            </ons-carousel-item>
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#AEB3B5;"></i>
                </div>
              </div>
            </ons-carousel-item>
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#BA6E40;"></i>
                </div>
              </div>
            </ons-carousel-item>
          </ons-carousel>
          <ons-row>
            <h4 style="padding-left:0.5rem;font-weight: bold;margin-top:1rem;">
              ビジネス
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            overscrollable
            item-width="150px"
            id="carousel"
            style="padding-right:50px;"
          >
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#ffd43b;"></i>
                </div>
              </div>
            </ons-carousel-item>
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#AEB3B5;"></i>
                </div>
              </div>
            </ons-carousel-item>
            <ons-carousel-item style="margin:5px;">
              <div
                vertical-align="center"
                width="50%"
                style="text-align: center;height:170px;position: relative;"
              >
                <img
                  class="user_icon_mainPage"
                  src="img/manSample.jpeg"
                  alt=""
                />
                <p class="mainUserName">田中太郎</p>
                <p>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                  <i class="far fa-star"></i>
                  <!-- <span class="reviewAverage">3.0</span> -->
                  <span>(10)</span>
                </p>
                <p class="mainPageItemText">就活の必勝法教えます！</p>
                <p>
                  <span class="salaly">
                    ¥3000/30分
                  </span>
                  <span class="howto">
                    zoom
                  </span>
                </p>
                <div
                  style="position: absolute;top:0px;left:0px;color:white;font-weight: bold;"
                >
                  <i class="fas fa-crown fa-lg" style="color:#BA6E40;"></i>
                </div>
              </div>
            </ons-carousel-item>
          </ons-carousel>
        </div>
      </ons-carousel-item>
      <ons-carousel-item>
        <div
          class="item-label"
          id="businessProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;"
        ></div>
      </ons-carousel-item>
    </ons-carousel>
  </div>

  <script>
    ons.ready(function() {
      var pullHook = document.getElementById("pull-hook");
      pullHook.onAction = function(done) {
        productGet("selfReload", done);
      };
      pullHook.addEventListener("changestate", function(event) {
        var message = "";

        switch (event.state) {
          case "initial":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "preaction":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "action":
            message =
              '<i class="fas fa-spinner fa-spin" style="font-size:1.3em;"></i>';
            break;
        }

        pullHook.innerHTML = message;
      });
    });

    ("use strict");
    setTimeout(function(){
      productGet();
      var mainCarousel = document.getElementById("mainCarousel");
      mainCarousel.addEventListener("postchange", function (e) {
        // alert(e.activeIndex);
        tabCarouselChange(e.activeIndex);
      });
    },100);

    function tabCarouselChange(carouselIndex) {
      var test = $("#tabCarousel ons-carousel-item").width();
      $("#tabCarousel ons-carousel-item").removeClass("active_tabCarousel");
      $("#tabCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
    }

    ons.ready(function() {
      var page = document.getElementById("mainPage");
      var toolbar = page.querySelector(".toolbar");
      var header = page.querySelector(".mainHeader");
      var content = page.querySelector(".content");
      header.style.top = toolbar.clientHeight + "px";
      content.style.marginTop = 28 + "px";
    });

    function productGet(selfReload, done) {
      if (selfReload != "selfReload") {
        showLoad();
      }
      $("#allProduct").empty();
      $("#careerProduct").empty();
      $("#studyProduct").empty();
      $("#businessProduct").empty();
      var nowDataCount = 0;
      var products = db.collection("products");
      products
        .where("releasestatus", "==", "syuppin")
        .orderBy("createTime", "desc")
        .get()
        .then(results => {
          // console.log(results.size);
          if (results.size > 0) {
            results.forEach(doc => {
              nowDataCount++;
              productIndicate(
                doc.id,
                doc.data(),
                nowDataCount,
                results.size,
                selfReload,
                done
              );
            });
          } else {
            hideLoad();
          }
        })
        .catch(error => {
          console.log(`データの取得に失敗しました (${error})`);
          hideLoad();
        });
    }

    function productIndicate(
      docId,
      data,
      nowDataCount,
      size,
      selfReload,
      done
    ) {
      var userId = data.userId;
      var docRef = db.collection("users").doc(userId);
      docRef
        .get()
        .then(function(doc) {
          if (doc.exists) {
            var url = "";
            var user = firebase.auth().currentUser;
            var username = doc.data().username;
            ref = firebase
              .storage()
              .ref()
              .child("profilePicture/" + data.userId);
            ref
              .getDownloadURL()
              .then(url => {
                if (url == "") {
                  url = "img / userSampleImageMan.png";
                }
                return url;
              })
              .then(function(url) {
                var product =
                  `
              <div style="text-align: center;width:47.5%;padding:0.25em;">
                <ons-card class="mainCard" onclick="giftDetailJump('` +
                  docId +
                  `')">
                  <img class="user_icon_mainPage" src="` +
                  url +
                  `" alt="" />
                  <p class="mainUserName">` +
                  username +
                  `</p>
                  <p class="mainReview">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="far fa-star"></i>
                    <i class="far fa-star"></i>
                    <!-- <span class="reviewAverage">3.0</span> -->
                    <span>(10)</span>
                  </p>
                  <div style="display: flex;justify-content: center;align-items: center;height:38px;border: 1px solid;border-radius: 10px;">
                  <p class="mainPageItemText">` +
                  data.title +
                  `</p></div>
                  <p>
                    <span class="salaly">
                      ¥` +
                  data.price +
                  `/` +
                  data.time +
                  `
                    </span>
                    <span class="howto">
                      ` +
                  data.howtotalk +
                  `
                    </span>
                  </p>
                </ons-card>
              </div>
            `;

                $("#allProduct").append(product);
                if (data.category1 == "キャリア") {
                  $("#careerProduct").append(product);
                } else if (data.category1 == "学業") {
                  $("#studyProduct").append(product);
                } else if (data.category1 == "ビジネス") {
                  $("#businessProduct").append(product);
                }
                if (nowDataCount == size) {
                  if (selfReload != "selfReload") {
                    hideLoad();
                  } else {
                    done();
                  }
                }
              });
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
        });
    }

    function giftDetailJump(docId) {
      console.log(docId);
      myNavigator.bringPageTop("html/product/productDetail.html");
      setTimeout(function() {
        console.log("aiu");
        // ons.notification.alert("ページ1が初期化されました");
        productInfo(docId);
      }, 100);
    }
  </script>
</ons-page>
