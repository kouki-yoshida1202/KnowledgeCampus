<ons-page id="mainPage">
  <style>
    #mainPage .toolbar__left,
    #mainPage .toolbar__right {
      width: 15%;
    }

    #mainPage .toolbar {
      background-image: none;
    }

    #mainPage .toolbar__center {
      width: 70%;
    }
    #tabCarousel .item-label,
    #tabChatCarousel .item-label,
    #tabMySyuppinCarousel .item-label,
    #tabMyBoughtCarousel .item-label {
      text-align: center;
      font-size: 0.8em;
      padding: 3px;
    }

    .active_tabCarousel {
      color: #ff9831;
      border-bottom: 3px solid #ff9831;
      font-weight: bold;
    }

    .user_icon_mainPage {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    #mainPage .toolbar {
      background: white !important;
    }
    .fa-star,
    .reviewAverage {
      color: #ffd43b;
    }

    #mainCarousel p {
      margin-top: 3px;
      margin-bottom: 3px;
    }

    .mainPageItemText {
      padding: 5px 7px;
      text-align: left;
      font-size: 0.8em;
      width: 100%;
    }

    .salaly {
      float: left;
      padding: 0px;
      padding-left: 3px;
      line-height: 24px;
      font-size: 0.7em;
    }

    .howto {
      float: right;
      padding: 0px;
      padding-right: 3px;
      font-size: 0.7em;
      line-height: 24px;
    }
    .productTime {
      width: 100%;
      text-align: right;
      padding-right: 3px;
      font-size: 0.7em;
      line-height: 20px;
      margin-top: 0px;
      margin-bottom: 0px;
    }

    .mainHeader {
      position: absolute;
      margin: 0;
      padding: 0;
      border: 0;
      top: 0px;
      left: 0;
      width: 100%;
      z-index: 2;
      background-color: white;
    }
    #mainPage > .mainHeader {
      background-color: transparent;
    }

    .mainUserName {
      font-size: 0.9em;
      line-height: 22px;
    }

    #mainPage ons-card {
      text-align: center;
      padding: 0px;
      margin: 0px;
      height: 240px;
    }
    #mainPage .mainReview {
      font-size: 0.8em;
      display: flex;
      justify-content: center;
    }

    #tabCarousel > .ons-swiper-target {
      justify-content: space-between;
    }

    .card-box {
      padding: 7px;
    }
  </style>
  <ons-toolbar>
    <div
      class="left"
      id="toolbar-title"
      style="width:5%;"
      onclick="window.location.href = 'index.html';"
    >
      <!-- <img
        src="img/appstore.png"
        alt=""
        style="height:30px;width:30px;margin:0 auto;"
      /> -->
    </div>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;width:90%;"
      onclick="myNavigator.bringPageTop('html/top/searchBefore.html');"
    >
      <ons-search-input
        style="width:100%;display:flex;align-items: center;justify-content: center;"
        readonly
      ></ons-search-input>
    </div>
    <div
      class="right"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;position: relative;"
      onclick="myNavigator.bringPageTop('html/top/notificationPage.html');"
    >
      <i class="far fa-bell fa-lg fa-fw"></i>
      <span
        id="mainPushBadge"
        class="notification badgeToolbar"
        style="position: absolute;top: 5px;right: 10px;font-size:0.8em;"
        >0</span
      >
    </div>
  </ons-toolbar>

  <div class="mainHeader">
    <ons-carousel
      id="tabCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="16%"
      centerd
      initial-index="2"
      style="height:33px;border-bottom:1px solid #f0f0f0;padding-top:5px;font-size:0.8em;background-color: white;"
    >
      <ons-carousel-item
        class="active_tabCarousel"
        id="carousel1"
        onclick="mainTapCarouselChange(0)"
      >
        <div class="item-label">全て</div>
      </ons-carousel-item>
      <ons-carousel-item id="carousel2" onclick="mainTapCarouselChange(1)">
        <div class="item-label">学業</div>
      </ons-carousel-item>
      <ons-carousel-item id="carousel3" onclick="mainTapCarouselChange(2)">
        <div class="item-label">キャリア</div>
      </ons-carousel-item>
      <ons-carousel-item id="carousel4" onclick="mainTapCarouselChange(3)">
        <div class="item-label">ビジネス</div>
      </ons-carousel-item>
      <ons-carousel-item id="carousel5" onclick="mainTapCarouselChange(4)">
        <div class="item-label">生活</div>
      </ons-carousel-item>
      <ons-carousel-item id="carousel6" onclick="mainTapCarouselChange(5)">
        <div class="item-label">ランキング</div>
      </ons-carousel-item>
    </ons-carousel>
    <img src="img/campain.jpg" alt="" style="width:100%;height:auto;" />
  </div>

  <div class="content page__content">
    <ons-pull-hook id="pull-hook" style="margin-top:100px;" height="105px">
      <i class="fas fa-spinner" style="font-size:1.3em;"></i>
    </ons-pull-hook>
    <ons-carousel
      id="mainCarousel"
      swipeable
      overscrollable
      auto-scroll
      auto-refresh
      var="carousel"
      item-width="100%"
      initial-index="0"
      auto-scroll-ratio="0.2"
      reflesh="console.log('Changed to ' + $event.activeIndex)"
    >
      <ons-carousel-item style="min-height: 500px;">
        <div
          id="allProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;padding-right:3%;padding-left:3%;"
        ></div>
      </ons-carousel-item>

      <ons-carousel-item style="min-height: 500px;">
        <div
          class="item-label"
          id="studyProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;padding-right:3%;padding-left:3%;"
        ></div>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <div
          class="item-label"
          id="careerProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;padding-right:3%;padding-left:3%;"
        ></div>
      </ons-carousel-item>

      <ons-carousel-item style="min-height: 500px;">
        <div
          class="item-label"
          id="businessProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;padding-right:3%;padding-left:3%;"
        ></div>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <div
          class="item-label"
          id="lifeProduct"
          class="item-label"
          style="display: flex;justify-content: space-between;flex-wrap: wrap;padding-right:3%;padding-left:3%;"
        ></div>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <div class="item-label" style="padding:0.5rem;">
          <ons-row>
            <h4 style="padding-left:0.5rem;font-weight: bold;">
              全てのカテゴリー
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            item-width="160px"
            id="allCategoryCarousel"
            style="padding-right:50px;"
          >
          </ons-carousel>
          <ons-row>
            <h4
              style="padding-left:0.5rem;font-weight: bold;margin-top:1.0rem;"
            >
              学業
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            item-width="160px"
            id="studyCategoryCarousel"
            style="padding-right:50px;"
          >
          </ons-carousel>
          <ons-row>
            <h4 style="padding-left:0.5rem;font-weight: bold;margin-top:1rem;">
              ビジネス
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            item-width="160px"
            id="businessCategoryCarousel"
            style="padding-right:50px;"
          >
          </ons-carousel>
          <ons-row>
            <h4
              style="padding-left:0.5rem;font-weight: bold;margin-top:1.0rem;"
            >
              キャリア
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            item-width="160px"
            id="careerCategoryCarousel"
            style="padding-right:50px;"
          >
          </ons-carousel>
          <ons-row>
            <h4
              style="padding-left:0.5rem;font-weight: bold;margin-top:1.0rem;"
            >
              生活
            </h4>
          </ons-row>
          <ons-carousel
            auto-refresh
            swipeable
            item-width="160px"
            id="lifeCategoryCarousel"
            style="padding-right:50px;"
          >
          </ons-carousel>
        </div>
      </ons-carousel-item>
    </ons-carousel>
  </div>

  <script>
    for (var i = 0; i < 15; i++) {
      if (i == 0 || i == 3 || i == 6 || i == 9 || i == 12) {
        var color = "#ffd43b";
      } else if (i == 1 || i == 4 || i == 7 || i == 10 || i == 13) {
        var color = "#AEB3B5";
      } else {
        var color = "#BA6E40";
      }
      var content =
        `
                <ons-carousel-item id="rankingCard_` +
        i +
        `"style="margin:5px;">
                  <ons-card
                    vertical-align="center"
                    width="50%"
                    style="text-align: center;height:240px;position: relative;"
                  >
                  <ons-row class="rankingProductCategory_` +
        i +
        `" style="font-size:0.6em;border-radius:8px 8px 0px 0px;">
                </ons-row>
                <div class="card-box">
                  <ons-row >
                    <ons-col id="rankingProductTime_` +
        i +
        `"class="productTime"></ons-col>
                  </ons-row>
                    <img
                      id="rankingImage_` +
        i +
        `"
                      class="user_icon_mainPage"
                      src="img/userSampleImageMan.png"
                      alt=""
                    />
                    <p id="rankingUserName_` +
        i +
        `"class="mainUserName"></p>
                    <p id="rankingReview_` +
        i +
        `"class="mainReview">
                      <img
                        src="img/starOff.png"
                        alt=""
                        style="height:14px;margin-right:3px;"
                      />
                      <img
                        src="img/starOff.png"
                        alt=""
                        style="height:14px;margin-right:3px;"
                      />
                      <img
                        src="img/starOff.png"
                        alt=""
                        style="height:14px;margin-right:3px;"
                      />
                      <img
                        src="img/starOff.png"
                        alt=""
                        style="height:14px;margin-right:3px;"
                      />
                      <img
                        src="img/starOff.png"
                        alt=""
                        style="height:14px;margin-right:3px;"
                      />
                      (0)
                    </p>
                    <div
                      style="display: flex;justify-content: center;align-items: center;height:57px;margin-top:7px;margin-bottom:7px;"
                    >
                    <div class="round-cap-left"></div>
                      <p id="rankingText_` +
        i +
        `"class="mainPageItemText"></p>
                    </div>
                    <ons-row style="width:100%;line-height:24px;">
                    <ons-col id="rankingSalalyTime_` +
        i +
        `"class="salaly" style="text-align:left;"></ons-col>
                    <ons-col id="rankingHowTo_` +
        i +
        `"class="howto"style="text-align:right;"></ons-col>
                  </ons-row>
                    <div
                      style="position: absolute;top:35px;left:40px;color:white;font-weight: bold;"
                    >
                      <i class="fas fa-crown fa-lg" style="color:` +
        color +
        `";></i>
                    </div>
                    </div>
                  </ons-card>
                </ons-carousel-item>
                `;
      if (i < 3) {
        $("#allCategoryCarousel").append(content);
      } else if (i > 2 && i < 6) {
        $("#studyCategoryCarousel").append(content);
      } else if (5 < i && i < 9) {
        $("#businessCategoryCarousel").append(content);
      } else if (8 < i && i < 12) {
        $("#careerCategoryCarousel").append(content);
      } else if (11 < i) {
        $("#lifeCategoryCarousel").append(content);
      }
    }
    var rankingIndicateCount = 0;
    ons.ready(function() {
      var pullHook = document.getElementById("pull-hook");
      pullHook.onAction = function(done) {
        productGet("selfReload", done);
      };
      pullHook.addEventListener("changestate", function(event) {
        var message = "";

        switch (event.state) {
          case "initial":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "preaction":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "action":
            message =
              '<i class="fas fa-spinner fa-spin" style="font-size:1.3em;"></i>';
            break;
        }

        pullHook.innerHTML = message;
      });
    });
    ("use strict");
    setTimeout(function() {
      productGet();
      rankingIndicate();
      notificationGet();
      // torihikiGet();
      var mainCarousel = document.getElementById("mainCarousel");
      mainCarousel.addEventListener("postchange", function(e) {
        // alert(e.activeIndex);
        tabCarouselChange(e.activeIndex);
      });
    }, 100);

    function tabCarouselChange(carouselIndex) {
      $("#tabCarousel ons-carousel-item").removeClass("active_tabCarousel");
      $("#tabCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
      var height = $("#mainCarousel ons-carousel-item")
        .eq(carouselIndex)
        .children()
        .height();
      $("#mainCarousel ons-carousel-item")
        .eq(carouselIndex)
        .height(height);
      var mainHeight = $("#mainCarousel ons-carousel-item")
        .eq(carouselIndex)
        .height();
      $("#mainCarousel").height(mainHeight);

      // if (carouselIndex == 5) {
      //   if (rankingIndicateCount == 0) {
      //     rankingIndicate();
      //   }
      //   rankingIndicateCount++;
      // }
      let element = document.getElementById("mainCarousel");
      // 一番下にスクロールさせる
      element.parentElement.scrollTop = 0;
    }
    function mainTapCarouselChange(carouselIndex) {
      $("#tabCarousel ons-carousel-item").removeClass("active_tabCarousel");
      $("#tabCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
      var mainCarousel = document.getElementById("mainCarousel");
      mainCarousel.setActiveIndex(carouselIndex);
      // if (carouselIndex == 5) {
      //   if (rankingIndicateCount == 0) {
      //     rankingIndicate();
      //   }
      //   rankingIndicateCount++;
      // }
    }

    ons.ready(function() {
      $("#mainPushBadge").hide();
      var page = document.getElementById("mainPage");
      var toolbar = page.querySelector(".toolbar");
      var header = page.querySelector(".mainHeader");
      var content = page.querySelector(".content");
      header.style.top = toolbar.clientHeight + "px";
      content.style.marginTop = 33 + "px";
    });
    function rankingIndicate() {
      showLoad();
      var negotiations = db.collection("negotiations");
      negotiations.get().then(function(negotiation) {
        if (negotiation.size > 0) {
          rankingForEachPromise(negotiation)
            .then(function(rankingArray) {
              return rankingArray;
            })
            .then(function(rankingArray) {
              rankingArray.sort(function(a, b) {
                if (a.count > b.count) {
                  return -1;
                } else {
                  return 1;
                }
              });
              return rankingArray;
            })
            .then(function(rankingArray) {
              var businessRankingArray = rankingArray.filter(
                item => item.category1 == "ビジネス"
              );

              var studyRankingArray = rankingArray.filter(
                item => item.category1 == "学業"
              );

              var careerRankingArray = rankingArray.filter(
                item => item.category1 == "キャリア"
              );
              var lifeRankingArray = rankingArray.filter(
                item => item.category1 == "生活"
              );

              rankingBorn(rankingArray, "All");
              rankingBorn(businessRankingArray, "business");
              rankingBorn(careerRankingArray, "career");
              rankingBorn(studyRankingArray, "study");
              rankingBorn(lifeRankingArray, "life");
            })
            .catch(function(error) {
              console.log(error);
            });
        } else {
          $("#allCategoryCarousel").empty();
          $("#studyCategoryCarousel").empty();
          $("#businessCategoryCarousel").empty();
          $("#careerCategoryCarousel").empty();
          $("#lifeCategoryCarousel").empty();
          hideLoad();
        }
      });
    }

    function rankingBorn(rankingArray, category) {
      if (category == "All") {
        var rankingArrayCount = 0;
        if (rankingArray.length < 3) {
          var deleteCount = 0 + rankingArray.length;
          for (deleteCount; deleteCount < 3; deleteCount++) {
            $("#rankingCard_" + deleteCount).remove();
          }
        }
      } else if (category == "study") {
        var rankingArrayCount = 3;
        if (rankingArray.length < 3) {
          var deleteCount = 3 + rankingArray.length;
          for (deleteCount; deleteCount < 6; deleteCount++) {
            $("#rankingCard_" + deleteCount).remove();
          }
        }
      } else if (category == "business") {
        var rankingArrayCount = 6;
        if (rankingArray.length < 3) {
          var deleteCount = 6 + rankingArray.length;
          for (deleteCount; deleteCount < 9; deleteCount++) {
            $("#rankingCard_" + deleteCount).remove();
          }
        }
      } else if (category == "career") {
        var rankingArrayCount = 9;
        if (rankingArray.length < 3) {
          var deleteCount = 9 + rankingArray.length;
          for (deleteCount; deleteCount < 12; deleteCount++) {
            $("#rankingCard_" + deleteCount).remove();
          }
        }
      } else if (category == "life") {
        var rankingArrayCount = 12;
        if (rankingArray.length < 3) {
          var deleteCount = 12 + rankingArray.length;
          for (deleteCount; deleteCount < 15; deleteCount++) {
            $("#rankingCard_" + deleteCount).remove();
          }
        }
      }

      rankingArray.forEach(function(rank) {
        if (rankingArrayCount < rankingArrayCount + 3) {
          db.collection("products")
            .doc(rank.productId)
            .get()
            .then(function(productInfo) {
              var userId = productInfo.data().userId;
              var howto = productInfo.data().howtotalk;
              var price = productInfo.data().price;
              var time = productInfo.data().time;
              var title = productInfo.data().title;
              var createTime = productInfo.data().createTime;
              var category1 = productInfo.data().category1;
              var category2 = productInfo.data().category2;
              var category3 = productInfo.data().category3;
              var productArray = [
                userId,
                howto,
                price,
                time,
                title,
                rankingArrayCount,
                rank.productId,
                createTime,
                category1,
                category2,
                category3
              ];
              rankingArrayCount++;
              return productArray;
            })
            .then(function(productArray) {
              var userId = productArray[0];
              var howto = productArray[1];
              var price = productArray[2];
              var time = productArray[3];
              var title = productArray[4];
              var rankingArrayCount = productArray[5];
              var productId = productArray[6];
              var createTime = productArray[7];
              var category1 = productArray[8];
              var category2 = productArray[9];
              var category3 = productArray[10];
              db.collection("users")
                .doc(userId)
                .get()
                .then(function(userInfo) {
                  var username = userInfo.data().username;
                  firebase
                    .storage()
                    .ref()
                    .child("profilePicture/" + userId)
                    .getDownloadURL()
                    .then(url => {
                      return url;
                    })
                    .catch(function(error) {
                      // 画像取得できないとき
                      url = "img/userSampleImageMan.png";
                      return url;
                    })
                    .then(function(url) {
                      // document.getElementById(
                      //   "rankingCard_" + rankingArrayCount
                      // ).onclick = new Function(
                      //   "giftDetailJump('" + productId + "')"
                      // );
                      if (category3 != "") {
                        $(".rankingProductCategory_" + rankingArrayCount)
                          .empty()
                          .append(
                            "<ons-col style='background:#ff969f;border-radius:8px 0px 0px 0px;color:white;font-weight:bold;'>" +
                              category1 +
                              "</ons-col><ons-col style='background:#96d4ff;color:white;font-weight:bold;'>" +
                              category2 +
                              "</ons-col><ons-col style='background:#4DB56A;border-radius:0px 8px 0px 0px;color:white;font-weight:bold;'>" +
                              category3 +
                              "</ons-col>"
                          );
                      } else {
                        $(".rankingProductCategory_" + rankingArrayCount)
                          .empty()
                          .append(
                            "<ons-col style='background:#ff969f;border-radius:8px 0px 0px 0px;color:white;font-weight:bold;'>" +
                              category1 +
                              "</ons-col><ons-col style='background:#96d4ff;border-radius:0px 8px 0px 0px;color:white;font-weight:bold;'>" +
                              category2 +
                              "</ons-col>"
                          );
                      }
                      $("#rankingCard_" + rankingArrayCount).click(function() {
                        giftDetailJump(productId);
                      });
                      $("#rankingImage_" + rankingArrayCount).attr("src", url);
                      $("#rankingUserName_" + rankingArrayCount).html(username);
                      $("#rankingText_" + rankingArrayCount).html(title);
                      $("#rankingSalalyTime_" + rankingArrayCount).html(
                        "¥" + price + "/" + time
                      );

                      $("#rankingHowTo_" + rankingArrayCount).html(howto);
                      $("#rankingProductTime_" + rankingArrayCount).html(
                        jikanCulc2(createTime)
                      );
                      reviewControl(userId).then(function(result) {
                        $("#rankingReview_" + rankingArrayCount).empty();
                        for (var i = 1; i < 6; i++) {
                          if (i > result[1]) {
                            var star =
                              '<img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>';
                          } else {
                            var star =
                              '<img src="img/starOn.png" alt=""style="height:14px;margin-right:3px;"/>';
                          }
                          $("#rankingReview_" + rankingArrayCount).append(star);
                        }
                        $("#rankingReview_" + rankingArrayCount).append(
                          "(" + result[0] + ")"
                        );
                      });
                    })
                    .catch(function(error) {
                      console.log(error);
                    });

                  setTimeout(function() {
                    hideLoad();
                    syoryaku(".mainPageItemText");
                    syoryakuName(".mainUserName");
                  }, 1000);
                });
            })
            .catch(function(error) {
              console.log(error);
            });
        }
      });
    }
    function productGet(selfReload, done) {
      var user = firebase.auth().currentUser;
      if (user === null) {
        ons.notification.alert({
          message: "ログイン情報が取得できません。ログアウトします。"
        });
        logout();
        return;
      }
      if (selfReload != "selfReload") {
        showLoad();
      }
      $("#allProduct").empty();
      $("#careerProduct").empty();
      $("#studyProduct").empty();
      $("#businessProduct").empty();
      $("#lifeProduct").empty();
      var nowDataCount = 0;
      var products = db.collection("products");
      products
        .where("releasestatus", "==", "syuppin")
        .orderBy("createTime", "desc")
        .get()
        .then(results => {
          if (results.size > 0) {
            results.forEach(doc => {
              nowDataCount++;
              var product =
                `
              <div style="text-align: center;width:47%;padding:5px 1.5% 3px 1.5% !important;">
                <ons-card class="mainCard mainCard_` +
                nowDataCount +
                `">
                <ons-row class="mainProductCategory_` +
                nowDataCount +
                `" style="font-size:0.6em;border-radius:8px 8px 0px 0px;">
                </ons-row>
                <div class="card-box">
                <ons-row >
                    <ons-col class="productTime mainProductTime_` +
                nowDataCount +
                `"></ons-col>
                  </ons-row>
                  <img class="user_icon_mainPage mainImage_` +
                nowDataCount +
                `"alt="" />
                  <p class="mainUserName mainUserName_` +
                nowDataCount +
                `"></p>
                  <p class="mainReview_` +
                nowDataCount +
                `"class="mainReview">
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  (0)
                  </p>
                  <div style="display: flex;justify-content: center;align-items: center;height:57px;margin-top:7px;margin-bottom:7px;">
                  <div class="round-cap-left"></div>
                  <p class="mainPageItemText mainTitle_` +
                nowDataCount +
                `"></p>
                </div>
                  <ons-row style="width:100%;line-height:24px;">
                    <ons-col class="salaly mainSalalyTime_` +
                nowDataCount +
                `" style="text-align:left;"></ons-col>
                    <ons-col class="howto mainHowTo_` +
                nowDataCount +
                `" style="text-align:right;"></ons-col>
                  </ons-row>
                  </div>
                </ons-card>
              </div>
            `;
              $("#allProduct").append(product);
              if (doc.data().category1 == "キャリア") {
                $("#careerProduct").append(product);
              } else if (doc.data().category1 == "学業") {
                $("#studyProduct").append(product);
              } else if (doc.data().category1 == "ビジネス") {
                $("#businessProduct").append(product);
              } else if (doc.data().category1 == "生活") {
                $("#lifeProduct").append(product);
              }
              productIndicate(
                doc.id,
                doc.data(),
                nowDataCount,
                results.size,
                selfReload,
                done
              );
            });
          } else {
            hideLoad();
          }
        })
        .catch(error => {
          console.log(`データの取得に失敗しました (${error})`);
          hideLoad();
        });
    }

    function productIndicate(
      docId,
      data,
      nowDataCount,
      size,
      selfReload,
      done
    ) {
      var userId = data.userId;
      var docRef = db.collection("users").doc(userId);
      docRef
        .get()
        .then(function(doc) {
          if (doc.exists) {
            var url = "";
            var user = firebase.auth().currentUser;
            var username = doc.data().username;
            firebase
              .storage()
              .ref()
              .child("profilePicture/" + data.userId)
              .getDownloadURL()
              .then(url => {
                // 画像取得できた
                return url;
              })
              .catch(function() {
                // 画像取得できないとき
                url = "img/userSampleImageMan.png";
                return url;
              })
              .then(function(url) {
                var btn4 = document.getElementsByClassName(
                  "mainCard_" + nowDataCount
                );
                for (var i = 0; i < btn4.length; i++) {
                  btn4[i].onclick = function() {
                    giftDetailJump(docId);
                  };
                }
                if (data.category3 != "") {
                  $(".mainProductCategory_" + nowDataCount).append(
                    "<ons-col style='background:#ff969f;border-radius:8px 0px 0px 0px;color:white;font-weight:bold;'>" +
                      data.category1 +
                      "</ons-col><ons-col style='background:#96d4ff;color:white;font-weight:bold;'>" +
                      data.category2 +
                      "</ons-col><ons-col style='background:#4DB56A;border-radius:0px 8px 0px 0px;color:white;font-weight:bold;'>" +
                      data.category3 +
                      "</ons-col>"
                  );
                } else {
                  $(".mainProductCategory_" + nowDataCount).append(
                    "<ons-col style='background:#ff969f;border-radius:8px 0px 0px 0px;color:white;font-weight:bold;'>" +
                      data.category1 +
                      "</ons-col><ons-col style='background:#96d4ff;border-radius:0px 8px 0px 0px;color:white;font-weight:bold;'>" +
                      data.category2 +
                      "</ons-col>"
                  );
                }

                $(".mainUserName_" + nowDataCount).html(doc.data().username);
                $(".mainImage_" + nowDataCount).attr("src", url);
                $(".mainTitle_" + nowDataCount).html(data.title);
                $(".mainSalalyTime_" + nowDataCount).html(
                  "¥" + data.price + "/" + data.time
                );
                $(".mainHowTo_" + nowDataCount).html(data.howtotalk);
                var createTime = jikanCulc2(data.createTime);
                $(".mainProductTime_" + nowDataCount).html(createTime);
                reviewControl(data.userId).then(function(result) {
                  $(".mainReview_" + nowDataCount).empty();
                  for (var i = 1; i < 6; i++) {
                    if (i > result[1]) {
                      var star =
                        '<img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>';
                    } else {
                      var star =
                        '<img src="img/starOn.png" alt=""style="height:14px;margin-right:3px;"/>';
                    }
                    $(".mainReview_" + nowDataCount).append(star);
                  }
                  $(".mainReview_" + nowDataCount).append(
                    "(" + result[0] + ")"
                  );
                });
                if (nowDataCount == size) {
                  if (selfReload != "selfReload") {
                    setTimeout(function() {
                      syoryaku(".mainPageItemText");
                      syoryakuName(".mainUserName");
                      hideLoad();
                    }, 500);
                  } else {
                    setTimeout(function() {
                      syoryaku(".mainPageItemText");
                      syoryakuName(".mainUserName");
                      done();
                    }, 500);
                  }
                }
              });
          } else {
            // doc.data() will be undefined in this case
          }
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
        });
    }

    function giftDetailJump(docId) {
      myNavigator.bringPageTop("html/product/productDetail.html");
      setTimeout(function() {
        productInfo(docId);
      }, 100);
    }
    function reviewControl(userId) {
      return new Promise(resolve => {
        db.collection("users")
          .doc(userId)
          .collection("reviews")
          .get()
          .then(function(reviews) {
            var reviewArray = [];
            reviews.forEach(review => {
              reviewArray.push(review.data().reviewCount);
            });
            var sum = 0;
            var reviewQuantity = reviewArray.push();
            reviewArray.forEach(function(v) {
              sum += Number(v);
            });
            if (reviewQuantity > 0) {
              var reviewAverage = sum / reviewQuantity;
            } else {
              var reviewAverage = 0;
            }
            var reviewInfo = [reviewQuantity, Math.round(reviewAverage)];
            resolve(reviewInfo);
          });
      });
    }

    function rankingForEachPromise(negotiation) {
      var counter = 0;
      var rankingArray = [];
      return new Promise(resolve => {
        negotiation.forEach(function(nego) {
          var productId = nego.data().productId;

          var products = db
            .collection("products")
            .doc(productId)
            .get()
            .then(function(product) {
              console.log(product.data());
              var category1 = product.data().category1;

              return category1;
            })
            .then(function(category1) {
              if (
                rankingArray.some(ranking => ranking.productId == productId)
              ) {
                var result = rankingArray.filter(
                  ranking => ranking.productId === productId
                );
                result[0].count++;
              } else {
                rankingArray.push({
                  productId: productId,
                  count: 1,
                  category1: category1
                });
              }
              counter++;
              if (counter == negotiation.size) {
                resolve(rankingArray);
              }
            })
            .catch(function(error) {
              console.log(error);
            });
        });
      });
    }

    function torihikiPageJump(productId, buyUserId, productUserId) {
      myNavigator.bringPageTop("html/product/productTorihiki.html");
      setTimeout(function() {
        $("#torihikiPageProductId").val(productId);
        $("#torihikiPageProductUserId").val(productUserId);
        $("#torihikiPagebuyUserId").val(buyUserId);
        torihikiIndicate(productId, buyUserId, productUserId);
      }, 100);
    }

    document.addEventListener("deviceready", function() {
      var applicationKey =
        "7e4e7a3c249ee77301994716f3a8830d1f713804cb2379a550e0814acb215ed1";
      var clientKey =
        "cba0bb9821169b593d88ebb8a7828f79638c911da3008212739e13b9189ff608";
      // デバイストークンの取得処理
      if (NCMB.monaca) {
        NCMB.monaca.setDeviceToken(
          applicationKey,
          clientKey,
          result => {
            console.log(result);
          },
          err => {
            console.log("通知設定エラー：" + JSON.stringify(err));
          }
        );
      }
    });
    document.addEventListener("deviceready", function() {
      setTimeout(function() {
        getInstallationId();
      }, 500);
      setTimeout(function() {
        getInstallationId();
      }, 5000);
      setTimeout(function() {
        getInstallationId();
      }, 10000);
    });

    function getInstallationId() {
      NCMB.monaca.getInstallationId(id => {
        ncmb.Installation.equalTo("objectId", id)
          .fetch()
          .then(installation => {
            var user = firebase.auth().currentUser;
            installation.set("userId", user.uid).update();
          })
          .catch(err => console.log("通知設定エラー：" + JSON.stringify(err)));
      });
    }

    function notificationGet() {
      var user = firebase.auth().currentUser;
      db.collection("notifications")
        .where("catchUserId", "==", user.uid)
        .where("readStatus", "==", "Unread")
        .onSnapshot(function(notifications) {
          if (notifications.size > 0) {
            $("#mainPushBadge").show();
            var unReadCount = notifications.size;
            $("#mainPushBadge").html(unReadCount);
          } else {
            $("#mainPushBadge").hide();
          }
        });
    }

    function jikanCulc2(create_date) {
      var create_date = new Date(create_date.seconds * 1000);
      var YY = create_date.getFullYear();
      var MM = create_date.getMonth() + 1;
      //「日」を取得する
      var DD = create_date.getDate();
      //「時」を取得する
      var hh = create_date.getHours();
      //「分」を取得する
      var mm = create_date.getMinutes();
      if (hh < 10) {
        hh = "0" + hh;
      }
      if (mm < 10) {
        mm = "0" + mm;
      }
      var create_date = YY + "/" + MM + "/" + DD + " " + hh + ":" + mm;

      var time = new Date();
      var from = new Date(create_date);

      // 現在時刻との差分＝経過時間
      var diff = new Date().getTime() - from.getTime();
      // 経過時間をDateに変換

      var elapsed = new Date(diff);

      // 大きい単位から順に表示
      if (elapsed.getUTCFullYear() - 1970) {
        var time = elapsed.getUTCFullYear() - 1970 + "年前";
      } else if (elapsed.getUTCMonth()) {
        var time = elapsed.getUTCMonth() + "ヶ月前";
      } else if (elapsed.getUTCDate() - 1) {
        var time = elapsed.getUTCDate() - 1 + "日前";
      } else if (elapsed.getUTCHours()) {
        var time = elapsed.getUTCHours() + "時間前";
      } else if (elapsed.getUTCMinutes()) {
        var time = elapsed.getUTCMinutes() + "分前";
      } else {
        var time = "たった今";
      }
      return time;
    }
  </script>
</ons-page>
