<ons-page id="myPage">
  <!-- <ons-toolbar>
    <div class="center" id="toolbar-title">マイページ</div>
  </ons-toolbar> -->
  <ons-fab
    modifier="mini"
    position="top right"
    ripple
    onclick="myNavigator.bringPageTop('html/mypage/mypageProfileEdit.html');"
  >
    <ons-icon
      icon="fa-user-edit"
      style="font-size:0.8em;transform:translate(2px,-2px);"
    ></ons-icon>
  </ons-fab>
  <div style="height:150px;text-align: center;margin-top:3rem;">
    <img
      id="myPageImage"
      src="img/userSampleImageMan.png"
      alt=""
      style="width:150px;height:150px;object-fit:cover;border-radius: 50%;"
    />
  </div>
  <div style="width:85%;margin:0 auto;margin-top:20px;">
    <p
      id="myPageUserName"
      style="text-align: center;font-size:1.2em;margin-top:0.5rem;margin-bottom:0.5rem;"
    ></p>
    <div>
      <p
        id="myPageReview"
        style="width:100%;display:flex;justify-content: center;"
      ></p>
    </div>
    <p id="myPageText" class="navy" style="font-size:0.8em;"></p>
  </div>
  <div style="width:100%;margin:0 auto;margin-top:20px;margin-bottom:30px;">
    <ons-list-header>サービス関連</ons-list-header>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/myFavorite.html');"
    >
      <div class="center">
        いいねしたサービス
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/mySyuppin.html');"
    >
      <div class="center">
        出品したサービス
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/myBought.html');"
    >
      <div class="center">
        購入したサービス
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/myShitagaki.html');"
    >
      <div class="center">
        下書き一覧
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-header>個人情報関連</ons-list-header>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/myPointKanri.html');"
    >
      <div class="center">
        売り上げ・ポイント管理
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/myInfoEnv.html');"
    >
      <div class="center">
        個人情報設定
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/friendInvite.html');"
    >
      <div class="center">
        友人を招待
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/inviteCodeInput.html');"
    >
      <div class="center">
        招待コードを入力
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
    <ons-list-header>その他</ons-list-header>
    <ons-list-item
      onclick="myNavigator.bringPageTop('html/mypage/toiawase.html');"
    >
      <div class="center">
        お問い合わせ
      </div>
      <div class="right">
        >
      </div>
    </ons-list-item>
  </div>
  <div
    style="width:85%;margin-top:1rem;margin:0 auto;margin-bottom:3rem;"
    onclick="logoutOpen();"
  >
    <ons-button modifier="large" class="large-button-gray"
      >ログアウト</ons-button
    >
  </div>
  <script>
    var user = firebase.auth().currentUser;

    function logoutOpen() {
      ons.notification.confirm({
        message: "ログアウトしますか？",
        title: "確認",
        buttonLabels: ["Cancel", "OK"],
        callback: function(buttonIndex) {
          if (buttonIndex == 1) {
            logout();
          }
        }
      });
    }

    function logout() {
      firebase.auth().onAuthStateChanged(user => {
        firebase
          .auth()
          .signOut()
          .then(() => {
            myNavigator.resetToPage("html/loginPage.html");
          })
          .catch(error => {
            ons.notification.alert({
              title: "ログイン失敗",
              message: `ログアウト時にエラーが発生しました (${error})`
            });
          });
      });
    }

    document.addEventListener(
      "init",
      function(event) {
        if (event.target.matches("#myPage")) {
          // ons.notification.alert("ページ1が初期化されました");
          // コンテンツを準備...
          var user = firebase.auth().currentUser;
          if (user) {
            // User is signed in.
            userInfo(user.uid);
          } else {
            // No user is signed in.
          }
        }
      },
      false
    );
    function userInfo(userId) {
      var docRef = db.collection("users").doc(userId);

      docRef
        .get()
        .then(function(doc) {
          if (doc.exists) {
            $("#myPageUserName").html(doc.data().username);
            $("#myPageText").html(doc.data().text);

            ref = firebase
              .storage()
              .ref()
              .child("profilePicture/" + userId);
            ref.getDownloadURL().then(url => {
              document.getElementById("myPageImage").src = url;
            });
            // var reviewInFo =
            reviewControl(userId).then(function(result) {
              $("#myPageReview").empty();
              for (var i = 1; i < 6; i++) {
                if (i > result[1]) {
                  var star =
                    '<img src="img/starOff.png" alt="" style="height:18px;margin-right:5px;" />';
                } else {
                  var star =
                    '<img src="img/starOn.png" alt="" style="height:18px;margin-right:5px;" />';
                }
                $("#myPageReview").append(star);
              }
              $("#myPageReview").append("(" + result[0] + ")");
            });
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
        });
    }
    function getAge() {
      setTimeout(function() {
        return 37;
      }, 2000);
    }
  </script>
</ons-page>
