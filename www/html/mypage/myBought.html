<ons-page id="myBoughtPage">
  <style>
    #myBoughtPage .fa-heart,
    #myBoughtPage .fa-comment-dots {
      margin-right: 0.5rem;
    }
    #myBoughtPage .fa-comment-dots {
      margin-left: 1rem;
    }
  </style>
  <ons-toolbar>
    <div class="left">
      <ons-back-button> </ons-back-button>
    </div>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
    >
      購入したサービス
    </div>
  </ons-toolbar>
  <div class="mainHeader">
    <ons-carousel
      id="tabMyBoughtCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="50%"
      initial-index="0"
      auto-scroll-ratio="0.2"
      style="height:40px;"
    >
      <ons-carousel-item
        class="active_tabCarousel"
        onclick="myBoughtTapCarouselChange(0)"
      >
        <div class="item-label" style="line-height: 35px;">
          取引中
        </div>
      </ons-carousel-item>
      <ons-carousel-item
        style="line-height: 35px;"
        onclick="myBoughtTapCarouselChange(1)"
      >
        <div class="item-label">取引完了</div>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <div class="content">
    <ons-carousel
      id="myBoughtCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="100%"
      initial-index="0"
      auto-scroll-ratio="0.2"
    >
      <ons-carousel-item style="min-height: 500px;">
        <ons-list style="background-image: none;" id="myBoughtList"> </ons-list>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <ons-list style="background-image: none;" id="myBoughtCompleteList">
        </ons-list>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <script>
    ("use strict");
    setTimeout(function() {
      var chatCarousel = document.getElementById("myBoughtCarousel");
      chatCarousel.addEventListener("postchange", function(e) {
        // alert(e.activeIndex);
        tabMyBoughtCarouselChange(e.activeIndex);
      });
    }, 100);

    function tabMyBoughtCarouselChange(carouselIndex) {
      $("#tabMyBoughtCarousel ons-carousel-item").removeClass(
        "active_tabCarousel"
      );
      $("#tabMyBoughtCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
    }
    function myBoughtTapCarouselChange(carouselIndex) {
      $("#tabMyBoughtCarousel ons-carousel-item").removeClass(
        "active_tabCarousel"
      );
      $("#tabMyBoughtCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
      var myBoughtCarousel = document.getElementById("myBoughtCarousel");
      myBoughtCarousel.setActiveIndex(carouselIndex);
    }
    ons.ready(function() {
      var page = document.getElementById("myBoughtPage");
      var toolbar = page.querySelector(".toolbar");
      var header = page.querySelector(".mainHeader");
      var content = page.querySelector(".content");
      header.style.top = toolbar.clientHeight + "px";
      content.style.marginTop = 40 + "px";
    });

    myTorihikiGet();
    function myTorihikiGet() {
      showLoad();
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      $("#myBoughtList").empty();
      $("#myBoughtCompleteList").empty();
      var nowDataCount = 0;
      var negotiations = db.collection("negotiations");
      negotiations
        .where("buyUserId", "==", userId)
        .orderBy("createTime", "desc")
        .get()
        .then(function(negotiationsResult) {
          if (negotiationsResult.size > 0) {
            negotiationsResult.forEach(negotiation => {
              nowDataCount++;
              var products = db.collection("products");
              products
                .doc(negotiation.data().productId)
                .get()
                .then(result => {
                  if (result.exists) {
                    myTorihikiIndicate(
                      negotiation.data(),
                      result.data(),
                      nowDataCount,
                      negotiationsResult.size,
                      user
                    );
                  } else {
                    hideLoad();
                  }
                })
                .catch(error => {
                  console.log(`データの取得に失敗しました (${error})`);
                  hideLoad();
                });
            });
          } else {
            hideLoad();
          }
        })
        .catch(function(error) {
          // テキストエリアの作成
          console.log(error);
          hideLoad();
        });
    }

    function myTorihikiIndicate(
      negotiationData,
      data,
      nowDataCount,
      size,
      user
    ) {
      firebase
        .storage()
        .ref()
        .child("profilePicture/" + negotiationData.productUserId)
        .getDownloadURL()
        .then(function(url) {
          return url;
        })
        .catch(function() {
          return (url = "img/userSampleImageMan.png");
        })
        .then(function(url) {
          var myTorihiki = "";
          myTorihiki +=
            `
                    <ons-list-item onclick="torihikiPageJump('` +
            negotiationData.productId +
            `','` +
            negotiationData.buyUserId +
            `','` +
            negotiationData.productUserId +
            `')">
                      <ons-row>
                        <ons-col width="20%" vertical-align="center">
                          <img
                            class="mySyuppinImage list-item__thumbnail"
                            src="` +
            url +
            `"
                            style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                          />
                        </ons-col>
                        <ons-col width="70%" vertical-align="center">
                          <p style="margin-bottom:0px;margin-top:0px;">` +
            data.title +
            `<br />¥` +
            data.price +
            `</p>
                        </ons-col>
                        <ons-col width="10%" vertical-align="center">＞</ons-col>
                      </ons-row>
                    </ons-list-item>
                `;
          if (negotiationData.status == "取引中") {
            $("#myBoughtList").append(myTorihiki);
          } else if (negotiationData.status == "取引完了") {
            $("#myBoughtCompleteList").append(myTorihiki);
          }

          if (nowDataCount == size) {
            hideLoad();
          }
        });
    }
  </script>
</ons-page>
