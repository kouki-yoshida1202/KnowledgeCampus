<ons-page id="myFavoritePage">
  <style>
    #myFavoritePage .fa-heart,
    #myFavoritePage .fa-comment-dots,
    #myFavoritePage .fa-cart-arrow-down {
      margin-right: 0.5rem;
    }

    #myFavoritePage .fa-cart-arrow-down,
    #myFavoritePage .fa-comment-dots {
      margin-left: 1rem;
    }
    #myFavoritePage ons-list-item {
      border-bottom: 1px solid #efeff4;
    }
    #myFavoritePage .list-item__center {
      background-image: none;
    }
  </style>
  <ons-toolbar>
    <div class="left">
      <ons-back-button> </ons-back-button>
    </div>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
    >
      いいねしたサービス
    </div>
  </ons-toolbar>
  <div class="content">
    <ons-pull-hook id="pull-hook-favo">
      <i class="fas fa-spinner" style="font-size:1.3em;"></i>
    </ons-pull-hook>
    <ons-list id="myFavoriteList" style="background-image: none;"> </ons-list>
  </div>
  <script>
    ons.ready(function() {
      var pullHook = document.getElementById("pull-hook-favo");
      pullHook.onAction = function(done) {
        favoriteGet();
        setTimeout(function() {
          done();
        }, 1000);
      };
      pullHook.addEventListener("changestate", function(event) {
        var message = "";

        switch (event.state) {
          case "initial":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "preaction":
            message = '<i class="fas fa-spinner" style="font-size:1.3em;"></i>';
            break;
          case "action":
            message =
              '<i class="fas fa-spinner fa-spin" style="font-size:1.3em;"></i>';
            break;
        }

        pullHook.innerHTML = message;
      });
    });
    favoriteGet();
    function favoriteGet() {
      showLoad();
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      $("#myFavoriteList").empty();
      var nowDataCount = 0;
      let favorite = db.collection("favorite");
      favorite
        .where("favoUserId", "==", userId)
        .orderBy("createTime", "desc")
        .get()
        .then(results => {
          if (results.size > 0) {
            results.forEach(result => {
              nowDataCount++;
              favoriteIndicate(result.data(), nowDataCount, results.size);
            });
          } else {
            hideLoad();
          }
        })
        .catch(error => {
          console.log(`データの取得に失敗しました (${error})`);
          hideLoad();
        });
    }

    function favoriteIndicate(favoResult, nowDataCount, size) {
      console.log(nowDataCount, size);
      console.log(favoResult.productId);
      db.collection("favorite")
        .where("productId", "==", favoResult.productId)
        .get()
        .then(function(result) {
          return result.size;
        })
        .then(function(favoCount) {
          db.collection("products")
            .doc(favoResult.productId)
            .get()
            .then(function(productResult) {
              ref = firebase
                .storage()
                .ref()
                .child("profilePicture/" + productResult.data().userId);
              ref
                .getDownloadURL()
                .then(url => {
                  return url;
                })
                .catch(function() {
                  url = "img/userSampleImageMan.png";
                  return url;
                })
                .then(function(url) {
                  db.collection("products")
                    .doc(favoResult.productId)
                    .collection("comments")
                    .get()
                    .then(function(result) {
                      var commentCount = result.size;
                      db.collection("negotiations")
                        .where("productId", "==", favoResult.productId)
                        .get()
                        .then(function(buyCount) {
                          var buyCount = buyCount.size;
                          var dataSet = [
                            favoCount,
                            productResult,
                            url,
                            commentCount,
                            buyCount
                          ];
                          return dataSet;
                        })
                        .then(function(dataSet) {
                          console.log(dataSet);
                          var favoCount = dataSet[0];
                          var data = dataSet[1];
                          console.log(data.id);
                          var url = dataSet[2];
                          var commentCount = dataSet[3];
                          var buyCount = dataSet[4];
                          var favolist = "";
                          favolist +=
                            `
                              <ons-list-item onclick="giftDetailJump('` +
                            data.id +
                            `')">
                                <ons-row>
                                  <ons-col width="20%" vertical-align="center">
                                    <img
                                      class="shitagakiImage list-item__thumbnail"
                                      src="` +
                            url +
                            `"
                                      style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                                    />
                                  </ons-col>
                                  <ons-col width="70%" vertical-align="center">
                                    <p style="margin-bottom:0px;margin-top:0px;font-size:0.9em;">` +
                            data.data().title +
                            `</p><p style="margin-bottom:0px;margin-top:7px;font-size:0.9em;">¥` +
                            data.data().price +
                            `</p><p style="margin-bottom:0px;font-size:0.9em;margin-top:7px;">
                                      <i class="fas fa-heart" style="color:#ff9831"></i>` +
                            favoCount +
                            `<i class="far fa-comment-dots"></i>` +
                            commentCount +
                            `
                            <i class="fas fa-cart-arrow-down"></i>` +
                            buyCount +
                            ` 
                                    </p>
                                  </ons-col>
                                  <ons-col width="10%" vertical-align="center">＞</ons-col>
                                </ons-row>
                              </ons-list-item>
                          `;
                          $("#myFavoriteList").append(favolist);
                          if (nowDataCount == size) {
                            hideLoad();
                            console.log("最後");
                          } else {
                            console.log("最後通らん");
                          }
                        })
                        .catch(function(error) {
                          console.log(error);
                          hideLoad();
                        });
                    });
                });
            })
            .catch(function(error) {
              console.log(error);
              hideLoad();
            });
        })
        .catch(function(error) {
          console.log(error);
          hideLoad();
        });
    }
  </script>
</ons-page>
