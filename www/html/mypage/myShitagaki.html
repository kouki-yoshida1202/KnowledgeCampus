<ons-page id="myShitagakiPage">
  <style>
    #myShitagakiPage .fa-heart,
    #myShitagakiPage .fa-comment-dots,
    #myShitagakiPage .fa-cart-arrow-down {
      margin-right: 0.5rem;
    }

    #myShitagakiPage .fa-cart-arrow-down,
    #myShitagakiPage .fa-comment-dots {
      margin-left: 1rem;
    }

    #myShitagakiPage ons-list-item {
      border-bottom: 1px solid #efeff4;
    }
    #myShitagakiPage .list-item__center {
      background-image: none;
    }
  </style>
  <ons-toolbar>
    <div class="left">
      <ons-back-button> </ons-back-button>
    </div>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
    >
      下書き一覧
    </div>
  </ons-toolbar>
  <div class="content">
    <ons-list id="myShitagakiList" style="background-image: none;"> </ons-list>
  </div>
  <script>
    shitagakiGet();
    function shitagakiGet() {
      showLoad();
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      $("#myShitagakiList").empty();
      var nowDataCount = 0;
      let products = db.collection("products");
      products
        .where("releasestatus", "==", "shitagaki")
        .where("userId", "==", userId)
        .orderBy("createTime", "desc")
        .get()
        .then(results => {
          if (results.size > 0) {
            results.forEach(doc => {
              nowDataCount++;
              shitagakiIndicate(
                doc.id,
                doc.data(),
                nowDataCount,
                results.size,
                user
              );
            });
          } else {
            hideLoad();
          }
        })
        .catch(error => {
          console.log(`データの取得に失敗しました (${error})`);
          hideLoad();
        });
    }

    function shitagakiIndicate(productId, data, nowDataCount, size, user) {
      db.collection("favorite")
        .where("productId", "==", productId)
        .get()
        .then(function(result) {
          return result.size;
        })
        .then(function(favoCount) {
          return favoCount;
        })
        .then(function(favoCount) {
          db.collection("products")
            .doc(productId)
            .collection("comments")
            .get()
            .then(function(commentResults) {
              db.collection("negotiations")
                .where("productId", "==", productId)
                .get()
                .then(function(buyCount) {
                  var buyCount = buyCount.size;
                  var commentCount = commentResults.size;
                  var shitagaki = "";
                  shitagaki +=
                    `
                  <ons-list-item onclick="giftDetailJump('` +
                    productId +
                    `')">
                    <ons-row>
                      <ons-col width="20%" vertical-align="center">
                        <img
                          class="shitagakiImage list-item__thumbnail"
                          src="img/userSampleImageMan.png"
                          style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                        />
                      </ons-col>
                      <ons-col width="70%" vertical-align="center">
                        <p style="margin-bottom:0px;margin-top:0px;font-size:0.9em;">` +
                    data.title +
                    `</p><p style="margin-bottom:0px;margin-top:7px;font-size:0.9em;">¥` +
                    data.price +
                    `</p>
                        <p style="margin-bottom:0px;font-size:0.9em;">
                          <i class="fas fa-heart"></i>` +
                    favoCount +
                    `<i class="far fa-comment-dots"></i>` +
                    commentCount +
                    `<i class="fas fa-cart-arrow-down"></i >` +
                    buyCount +
                    `
                        </p>
                      </ons-col>
                      <ons-col width="10%" vertical-align="center">＞</ons-col>
                    </ons-row>
                  </ons-list-item>
              `;
                  $("#myShitagakiList").append(shitagaki);
                  if (nowDataCount == size) {
                    firebase
                      .storage()
                      .ref()
                      .child("profilePicture/" + user.uid)
                      .getDownloadURL()
                      .then(function(url) {
                        return url;
                      })
                      .catch(function() {
                        return (url = "img/userSampleImageMan.png");
                      })
                      .then(function(url) {
                        console.log(url);
                        var shitagakiImage = document.getElementsByClassName(
                          "shitagakiImage"
                        );
                        for (var i = 0; i < shitagakiImage.length; i++) {
                          shitagakiImage[i].src = url;
                        }
                      });
                    hideLoad();
                  }
                })
                .catch(function(error) {
                  console.log(error);
                  hideLoad();
                });
            })
            .catch(function(error) {
              console.log(error);
              hideLoad();
            });
        })
        .catch(function(error) {
          console.log(error);
          hideLoad();
        });
    }
  </script>
</ons-page>
