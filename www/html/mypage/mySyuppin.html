<ons-page id="mySyuppinPage">
  <style>
    #mySyuppinPage .fa-heart,
    #mySyuppinPage .fa-comment-dots,
    #mySyuppinPage .fa-cart-arrow-down {
      margin-right: 0.5rem;
    }

    #mySyuppinPage .fa-cart-arrow-down,
    #mySyuppinPage .fa-comment-dots {
      margin-left: 1rem;
    }
    #mySyuppinPage ons-list-item {
      border-bottom: 1px solid #efeff4;
    }
    #mySyuppinPage .list-item__center {
      background-image: none;
    }
  </style>
  <ons-toolbar>
    <div class="left">
      <ons-back-button> </ons-back-button>
    </div>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
    >
      出品したサービス
    </div>
  </ons-toolbar>
  <div class="mainHeader">
    <ons-carousel
      id="tabMySyuppinCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="33%"
      initial-index="0"
      auto-scroll-ratio="0.2"
      style="height:40px;border-bottom:1px solid #efeff4;"
    >
      <ons-carousel-item
        class="active_tabCarousel"
        style="line-height: 35px;"
        onclick="mySyuppinTapCarouselChange(0)"
      >
        <div class="item-label">
          出品中
        </div>
      </ons-carousel-item>
      <ons-carousel-item
        style="line-height: 35px;"
        onclick="mySyuppinTapCarouselChange(1)"
      >
        <div class="item-label">取引中</div>
      </ons-carousel-item>
      <ons-carousel-item
        style="line-height: 35px;"
        onclick="mySyuppinTapCarouselChange(2)"
      >
        <div class="item-label">取引完了</div>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <div class="content">
    <ons-carousel
      id="mySyuppinCarousel"
      swipeable
      overscrollable
      auto-scroll
      var="carousel"
      item-width="100%"
      initial-index="0"
      auto-scroll-ratio="0.2"
      reflesh="console.log('Changed to ' + $event.activeIndex)"
    >
      <ons-carousel-item style="min-height: 500px;">
        <ons-list id="mySyuppinList" style="background-image: none;">
        </ons-list>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <ons-list id="mySyuppinTorihikiList" style="background-image: none;">
        </ons-list>
      </ons-carousel-item>
      <ons-carousel-item style="min-height: 500px;">
        <ons-list id="mySyuppinCompleteList" style="background-image: none;">
        </ons-list>
      </ons-carousel-item>
    </ons-carousel>
  </div>
  <script>
    setTimeout(function() {
      var chatCarousel = document.getElementById("mySyuppinCarousel");
      chatCarousel.addEventListener("postchange", function(e) {
        // alert(e.activeIndex);
        tabMySyuppinCarouselChange(e.activeIndex);
      });
    }, 100);
    var torihikiCounter = 0;
    var completeCounter = 0;
    function mySyuppinTapCarouselChange(carouselIndex) {
      $("#tabMySyuppinCarousel ons-carousel-item").removeClass(
        "active_tabCarousel"
      );
      $("#tabMySyuppinCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");
      var mySyuppinCarousel = document.getElementById("mySyuppinCarousel");
      mySyuppinCarousel.setActiveIndex(carouselIndex);
      if (carouselIndex == 1 && torihikiCounter == 0) {
        mySyuppinTorihikiGet("取引中");
        torihikiCounter++;
      } else if (carouselIndex == 2 && completeCounter == 0) {
        mySyuppinTorihikiGet("取引完了");
        completeCounter++;
      }
    }
    function tabMySyuppinCarouselChange(carouselIndex) {
      $("#tabMySyuppinCarousel ons-carousel-item").removeClass(
        "active_tabCarousel"
      );
      $("#tabMySyuppinCarousel ons-carousel-item")
        .eq(carouselIndex)
        .addClass("active_tabCarousel");

      if (carouselIndex == 1 && torihikiCounter == 0) {
        mySyuppinTorihikiGet("取引中");
        torihikiCounter++;
      } else if (carouselIndex == 2 && completeCounter == 0) {
        mySyuppinTorihikiGet("取引完了");
        completeCounter++;
      }
    }
    ons.ready(function() {
      var page = document.getElementById("mySyuppinPage");
      var toolbar = page.querySelector(".toolbar");
      var header = page.querySelector(".mainHeader");
      var content = page.querySelector(".content");
      header.style.top = toolbar.clientHeight + "px";
      content.style.marginTop = 40 + "px";
    });

    mySyuppinGet();
    function mySyuppinGet() {
      showLoad();
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      var targetList = "#mySyuppinList";
      $("#mySyuppinList").empty();
      $("#mySyuppinTorihikiList").empty();
      $("#mySyuppinCompleteList").empty();
      var nowDataCount = 0;
      let products = db.collection("products");
      products
        .where("releasestatus", "==", "syuppin")
        .where("userId", "==", userId)
        .orderBy("createTime", "desc")
        .get()
        .then(results => {
          if (results.size > 0) {
            results.forEach(doc => {
              nowDataCount++;
              mySyuppinIndicate(
                doc.id,
                doc.data(),
                nowDataCount,
                results.size,
                user,
                targetList,
                "",
                ""
              );
            });
          } else {
            hideLoad();
          }
        })
        .catch(error => {
          console.log(`データの取得に失敗しました (${error})`);
          hideLoad();
        });
    }

    function mySyuppinIndicate(
      productId,
      data,
      nowDataCount,
      size,
      user,
      targetList,
      buyUserId,
      productUserId
    ) {
      if (targetList == "#mySyuppinList") {
        db.collection("favorite")
          .where("productId", "==", productId)
          .get()
          .then(function(result) {
            return result.size;
          })
          .then(function(favoCount) {
            return favoCount;
          })
          .then(function(favoCount) {
            db.collection("products")
              .doc(productId)
              .collection("comments")
              .get()
              .then(function(commentResults) {
                var commentCount = commentResults.size;
                db.collection("negotiations")
                  .where("productId", "==", productId)
                  .get()
                  .then(function(buyCount) {
                    var buyCount = buyCount.size;
                    var fotterInfo =
                      `<i class="fas fa-heart"></i>` +
                      favoCount +
                      `<i class="far fa-comment-dots"></i >` +
                      commentCount +
                      `<i class="fas fa-cart-arrow-down"></i >` +
                      buyCount;
                    var mySyuppin = "";
                    mySyuppin +=
                      `
                    <ons-list-item onclick="giftDetailJump('` +
                      productId +
                      `')">
                      <ons-row>
                        <ons-col width="20%" vertical-align="center">
                          <img
                            class="mySyuppinImage list-item__thumbnail"
                            src="img/userSampleImageMan.png"
                            style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                          />
                        </ons-col>
                        <ons-col width="70%" vertical-align="center">
                          <p style="margin-bottom:0px;margin-top:0px;font-size:0.9em;">` +
                      data.title +
                      `</p><p style="margin-bottom:0px;margin-top:7px;font-size:0.9em;">¥` +
                      data.price +
                      `</p>
                          <p style="margin-bottom:0px;margin-top:7px;font-size:0.9em;">
                            ` +
                      fotterInfo +
                      `
                          </p>
                        </ons-col>
                        <ons-col width="10%" vertical-align="center">＞</ons-col>
                      </ons-row>
                    </ons-list-item>
                `;
                    $(targetList).append(mySyuppin);
                  });
              });
          });
        if (nowDataCount == size) {
          firebase
            .storage()
            .ref()
            .child("profilePicture/" + user.uid)
            .getDownloadURL()
            .then(function(url) {
              return url;
            })
            .catch(function() {
              return (url = "img/userSampleImageMan.png");
            })
            .then(function(url) {
              setTimeout(function() {
                $(".mySyuppinImage").attr("src", url);
              }, 1500);
            });
          hideLoad();
        }
      } else {
        db.collection("users")
          .doc(buyUserId)
          .get()
          .then(function(result) {
            var buyUserName = result.data().username;
            db.collection("favorite")
              .where("productId", "==", productId)
              .get()
              .then(function(result) {
                return result.size;
              })
              .then(function(favoCount) {
                return favoCount;
              })
              .then(function(favoCount) {
                db.collection("products")
                  .doc(productId)
                  .collection("comments")
                  .get()
                  .then(function(commentResults) {
                    db.collection("negotiations")
                      .where("productId", "==", productId)
                      .get()
                      .then(function(buyCount) {
                        var buyCount = buyCount.size;
                        var commentCount = commentResults.size;
                        var fotterInfo =
                          `<i class="fas fa-heart"></i>` +
                          favoCount +
                          `<i class="far fa-comment-dots" style="margin-left:0.5rem;"></i >` +
                          commentCount +
                          `<i class="fas fa-cart-arrow-down" style="margin-left:0.5rem;"></i >` +
                          buyCount +
                          `<span style="font-size:0.8em;margin-left:0.5rem;">` +
                          buyUserName +
                          `さんが購入</span>`;

                        var mySyuppin = "";
                        mySyuppin +=
                          `
                                  <ons-list-item onclick="torihikiPageJump('` +
                          productId +
                          `','` +
                          buyUserId +
                          `','` +
                          productUserId +
                          `')">
                                    <ons-row>
                                      <ons-col width="20%" vertical-align="center">
                                        <img
                                          class="mySyuppinImage list-item__thumbnail"
                                          src="img/userSampleImageMan.png"
                                          style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                                        />
                                      </ons-col>
                                      <ons-col width="70%" vertical-align="center">
                                        <p style="margin-bottom:0px;margin-top:0px;font-size:0.9em;">` +
                          data.title +
                          `</p><p style="margin-bottom:0px;margin-top:7px;font-size:0.9em;">¥` +
                          data.price +
                          `</p>
                                          <p style="margin-bottom:0px;margin-top:7px;font-size:0.9em;">
                                            ` +
                          fotterInfo +
                          `
                                          </p>
                                      </ons-col>
                                      <ons-col width="10%" vertical-align="center">＞</ons-col>
                                    </ons-row>
                                  </ons-list-item>
                              `;
                        $(targetList).append(mySyuppin);
                        console.log(nowDataCount, size);
                        if (nowDataCount == size) {
                          firebase
                            .storage()
                            .ref()
                            .child("profilePicture/" + user.uid)
                            .getDownloadURL()
                            .then(function(url) {
                              return url;
                            })
                            .catch(function() {
                              return (url = "img/userSampleImageMan.png");
                            })
                            .then(function(url) {
                              setTimeout(function() {
                                $(".mySyuppinImage").attr("src", url);
                              }, 1500);
                            });
                          hideLoad();
                        }
                      });
                  });
              });
          });
      }
    }

    function mySyuppinTorihikiGet(torihikiStatus) {
      showLoad();
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      if (torihikiStatus == "取引中") {
        var targetList = "#mySyuppinTorihikiList";
      } else if (torihikiStatus == "取引完了") {
        var targetList = "#mySyuppinCompleteList";
      }
      $(targetList).empty();
      var nowDataCount = 0;
      var negotiations = db.collection("negotiations");
      negotiations
        .where("status", "==", torihikiStatus)
        .where("productUserId", "==", userId)
        .orderBy("createTime", "desc")
        .get()
        .then(function(negotiationsResult) {
          if (negotiationsResult.size > 0) {
            negotiationsResult.forEach(negotiation => {
              nowDataCount++;
              var products = db.collection("products");
              products
                .doc(negotiation.data().productId)
                .get()
                .then(result => {
                  if (result.exists) {
                    mySyuppinIndicate(
                      negotiation.data().productId,
                      result.data(),
                      nowDataCount,
                      negotiationsResult.size,
                      user,
                      targetList,
                      negotiation.data().buyUserId,
                      negotiation.data().productUserId
                    );
                  } else {
                    hideLoad();
                  }
                })
                .catch(error => {
                  console.log(`データの取得に失敗しました (${error})`);
                  hideLoad();
                });
            });
          } else {
            hideLoad();
          }
        })
        .catch(function(error) {
          // テキストエリアの作成
          console.log(error);
          hideLoad();
        });
    }
  </script>
</ons-page>
