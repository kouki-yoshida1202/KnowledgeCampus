<ons-page id="mypageProfileEdit-page">
  <ons-toolbar>
    <div class="left">
      <ons-back-button> </ons-back-button>
    </div>
    <div class="center">編集画面</div>
  </ons-toolbar>

  <ons-row style="padding-top:30px;">
    <ons-col vertical-align="center" style="text-align: center;">
      <img
        id="myImageEdit"
        src="img/userSampleImageMan.png"
        style="width:100px;height:100px;object-fit:cover;border-radius: 50%;"
      />
      <br />
      <input id="myImageInput" type="file" />
      <!-- <ons-button
        style="color:white;background-color: #0799d7;line-height: 22px;font-size: 0.9em;margin:5px;"
        onclick="$('#myImageInput').click();"
      >
        写真を変更する
      </ons-button>
      <input type="file" /> -->
    </ons-col>
  </ons-row>
  <ons-list>
    <ons-list-header>基本情報</ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col vertical-align="center" width="30%" style="text-align: left;">
          表示名
        </ons-col>
        <ons-col vertical-align="center" width="70%" style="text-align: right;">
          <ons-input id="myUserNameEdit" placeholder="(必須)"></ons-input>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col vertical-align="center" width="30%" style="text-align: left;">
          自己紹介
        </ons-col>
        <ons-col vertical-align="center" width="70%" style="text-align: right;">
          <textarea
            id="myTextEdit"
            class="textarea textarea--transparent"
            rows="5"
            placeholder=""
          ></textarea>
        </ons-col>
      </ons-row>
    </ons-list-item>
  </ons-list>
  <div style="padding:0.5rem;margin-top:1rem;">
    <ons-button
      modifier="large"
      class="large-button-orange"
      onclick="profileEdit()"
      >編集を完了する</ons-button
    >
  </div>
  <script>
    var userId = firebase.auth().currentUser["uid"];
    var docRef = db.collection("users").doc(userId);
    var fileData;
    setTimeout(function() {
      let mypageProfileEdit = document.querySelector("#mypageProfileEdit-page");
      original_main_height = mypageProfileEdit.clientHeight;
    }, 100);

    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#mypageProfileEdit-page").animate(
        { height: original_main_height - event.keyboardHeight + "px" },
        250
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#mypageProfileEdit-page").animate(
        { height: original_main_height + "px" },
        250
      );
    });
    docRef
      .get()
      .then(function(doc) {
        if (doc.exists) {
          $("#myUserNameEdit").val(doc.data().username);
          $("#myTextEdit").val(doc.data().text);
          ref = firebase
            .storage()
            .ref()
            .child("profilePicture/" + userId);
          ref.getDownloadURL().then(url => {
            document.getElementById("myImageEdit").src = url;
          });
        } else {
          // doc.data() will be undefined in this case
          console.log("No such document!");
        }
      })
      .catch(function(error) {
        console.log("Error getting document:", error);
      });

    $("#myImageInput").on("change", function(e) {
      var reader = new FileReader();
      reader.onload = function(e) {
        $("#myImageEdit").attr("src", e.target.result);
      };
      reader.readAsDataURL(e.target.files[0]);
      fileData = e.target.files[0];
    });

    function profileEdit() {
      showLoad();
      var username = $("#myUserNameEdit").val();
      var text = $("#myTextEdit").val();
      if (username == "") {
        ons.notification.alert({
          title: "失敗",
          message: "ユーザー名を入力してください"
        });
      } else {
        var user = firebase.auth().currentUser;
        // Add a new document in collection "cities"
        db.collection("users")
          .doc(user["uid"])
          .set(
            {
              username: username,
              text: text
            },
            { merge: true }
          )
          .then(function() {
            console.log("Document successfully written!");

            var imgs = document.querySelector("#myImageInput").files[0];
            new Compressor(fileData, {
              quality: 0.6,
              maxWidth: 500,
              maxHeight: 500,
              mimeType: "image",
              success(result) {
                firebase
                  .storage()
                  .ref("profilePicture/" + user["uid"])
                  .put(result)
                  .then(function() {
                    ons.notification.alert({
                      title: "成功",
                      message: "プロフィールを編集しました。"
                    });
                    myNavigator.popPage();
                    userInfo(user["uid"]);
                    hideLoad();
                  });
              },
              error(err) {
                console.log(err.message);
              }
            });

            // var imgs = document.querySelector("#myImageInput").files[0];
            // firebase
            //   .storage()
            //   .ref("profilePicture/" + user["uid"])
            //   .put(imgs)
            //   .then(function() {
            //     ons.notification.alert({
            //       title: "成功",
            //       message: "プロフィールを編集しました。"
            //     });
            //     myNavigator.popPage();
            //     userInfo(user["uid"]);
            //     hideLoad();
            //   });
          })
          .catch(function(error) {
            console.error("Error writing document: ", error);
            hideLoad();
          });
      }
    }
  </script>
</ons-page>
