<ons-page id="productCommentPage">
  <style>
    #productCommentPage ons-list {
      background-image: none;
      background-color: transparent;
    }
    #productCommentPage ons-list p {
      margin-top: 0px;
      margin-bottom: 0px;
    }

    #productCommentPage ons-card {
      margin-left: 0px;
      margin-top: 0px;
    }
    #productCommentPage .list-item__center {
      background-image: none;
      padding-top: 5px;
      padding-bottom: 5px;
    }

    #productCommentPage .list-item__title {
      font-size: 0.8em;
    }
  </style>
  <ons-toolbar>
    <div class="left" id="toolbar-title">
      <ons-back-button></ons-back-button>
    </div>
    <div class="center" id="toolbar-title"></div>
  </ons-toolbar>
  <ons-bottom-toolbar style="line-height: 35px;height:80px">
    <ons-row style="padding-top:5px;">
      <ons-col
        width="80%"
        style="text-align: center;font-size:1.0em;"
        vertical-align="center"
      >
        <ons-input
          id="productCommentInput"
          style="background-color: #efeff4;width:90%;"
          placeholder="コメント入力欄"
        ></ons-input>
      </ons-col>
      <ons-col width="20%" style="text-align: center;" vertical-align="center">
        <ons-button
          class="large-button-orange"
          style="font-size:1.0em;"
          onclick="commentSubmit()"
          >送信
        </ons-button>
      </ons-col>
    </ons-row>
  </ons-bottom-toolbar>
  <div class="content">
    <ons-list id="commentList" style="padding-bottom:100px;"> </ons-list>
  </div>
  <ons-modal direction="up" id="productCommentModal">
    <div style="text-align: center">
      <ons-card>
        <ons-list style="background-image: none;">
          <ons-list-item>
            <ons-row>
              <ons-col>
                <p style="text-align: center;font-size:1.2em;">
                  購入手続き
                  <span
                    style="float:right;padding-right:0.5em;"
                    onclick="hideModal();"
                    ><i class="fas fa-times"></i
                  ></span>
                </p>
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                サービス代金
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >¥3000</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                ポイント使用
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >500P</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                売上金を利用
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
              >
                売上があります >
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                支払い方法
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >カード払い >
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                支払い金額
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="font-size:1.2em;font-weight: bold;text-align: right;padding-right:0.5em;"
                >¥2500</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                通話手段
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >Zoom</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col
                width="100%"
                vertical-align="center"
                style="text-align: center;"
              >
                <ons-button class="large-button-orange">購入する</ons-button>
              </ons-col>
            </ons-row>
          </ons-list-item>
        </ons-list>
      </ons-card>
    </div>
  </ons-modal>
  <input type="hidden" id="commentPageProductId" />
  <input type="hidden" id="commentPageNowDataCountInput" />
  <script>
    setTimeout(function() {
      $("#commentPageProductId").val($("#productDetailId").val());
      commentPageIndicate();
      let productCommentPage = document.querySelector("#productCommentPage");
      original_main_height = productCommentPage.clientHeight;
    }, 100);

    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#productCommentPage").animate(
        { height: original_main_height - event.keyboardHeight + "px" },
        250
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#productCommentPage").animate(
        { height: original_main_height + "px" },
        250
      );
    });
    function showModal() {
      var modal = document.querySelector("#productCommentModal");
      modal.show();
    }

    function hideModal() {
      var modal = document.querySelector("#productCommentModal");
      modal.hide();
    }

    function commentSubmit() {
      var commentInput = $("#productCommentInput").val();
      if (commentInput == "") {
        ons.notification.alert({
          message: "コメントが未入力です"
        });
      } else {
        showLoad();

        var productId = $("#commentPageProductId").val();
        var user = firebase.auth().currentUser;
        var userId = user.uid;
        var createTime = new Date();
        db.collection("products")
          .doc(productId)
          .collection("comments")
          .doc()
          .set(
            {
              comment: commentInput,
              createTime: createTime,
              userId: userId
            },
            { merge: true }
          )
          .then(docRef => {
            var createTime = firebase.firestore.Timestamp.fromDate(new Date());
            console.log(createTime);
            commentIndicate(userId, commentInput, 1, 1, createTime);
            $("#productCommentInput").val("");
            var nowDataCount = $("#commentPageNowDataCountInput").val() + 1;
            var commentlist = "";
            commentlist =
              `
                <ons-list-item>
                  <div class="left">
                    <img
                      id="commentImage_` +
              nowDataCount +
              `"
                      class="list-item__thumbnail"
                      src="img/userSampleImageMan.png"
                      style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                    />
                  </div>
                  <div class="center" style="width:50%;">
                    <span id="commentUserName_` +
              nowDataCount +
              `"class="list-item__title"></span>
                    <span class="list-item__subtitle">
                      <ons-card id="comment_` +
              nowDataCount +
              `">
                      </ons-card>
                    </span>
                  </div>
                </ons-list-item>
              `;
            $("#commentList").prepend(commentlist);
            commentIndicate(
              userId,
              commentInput,
              nowDataCount,
              nowDataCount,
              createTime
            );
          })
          .catch(function(error) {
            console.log(error);
            alert("コメント失敗");
          });
      }
    }

    function commentPageIndicate() {
      showLoad();
      var nowDataCount = 0;
      $("#commentList").empty();
      var productId = $("#commentPageProductId").val();
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      db.collection("products")
        .doc(productId)
        .collection("comments")
        .orderBy("createTime", "asc")
        .get()
        .then(function(commentGetResults) {
          if (commentGetResults.size > 0) {
            commentGetResults.forEach(commentGetResult => {
              nowDataCount++;
              var commentlist = "";
              commentlist =
                `
                <ons-list-item>
                  <div class="left">
                    <img
                      id="commentImage_` +
                nowDataCount +
                `"
                      class="list-item__thumbnail"
                      src="img/userSampleImageMan.png"
                      style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                    />
                  </div>
                  <div class="center" style="width:50%;">
                    <span id="commentUserName_` +
                nowDataCount +
                `"class="list-item__title"></span>
                    <span class="list-item__subtitle">
                      <ons-card id="comment_` +
                nowDataCount +
                `">
                      </ons-card>
                    </span>
                  </div>
                </ons-list-item>
              `;
              $("#commentList").prepend(commentlist);
              commentIndicate(
                commentGetResult.data().userId,
                commentGetResult.data().comment,
                nowDataCount,
                commentGetResults.size,
                commentGetResult.data().createTime
              );
            });
          } else {
            hideLoad();
          }
        })
        .catch(function(error) {
          console.log(error);
          alert("コメント取得失敗");
          hideLoad();
        });
    }

    function commentIndicate(
      commentUserId,
      comment,
      nowDataCount,
      size,
      createTime
    ) {
      //「月」を取得する
      var createTime = new Date(createTime * 1000);
      var MM = createTime.getMonth() + 1;
      //「日」を取得する
      var DD = createTime.getDate();
      //「時」を取得する
      var hh = createTime.getHours();
      //「分」を取得する
      var mm = createTime.getMinutes();
      var time = MM + "月" + DD + "日 " + hh + ":" + mm;
      var docRef = db.collection("users").doc(commentUserId);
      docRef
        .get()
        .then(function(doc) {
          var commentUserName = doc.data().username;
          firebase
            .storage()
            .ref()
            .child("profilePicture/" + commentUserId)
            .getDownloadURL()
            .then(function(url) {
              $("#commentImage_" + nowDataCount).attr("src", url);
              $("#commentUserName_" + nowDataCount).html(commentUserName);
              $("#comment_" + nowDataCount).html(
                comment +
                  `<br><br><span style="font-size:0.85em;margin-top:5px;"><i class="far fa-clock" style="margin-right:5px;"></i>` +
                  time +
                  `</span>`
              );
              if (nowDataCount == size) {
                hideLoad();
                $("#commentPageNowDataCountInput").val(nowDataCount);
              }
            })
            .catch(function(error) {
              console.log("Error getting document:", error);
              hideLoad();
            });
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
          hideLoad();
        });
    }
  </script>
</ons-page>
