<ons-page id="productDetailPage">
  <style>
    .productTitle .fa-heart,
    .productTitle .fa-comment-dots,
    .productTitle .fa-cart-arrow-down {
      margin-right: 0.5rem;
    }
    .productTitle .fa-comment-dots,
    .productTitle .fa-cart-arrow-down {
      margin-left: 0.5rem;
    }
    #productDetailPage ons-list p {
      margin-top: 0px;
      margin-bottom: 0px;
    }

    #productDetailComment ons-card {
      margin-left: 0px;
      margin-top: 0px;
    }
    #productDetailPage .list-item__center {
      background-image: none;
      padding-top: 5px;
      padding-bottom: 5px;
    }
    #productDetailComment {
      background-image: none;
      background-color: #eee;
    }

    #productDetailComment .list-item__title {
      font-size: 0.8em;
    }

    #productDetailModal ons-list-item {
      border-bottom: 1px solid #ccc;
      padding-top: 3px;
      padding-bottom: 3px;
    }
    #productDetailModal ons-input {
      padding-top: 0px;
      padding-bottom: 0px;
    }

    #explanationList .center {
      width: 100%;
    }
  </style>
  <ons-toolbar>
    <div class="left" id="toolbar-title" style="width:15%;">
      <ons-back-button></ons-back-button>
    </div>
    <div class="center" id="toolbar-title" style="width:70%;"></div>
    <div
      class="right"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;width:15%;"
      onclick="showProductDetailReportModal();"
    >
      <i
        id="reportButton"
        class="fas fa-exclamation-triangle fa-fw fa-lg"
        style="color:#515c6f;"
      ></i>
    </div>
  </ons-toolbar>
  <ons-bottom-toolbar
    style="line-height: 35px;height:80px;background: #0f5779;"
  >
    <ons-row>
      <ons-col
        id="productDetailMyPoint"
        width="100%"
        style="text-align: center;font-size:0.9em;color:white;font-weight: bold;line-height: 25px;margin-bottom:5px;"
        vertical-align="center"
        >0P/¥0持っています</ons-col
      >
    </ons-row>
    <ons-row>
      <ons-col
        id="productDetailPriceTime"
        width="50%"
        style="text-align: center;font-size:1.2em;color:white;font-weight: bold;"
        vertical-align="center"
        >¥/分</ons-col
      >
      <ons-col width="50%" style="text-align: center;" vertical-align="center">
        <ons-button
          id="productDetailButton"
          class="large-button-orange"
          style="padding:5px 2em;font-size:1.2em;"
          onclick="showProductDetailModal()"
          >購入</ons-button
        >
      </ons-col>
    </ons-row>
  </ons-bottom-toolbar>
  <div
    id="productUserInfomation"
    style="width:85%;margin:0 auto;margin-top:0px;"
  >
    <div style="height:70px;text-align: center;margin-top:1.5rem;">
      <img
        id="productDetailUserImage"
        src="img/userSampleImageMan.png"
        alt=""
        style="width:70px;height:70px;object-fit:cover;border-radius: 50%;"
      />
    </div>
    <p
      id="productDetailUserName"
      style="text-align: center;margin-top:5px;margin-bottom:5px;"
    ></p>

    <div>
      <p
        id="productDetailUserReview"
        style="display:flex;justify-content: center; width:100%;margin-top:5px;margin-bottom:5px;"
      ></p>
    </div>
    <p id="productDetailText" class="navy" style="font-size:0.8em;"></p>
  </div>
  <div style="width:100%;margin:0 auto;margin-top:20px;margin-bottom:50px;">
    <ons-list-header>商品タイトル</ons-list-header>
    <ons-list-item class="productTitle">
      <ons-row id="productDetailTitle" style="font-weight: bold;"> </ons-row>
      <ons-row>
        <p style="margin-bottom:0px;">
          <i class="far fa-heart" onclick="favoCheck()"></i
          ><span id="favoCount">0</span>
          <i
            class="far fa-comment-dots"
            onclick="myNavigator.bringPageTop('html/product/productComment.html');"
          ></i
          ><span id="commentCount">0</span>
          <i class="fas fa-cart-arrow-down"></i>
          <span id="buyCount">0</span>
        </p>
      </ons-row>
    </ons-list-item>
    <ons-list-header>商品の説明</ons-list-header>
    <ons-list-item id="explanationList" style="width:100%;">
      <ons-row
        style="font-size:0.8em;padding-right:0.25em;width:100%;word-wrap:break-word;overflow-wrap : break-word;"
      >
        <p
          id="productDetailExplanation"
          style="width:100%;margin-top:0px;margin-bottom:0px;"
        ></p>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row id="productDetailHowToTalk" style="font-size:0.8em;"> </ons-row>
    </ons-list-item>

    <ons-list id="productDetailComment" style="min-height: 200px;">
      <ons-list-header>
        <ons-row>
          <ons-col vertical-align="center" style="padding-top:10px;">
            <i class="far fa-comment-dots" style="margin-right:0.3em;"></i
            >コメント
          </ons-col>
        </ons-row>
      </ons-list-header>
      <div id="productDetailCommentZone"></div>
      <ons-list-item>
        <ons-row style="padding:1em;">
          <ons-button
            class="large-button-gray"
            style="margin:0 auto;"
            onclick="myNavigator.bringPageTop('html/product/productComment.html');"
            >全てのコメントを見る</ons-button
          >
        </ons-row>
      </ons-list-item>
    </ons-list>
  </div>
  <ons-modal id="productDetailModal" direction="up">
    <div style="text-align: center">
      <ons-card>
        <ons-list style="background-image: none;">
          <ons-list-item>
            <ons-row>
              <ons-col>
                <p style="text-align: center;font-size:1.2em;">
                  購入手続き
                  <span
                    style="float:right;padding-right:0.5em;"
                    onclick="hideProductDetailModal()"
                    ><i class="fas fa-times"></i
                  ></span>
                </p>
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                サービス代金
              </ons-col>
              <ons-col
                id="productDetailModalPrice"
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >¥</ons-col
              >
              <input type="hidden" id="productDetailModalPriceHidden" />
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                ポイント使用
              </ons-col>
              <ons-col
                id=""
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
              >
                <ons-input
                  id="productDetailModalMyPoint"
                  value=""
                  type="tel"
                  placeholder="0"
                ></ons-input>
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                売上金を利用
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
              >
                <ons-input
                  id="productDetailModalMyUriage"
                  value=""
                  type="tel"
                  placeholder="0"
                ></ons-input>
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                支払い方法
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >カード払い</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                支払い金額
              </ons-col>
              <ons-col
                id="productDetailModalShiharai"
                width="50%"
                vertical-align="center"
                style="font-size:1.2em;font-weight: bold;text-align: right;padding-right:0.5em;"
                >¥0</ons-col
              >
              <input type="hidden" id="productDetailModalShiharaiHidden" />
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                通話手段
              </ons-col>
              <ons-col
                id="productDetailModalHowToTalk"
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >Zoom</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col
                width="100%"
                vertical-align="center"
                style="text-align: center;"
              >
                <ons-button
                  class="large-button-orange"
                  style="padding-left:2em;padding-right:2em;"
                  onclick="negotiationCreate();hideProductDetailModal();"
                  >購入する</ons-button
                >
              </ons-col>
            </ons-row>
          </ons-list-item>
        </ons-list>
      </ons-card>
    </div>
  </ons-modal>
  <ons-modal id="productDetailReportModal" direction="up">
    <div style="text-align: center">
      <ons-card>
        <ons-list style="background-image: none;">
          <ons-list-item>
            <ons-row>
              <ons-col>
                <p style="text-align: center;font-size:1.2em;">
                  <span
                    style="float:right;padding-right:0.5em;"
                    onclick="hideProductDetailReportModal()"
                    ><i class="fas fa-times"></i
                  ></span>
                </p>
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col>
                <p style="text-align: center;font-size:0.9em;">
                  <textarea
                    id="reportComment"
                    class="textarea textarea--transparent"
                    rows="10"
                    placeholder="報告内容を出来るだけ細かく記入してください。"
                  ></textarea>
                </p>
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col
                width="100%"
                vertical-align="center"
                style="text-align: center;"
              >
                <ons-button
                  class="large-button-orange"
                  style="padding-left:2em;padding-right:2em;margin-top:1rem;"
                  onclick="productReport();"
                  >通報する</ons-button
                >
              </ons-col>
            </ons-row>
          </ons-list-item>
        </ons-list>
      </ons-card>
    </div>
  </ons-modal>
  <input type="hidden" id="productDetailId" />
  <input type="hidden" id="productDetailproductUserId" />
  <script>
    setTimeout(function() {
      let productDetailPage = document.querySelector("#productDetailPage");
      original_main_height = productDetailPage.clientHeight;
    }, 100);
    setTimeout(function() {
      productInfo($("#productDetailId").val());
    }, 500);
    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#productDetailPage").animate(
        { height: original_main_height - event.keyboardHeight + "px" },
        100
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#productDetailPage").animate(
        { height: original_main_height + "px" },
        100
      );
    });

    function productReport() {
      showLoad();
      var productId = $("#productDetailId").val();
      var reportComment = $("#reportComment").val();
      if (reportComment.trim() == "") {
        ons.notification.alert({
          message: "報告内容が未入力です。"
        });
        hideLoad();
      } else {
        var user = firebase.auth().currentUser;
        var buyUserId = user.uid;
        db.collection("reports")
          .doc()
          .set(
            {
              productId: productId,
              reportUserId: user.uid,
              reportComment: reportComment,
              createTime: new Date()
            },
            { merge: true }
          )
          .then(function(userResult) {
            ons.notification.alert({
              message: "送信しました。"
            });
            $("#reportComment").val("");
            hideProductDetailReportModal();
            hideLoad();
          })
          .catch(function(error) {
            console.log(error);
            ons.notification.alert({
              message: "送信失敗しました。"
            });
            hideLoad();
          });
      }
    }

    $("#productDetailModalMyPoint").keyup(function() {
      // 選択されているvalue属性値を取り出す
      var point = $(this).val();
      var price = $("#productDetailModalPriceHidden").val();
      var uriage = $("#productDetailModalMyUriage").val();
      var buyPrice = price - point - uriage;
      $("#productDetailModalShiharaiHidden").val(buyPrice);
      $("#productDetailModalShiharai").html("¥" + buyPrice);
    });
    $("#productDetailModalMyUriage").keyup(function() {
      // 選択されているvalue属性値を取り出す
      var uriage = $(this).val();
      var price = $("#productDetailModalPriceHidden").val();
      var point = $("#productDetailModalMyPoint").val();
      var buyPrice = price - point - uriage;
      $("#productDetailModalShiharaiHidden").val(buyPrice);
      $("#productDetailModalShiharai").html("¥" + buyPrice);
    });
    function negotiationCreate() {
      var uriage = $("#productDetailModalMyUriage").val();
      var point = $("#productDetailModalMyPoint").val();
      var shiharai = $("#productDetailModalShiharaiHidden").val();

      if ($.isNumeric(uriage) && $.isNumeric(point) && $.isNumeric(shiharai)) {
        if (uriage < 0 || point < 0) {
          ons.notification.alert({
            message: "0位上の数字を入力してください"
          });
        } else if (shiharai < 50) {
          ons.notification.alert({
            message: "決済システムの仕様上50円以上の決済が必要になります。"
          });
        } else {
          var user = firebase.auth().currentUser;
          var buyUserId = user.uid;
          db.collection("users")
            .doc(buyUserId)
            .get()
            .then(function(userResult) {
              var uriagenow = userResult.data().uriagenow;
              var pointnow = userResult.data().point;

              if (uriage > uriagenow) {
                ons.notification.alert({
                  message: "売上金を超える数字は設定できません"
                });
              } else if (point > pointnow) {
                ons.notification.alert({
                  message: "所持ポイントを超える数字は設定できません"
                });
              } else {
                var productId = $("#productDetailId").val();
                var mailaddress = user.email;
                db.collection("products")
                  .doc(productId)
                  .get()
                  .then(function(result) {
                    var productUserId = result.data().userId;
                    var createTime = new Date();

                    window.open(
                      "https://www.knowledgecampus.info/KCpayButton.html?mailaddress=" +
                        mailaddress +
                        "&buyUserId=" +
                        buyUserId +
                        "&productId=" +
                        productId +
                        "&buyPrice=" +
                        shiharai +
                        "&productUserId=" +
                        productUserId +
                        "&createTime=" +
                        createTime +
                        "&uriage=" +
                        uriage +
                        "&point=" +
                        point,
                      "_system",
                      "location=yes"
                    );
                  });
              }
            })
            .catch(function(error) {
              console.log(error);
            });
        }
      } else {
        ons.notification.alert({
          message: "数字を入力してください"
        });
      }
    }
    function favoCheck() {
      showLoad();
      var productId = $("#productDetailId").val();
      var user = firebase.auth().currentUser;
      var myUserId = user.uid;
      db.collection("products")
        .doc(productId)
        .get()
        .then(function(result) {
          var productUserId = result.data().userId;
          if (myUserId == productUserId) {
            ons.notification.alert({
              title: "注意",
              message: "自分の商品にいいねはできません"
            });
            var myProduct = true;
          } else {
            var myProduct = false;
          }
          return myProduct;
        })
        .then(function(myProduct) {
          if (myProduct == true) return;
          db.collection("favorite")
            .where("favoUserId", "==", myUserId)
            .where("productId", "==", productId)
            .get()
            .then(function(result) {
              if (result.size > 0) {
                // いいね解除した
                result.forEach(result => {
                  var favoDocId = result.id;
                  db.collection("favorite")
                    .doc(favoDocId)
                    .delete()
                    .then(function() {
                      hideLoad();
                      $(".fa-heart").removeClass("favoOn");
                      var favoCount = Number($("#favoCount").html()) - 1;
                      $("#favoCount").html(favoCount);
                      ons.notification.alert({
                        title: "解除",
                        message: "いいね解除しました"
                      });
                    })
                    .catch(function(error) {
                      console.log(error);
                      hideLoad();
                    });
                });
              } else {
                //いいねする
                db.collection("favorite")
                  .doc()
                  .set(
                    {
                      favoUserId: myUserId,
                      productId: productId,
                      createTime: new Date()
                    },
                    { merge: true }
                  )
                  .then(function(result) {
                    $(".fa-heart").addClass("favoOn");
                    var favoCount = Number($("#favoCount").html()) + 1;
                    $("#favoCount").html(favoCount);
                    var userName = user.data().username;
                    var productUserId = $("#productDetailproductUserId").val();
                    var push = new ncmb.Push();

                    push
                      .set("immediateDeliveryFlag", true)
                      .set("message", userName + "さんからいいねされました。")
                      .set("target", ["ios", "android"])
                      .set("searchCondition", {
                        userId: productUserId
                      })
                      .send();
                    db.collection("notifications")
                      .doc()
                      .set(
                        {
                          sendUserId: user.uid,
                          catchUserId: productUserId,
                          createTime: new Date(),
                          message: userName + "さんからいいねされました。",
                          readStatus: "Unread",
                          pushKind: "comment",
                          productId: productId,
                          buyUserId: "",
                          productUserId: ""
                        },
                        { merge: true }
                      );
                    hideLoad();
                  })
                  .catch(function(error) {
                    console.log(error);
                    hideLoad();
                  });
              }
            })
            .catch(function(error) {
              console.log(error);
              hideLoad();
            });
        });
    }

    function showProductDetailModal() {
      var modal = document.querySelector("#productDetailModal");
      modal.show();
    }

    function hideProductDetailModal() {
      var modal = document.querySelector("#productDetailModal");
      modal.hide();
    }

    function showProductDetailReportModal() {
      var modal = document.querySelector("#productDetailReportModal");
      modal.show();
    }

    function hideProductDetailReportModal() {
      var modal = document.querySelector("#productDetailReportModal");
      modal.hide();
    }

    function productInfo(docId) {
      showLoad();

      var docRef = db.collection("products").doc(docId);

      docRef
        .get()
        .then(function(doc) {
          // 商品情報取得
          var explanation = doc.data().explanation;
          $("#productDetailTitle").html(doc.data().title);
          $("#productDetailExplanation").html(
            explanation.replace(/<5060>/g, "<br>")
          );
          $("#productDetailHowToTalk").html(
            "通話手段: " + doc.data().howtotalk
          );
          $("#productDetailPriceTime").html(
            "¥" + doc.data().price + "/" + doc.data().time
          );
          $("#productDetailModalHowToTalk").html(doc.data().howtotalk);
          if (doc.data().howtotalk == "その他") {
            $("#productDetailModalHowToTalk").append(doc.data().howtotalkother);
          }
          $("#productDetailModalPrice").html("¥" + doc.data().price);
          $("#productDetailModalPriceHidden").val(doc.data().price);
          $("#productDetailModalHowToTalk").html(doc.data().howtotalk);
          var productData = doc.data();
          return productData;
        })
        .then(function(productData) {
          // ユーザー情報取得
          var docRef = db.collection("users").doc(productData.userId);
          $("#productDetailproductUserId").val(productData.userId);
          $("#productUserInfomation").click(function() {
            otherPageJump(productData.userId);
          });
          var price = productData.price;
          docRef.get().then(function(doc) {
            $("#productDetailUserName").html(doc.data().username);
            $("#productDetailText").html(doc.data().text);

            var user = firebase.auth().currentUser;
            var myUserId = user.uid;
            db.collection("users")
              .doc(myUserId)
              .get()
              .then(function(myResult) {
                var uriagenow = myResult.data().uriagenow;
                var pointnow = myResult.data().point;
                $("#productDetailMyPoint").html(
                  pointnow + "P/¥" + uriagenow + "持っています"
                );
                if (pointnow == 0 && uriagenow == 0) {
                  $("#productDetailMyPoint").css("background", "red");
                } else {
                  $("#productDetailMyPoint").css("background", "#0799d7");
                }
                if (price - pointnow < 50) {
                  $("#productDetailModalMyPoint").val(price - 50);
                  $("#productDetailModalMyUriage").val(0);
                  $("#productDetailModalShiharai").html("¥50");
                  $("#productDetailModalShiharaiHidden").val(50);
                } else {
                  $("#productDetailModalMyPoint").val(pointnow);
                  if (price - pointnow - uriagenow < 50) {
                    $("#productDetailModalMyUriage").val(price - pointnow - 50);
                    $("#productDetailModalShiharai").html("¥50");
                    $("#productDetailModalShiharaiHidden").val(50);
                  } else {
                    $("#productDetailModalMyUriage").val(uriagenow);
                    $("#productDetailModalShiharai").html(
                      "¥" + (price - pointnow - uriagenow)
                    );
                    $("#productDetailModalShiharaiHidden").val(
                      price - pointnow - uriagenow
                    );
                  }
                }
              });
            // ユーザー写真取得
            ref = firebase
              .storage()
              .ref()
              .child("profilePicture/" + productData.userId);
            ref
              .getDownloadURL()
              .then(url => {
                return url;
              })
              .catch(function() {
                var url = "img/userSampleImageMan.png";
                return url;
              })
              .then(function(url) {
                document.getElementById("productDetailUserImage").src = url;
              });
          });
          return productData;
        })
        .then(function(productData) {
          var user = firebase.auth().currentUser;
          var myUserId = user.uid;
          reviewControl(productData.userId).then(function(result) {
            $("#productDetailUserReview").empty();
            for (var i = 1; i < 6; i++) {
              if (i > result[1]) {
                var star =
                  '<img src="img/starOff.png" alt="" style="height:18px;margin-right:3px;"/>';
              } else {
                var star =
                  '<img src="img/starOn.png" alt=""style="height:18px;margin-right:3px;"/>';
              }
              $("#productDetailUserReview").append(star);
            }
            $("#productDetailUserReview").append("(" + result[0] + ")");
          });
          if (myUserId == productData.userId) {
            $("#reportButton").hide();
            $("#productDetailButton").html("変更");
            document.getElementById(
              "productDetailButton"
            ).onclick = new Function(
              "myProductEdit('" +
                JSON.stringify(productData) +
                "','" +
                docId +
                "');"
            );
          } else {
            db.collection("negotiations")
              // .doc(docId)
              .where("productId", "==", docId)
              .where("buyUserId", "==", myUserId)
              .where("productUserId", "==", productData.userId)
              .get()
              .then(function(negoNowResults) {
                if (negoNowResults.size > 0) {
                  negoNowResults.forEach(negoNowResult => {
                    $("#productDetailButton").html(negoNowResult.data().status);
                    document.getElementById(
                      "productDetailButton"
                    ).onclick = new Function(
                      "torihikiPageJump('" +
                        docId +
                        "','" +
                        myUserId +
                        "','" +
                        productData.userId +
                        "')"
                    );
                  });
                }
              })
              .catch(function(error) {
                hideLoad();
                console.log(error);
              });
          }
          return docId;
        })
        .then(function(productId) {
          $("#productDetailId").val(productId);
          var user = firebase.auth().currentUser;
          var myUserId = user.uid;
          db.collection("favorite")
            .where("productId", "==", productId)
            .where("favoUserId", "==", myUserId)
            .get()
            .then(function(result) {
              if (result.size > 0) {
                $(".fa-heart").addClass("favoOn");
              } else {
                $(".fa-heart").removeClass("favoOn");
              }
            });
          db.collection("favorite")
            .where("productId", "==", productId)
            .get()
            .then(function(result) {
              if (result.size > 0) {
                $("#favoCount").html(result.size);
              } else {
                $("#favoCount").html("0");
              }
            });
          db.collection("products")
            .doc(productId)
            .collection("comments")
            .get()
            .then(function(result) {
              if (result.size > 0) {
                $("#commentCount").html(result.size);
              } else {
                $("#commentCount").html("0");
              }
            });

          db.collection("negotiations")
            .where("productId", "==", productId)
            .get()
            .then(function(result) {
              if (result.size > 0) {
                $("#buyCount").html(result.size);
              } else {
                $("#buyCount").html("0");
              }
            });
          return productId;
        })
        .then(function(productId) {
          var nowDataCount = 0;
          $("#productDetailCommentZone").empty();
          db.collection("products")
            .doc(productId)
            .collection("comments")
            .orderBy("createTime", "desc")
            .limit(3)
            .get()
            .then(function(commentGetResults) {
              if (commentGetResults.size > 0) {
                commentGetResults.forEach(commentGetResult => {
                  nowDataCount++;
                  var commentlist = "";
                  commentlist =
                    `
                    <ons-list-item>
                      <div class="left">
                        <img
                          id="commentImageProduct_` +
                    nowDataCount +
                    `"
                          class="list-item__thumbnail"
                          src="img/userSampleImageMan.png"
                          style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                        />
                      </div>
                      <div class="center" style="width:50%;">
                        <span id="commentUserNameProduct_` +
                    nowDataCount +
                    `"class="list-item__title"></span>
                        <span class="list-item__subtitle">
                          <ons-card id="commentProduct_` +
                    nowDataCount +
                    `">
                          </ons-card>
                        </span>
                      </div>
                    </ons-list-item>
                  `;
                  if (nowDataCount < 4) {
                    $("#productDetailCommentZone").append(commentlist);
                    productDetailCommenIndicate(
                      commentGetResult.data().userId,
                      commentGetResult.data().comment,
                      commentGetResult.data().createTime,
                      nowDataCount
                    );
                  }
                });
                hideLoad();
              } else {
                hideLoad();
              }
            })
            .catch(function(error) {
              console.log(error);
              alert("コメント取得失敗");
              hideLoad();
            });
        })
        .catch(function(error) {
          hideLoad();
          console.log("Error getting document:", error);
        });
    }
    function productDetailCommenIndicate(
      commentUserId,
      comment,
      createTime,
      nowDataCount
    ) {
      //「月」を取得する
      var createTime = new Date(createTime * 1000);
      var MM = createTime.getMonth() + 1;
      //「日」を取得する
      var DD = createTime.getDate();
      //「時」を取得する
      var hh = createTime.getHours();
      //「分」を取得する
      var mm = createTime.getMinutes();
      if (hh < 10) {
        hh = "0" + hh;
      }
      if (mm < 10) {
        mm = "0" + mm;
      }
      var time = MM + "月" + DD + "日 " + hh + ":" + mm;

      var docRef = db.collection("users").doc(commentUserId);
      docRef
        .get()
        .then(function(doc) {
          var commentUserName = doc.data().username;
          firebase
            .storage()
            .ref()
            .child("profilePicture/" + commentUserId)
            .getDownloadURL()
            .then(function(url) {
              return url;
            })
            .catch(function() {
              url = "img/userSampleImageMan.png";
              return url;
            })
            .then(function(url) {
              $("#commentImageProduct_" + nowDataCount).attr("src", url);
              $("#commentImageProduct_" + nowDataCount).click(function() {
                otherPageJump(commentUserId);
              });
              $("#commentUserNameProduct_" + nowDataCount).html(
                commentUserName
              );
              $("#commentProduct_" + nowDataCount).html(
                comment +
                  `<br><br><span style="font-size:0.85em;margin-top:5px;"><i class="far fa-clock" style="margin-right:5px;"></i>` +
                  time +
                  `</span>`
              );
            })
            .catch(function(error) {
              console.log("Error getting document:", error);
              hideLoad();
            });
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
          hideLoad();
        });
    }

    function myProductEdit(productData, productDocumentUid) {
      var productData = JSON.parse(productData);
      myNavigator.bringPageTop("html/product/syuppinEditPage.html");

      document.addEventListener(
        "init",
        function(event) {
          if (event.target.matches("#syuppinEditPage")) {
            console.log(productData.explanation);
            $("#productDocumentUid").val(productDocumentUid);
            //初期値で入れておく
            $("#syuppinCategory1Edit").val(productData.category1);
            $("#syuppinCategory2Edit").val(productData.category2);
            $("#syuppinCategory3Edit").val(productData.category3);
            $("#syuppinTitleEdit").val(productData.title);
            $("#syuppinExplanationEdit").val(
              productData.explanation.replace(/<5060>/g, "\n")
            );
            $("#howToTalkEdit").val(productData.howtotalk);
            $("#howToTalkOtherEdit").val(productData.howtotalkother);
            $("#syuppinTimeEdit").val(productData.time);
            $("#syuppinPriceEdit").val(productData.price);
            if (productData.category3 == "") {
              $("#syuppinCategoryEdit").html(
                productData.category1 +
                  " ><br>" +
                  productData.category2 +
                  "&emsp;"
              );
            } else {
              $("#syuppinCategoryEdit").html(
                productData.category1 +
                  " ><br>" +
                  productData.category2 +
                  " ><br>" +
                  productData.category3 +
                  "&emsp;"
              );
            }
            riekiCalc();
          }
        },
        false
      );
    }
  </script>
</ons-page>
