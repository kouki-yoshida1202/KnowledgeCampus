<ons-page id="productDetailPage">
  <style>
    .productTitle .fa-heart,
    .productTitle .fa-comment-dots {
      margin-right: 0.5rem;
    }
    .productTitle .fa-comment-dots {
      margin-left: 1rem;
    }
    #productDetailPage ons-list p {
      margin-top: 0px;
      margin-bottom: 0px;
    }

    #productDetailComment ons-card {
      margin-left: 0px;
      margin-top: 0px;
    }
    #productDetailPage .list-item__center {
      background-image: none;
      padding-top: 5px;
      padding-bottom: 5px;
    }
    #productDetailComment {
      background-image: none;
      background-color: #eee;
    }

    #productDetailComment .list-item__title {
      font-size: 0.8em;
    }
  </style>
  <ons-toolbar>
    <div class="left" id="toolbar-title">
      <ons-back-button></ons-back-button>
    </div>
    <div class="center" id="toolbar-title"></div>
  </ons-toolbar>
  <ons-bottom-toolbar style="line-height: 35px;height:80px">
    <ons-row>
      <ons-col
        id="productDetailMyPoint"
        width="100%"
        style="text-align: center;font-size:0.9em;color:white;font-weight: bold;background: #0799d7;line-height: 25px;margin-bottom:5px;"
        vertical-align="center"
        >0ポイント持っています</ons-col
      >
    </ons-row>
    <ons-row>
      <ons-col
        id="productDetailPriceTime"
        width="50%"
        style="text-align: center;font-size:1.2em;"
        vertical-align="center"
        >¥/分</ons-col
      >
      <ons-col width="50%" style="text-align: center;" vertical-align="center">
        <ons-button
          id="productDetailButton"
          class="large-button-orange"
          style="padding:5px 2em;font-size:1.2em;"
          onclick="showProductDetailModal()"
          >購入</ons-button
        >
      </ons-col>
    </ons-row>
  </ons-bottom-toolbar>
  <div style="width:85%;margin:0 auto;margin-top:0px;">
    <div style="height:70px;text-align: center;margin-top:1.5rem;">
      <img
        id="productDetailUserImage"
        src="img/userSampleImageMan.png"
        alt=""
        style="width:70px;height:70px;object-fit:cover;border-radius: 50%;"
      />
    </div>
    <p
      id="productDetailUserName"
      style="text-align: center;margin-top:5px;margin-bottom:5px;"
    ></p>

    <div>
      <p
        id="productDetailUserReview"
        style="display:flex;justify-content: center; width:100%;margin-top:5px;margin-bottom:5px;"
      ></p>
    </div>
    <p id="productDetailText" class="navy" style="font-size:0.8em;"></p>
  </div>
  <div style="width:100%;margin:0 auto;margin-top:20px;margin-bottom:50px;">
    <ons-list-header>商品タイトル</ons-list-header>
    <ons-list-item class="productTitle">
      <ons-row id="productDetailTitle" style="font-weight: bold;"> </ons-row>
      <ons-row>
        <p style="margin-bottom:0px;">
          <i class="far fa-heart" onclick="favoCheck()"></i
          ><span id="favoCount">0</span>
          <i
            class="far fa-comment-dots"
            onclick="myNavigator.bringPageTop('html/product/productComment.html');"
          ></i
          ><span id="commentCount">0</span>
        </p>
      </ons-row>
    </ons-list-item>
    <ons-list-header>商品の説明</ons-list-header>
    <ons-list-item>
      <ons-row
        id="productDetailExplanation"
        style="font-size:0.8em;padding-right:0.25em;"
      >
      </ons-row>
    </ons-list-item>
    <ons-list-header>通話手段</ons-list-header>
    <ons-list-item>
      <ons-row id="productDetailHowToTalk"> </ons-row>
    </ons-list-item>
    <br />
    <ons-list id="productDetailComment" style="min-height: 200px;">
      <ons-list-header>
        <ons-row>
          <ons-col vertical-align="center">
            <i class="far fa-comment-dots" style="margin-right:0.3em;"></i
            >コメント
          </ons-col>
        </ons-row>
      </ons-list-header>
      <div id="productDetailCommentZone"></div>
      <ons-list-item>
        <ons-row style="padding:1em;">
          <ons-button
            class="large-button-gray"
            style="margin:0 auto;"
            onclick="myNavigator.bringPageTop('html/product/productComment.html');"
            >全てのコメントを見る</ons-button
          >
        </ons-row>
      </ons-list-item>
    </ons-list>
  </div>
  <ons-modal id="productDetailModal" direction="up">
    <div style="text-align: center">
      <ons-card>
        <ons-list style="background-image: none;">
          <ons-list-item>
            <ons-row>
              <ons-col>
                <p style="text-align: center;font-size:1.2em;">
                  購入手続き
                  <span
                    style="float:right;padding-right:0.5em;"
                    onclick="hideProductDetailModal()"
                    ><i class="fas fa-times"></i
                  ></span>
                </p>
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                サービス代金
              </ons-col>
              <ons-col
                id="productDetailModalPrice"
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >¥3000</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                ポイント使用
              </ons-col>
              <ons-col
                id="productDetailModalMyPoint"
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >500P</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                売上金を利用
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
              >
                売上があります >
              </ons-col>
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                支払い方法
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >カード払い ></ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                支払い金額
              </ons-col>
              <ons-col
                width="50%"
                vertical-align="center"
                style="font-size:1.2em;font-weight: bold;text-align: right;padding-right:0.5em;"
                >¥2500</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col width="50%" vertical-align="center">
                通話手段
              </ons-col>
              <ons-col
                id="productDetailModalHowToTalk"
                width="50%"
                vertical-align="center"
                style="text-align: right;padding-right:0.5em;"
                >Zoom</ons-col
              >
            </ons-row>
          </ons-list-item>
          <ons-list-item>
            <ons-row>
              <ons-col
                width="100%"
                vertical-align="center"
                style="text-align: center;"
              >
                <ons-button
                  class="large-button-orange"
                  style="padding-left:2em;padding-right:2em;"
                  onclick="negotiationCreate();hideProductDetailModal();"
                  >購入する</ons-button
                >
              </ons-col>
            </ons-row>
          </ons-list-item>
        </ons-list>
      </ons-card>
    </div>
  </ons-modal>
  <input type="hidden" id="productDetailId" />
  <script>
    document.addEventListener(
      "show",
      function(event) {
        if (event.target.matches("#productDetailPage")) {
          productInfo($("#productDetailId").val());
        }
      },
      false
    );
    function negotiationCreate() {
      var productId = $("#productDetailId").val();
      var user = firebase.auth().currentUser;
      var buyUserId = user.uid;
      var mailaddress = user.email;
      db.collection("products")
        .doc(productId)
        .get()
        .then(function(result) {
          var buyPrice = result.data().price;
          var productUserId = result.data().userId;
          var createTime = new Date();
          window.open(
            "https://knowledgecampus.info/KCpayButton.html?mailaddress=" +
              mailaddress +
              "&buyUserId=" +
              buyUserId +
              "&productId=" +
              productId +
              "&buyPrice=" +
              buyPrice +
              "&productUserId=" +
              productUserId +
              "&createTime=" +
              createTime,
            "_system",
            "location=yes"
          );
        });
    }
    function favoCheck() {
      showLoad();
      var productId = $("#productDetailId").val();
      var user = firebase.auth().currentUser;
      var myUserId = user.uid;
      db.collection("products")
        .doc(productId)
        .get()
        .then(function(result) {
          var productUserId = result.data().userId;
          if (myUserId == productUserId) {
            ons.notification.alert({
              title: "注意",
              message: "自分の商品にいいねはできません"
            });
            var myProduct = true;
          } else {
            var myProduct = false;
          }
          return myProduct;
        })
        .then(function(myProduct) {
          if (myProduct == true) return;
          db.collection("favorite")
            .where("favoUserId", "==", myUserId)
            .where("productId", "==", productId)
            .get()
            .then(function(result) {
              if (result.size > 0) {
                // いいね解除した
                result.forEach(result => {
                  var favoDocId = result.id;
                  db.collection("favorite")
                    .doc(favoDocId)
                    .delete()
                    .then(function() {
                      hideLoad();
                      $(".fa-heart").removeClass("favoOn");
                      var favoCount = Number($("#favoCount").html()) - 1;
                      $("#favoCount").html(favoCount);
                      ons.notification.alert({
                        title: "解除",
                        message: "いいね解除しました"
                      });
                    })
                    .catch(function(error) {
                      console.log(error);
                      hideLoad();
                    });
                });
              } else {
                //いいねする
                db.collection("favorite")
                  .doc()
                  .set(
                    {
                      favoUserId: myUserId,
                      productId: productId,
                      createTime: new Date()
                    },
                    { merge: true }
                  )
                  .then(function(result) {
                    $(".fa-heart").addClass("favoOn");
                    var favoCount = Number($("#favoCount").html()) + 1;
                    $("#favoCount").html(favoCount);
                    hideLoad();
                  })
                  .catch(function(error) {
                    console.log(error);
                    hideLoad();
                  });
              }
            })
            .catch(function(error) {
              console.log(error);
              hideLoad();
            });
        });
    }

    function showProductDetailModal() {
      var modal = document.querySelector("#productDetailModal");
      modal.show();
    }

    function hideProductDetailModal() {
      var modal = document.querySelector("#productDetailModal");
      modal.hide();
    }

    function productInfo(docId) {
      showLoad();

      var docRef = db.collection("products").doc(docId);

      docRef
        .get()
        .then(function(doc) {
          // 商品情報取得
          $("#productDetailTitle").html(doc.data().title);
          $("#productDetailExplanation").html(doc.data().explanation);
          $("#productDetailHowToTalk").html(doc.data().howtotalk);
          $("#productDetailPriceTime").html(
            "¥" + doc.data().price + "/" + doc.data().time
          );
          $("#productDetailModalHowToTalk").html(doc.data().howtotalk);
          if (doc.data().howtotalk == "その他") {
            $("#productDetailModalHowToTalk").append(doc.data().howtotalkother);
          }
          $("#productDetailModalPrice").html(doc.data().price);
          var productData = doc.data();
          return productData;
        })
        .then(function(productData) {
          // ユーザー情報取得
          var docRef = db.collection("users").doc(productData.userId);

          docRef.get().then(function(doc) {
            $("#productDetailUserName").html(doc.data().username);
            $("#productDetailText").html(doc.data().text);
            $("#productDetailMyPoint").html(
              doc.data().point + "ポイント持っています"
            );
            // ユーザー写真取得
            ref = firebase
              .storage()
              .ref()
              .child("profilePicture/" + productData.userId);
            ref
              .getDownloadURL()
              .then(url => {
                return url;
              })
              .catch(function() {
                var url = "img/userSampleImageMan.png";
                return url;
              })
              .then(function(url) {
                document.getElementById("productDetailUserImage").src = url;
              });
          });
          return productData;
        })
        .then(function(productData) {
          var user = firebase.auth().currentUser;
          var myUserId = user.uid;
          reviewControl(productData.userId).then(function(result) {
            $("#productDetailUserReview").empty();
            for (var i = 1; i < 6; i++) {
              if (i > result[1]) {
                var star =
                  '<img src="img/starOff.png" alt="" style="height:18px;margin-right:3px;"/>';
              } else {
                var star =
                  '<img src="img/starOn.png" alt=""style="height:18px;margin-right:3px;"/>';
              }
              $("#productDetailUserReview").append(star);
            }
            $("#productDetailUserReview").append("(" + result[0] + ")");
          });
          if (myUserId == productData.userId) {
            $("#productDetailButton").html("変更");
            document.getElementById(
              "productDetailButton"
            ).onclick = new Function(
              "myProductEdit('" +
                JSON.stringify(productData) +
                "','" +
                docId +
                "');"
            );
          } else {
            db.collection("negotiations")
              // .doc(docId)
              .where("productId", "==", docId)
              .where("buyUserId", "==", myUserId)
              .where("productUserId", "==", productData.userId)
              .get()
              .then(function(negoNowResults) {
                if (negoNowResults.size > 0) {
                  negoNowResults.forEach(negoNowResult => {
                    $("#productDetailButton").html(negoNowResult.data().status);
                    document.getElementById(
                      "productDetailButton"
                    ).onclick = new Function(
                      "torihikiPageJump('" +
                        docId +
                        "','" +
                        myUserId +
                        "','" +
                        productData.userId +
                        "')"
                    );
                  });
                }
              })
              .catch(function(error) {
                hideLoad();
                console.log(error);
              });
          }
          return docId;
        })
        .then(function(productId) {
          $("#productDetailId").val(productId);
          var user = firebase.auth().currentUser;
          var myUserId = user.uid;
          db.collection("favorite")
            .where("productId", "==", productId)
            .where("favoUserId", "==", myUserId)
            .get()
            .then(function(result) {
              if (result.size > 0) {
                $(".fa-heart").addClass("favoOn");
              } else {
                $(".fa-heart").removeClass("favoOn");
              }
            });
          db.collection("favorite")
            .where("productId", "==", productId)
            .get()
            .then(function(result) {
              if (result.size > 0) {
                $("#favoCount").html(result.size);
              } else {
                $("#favoCount").html("0");
              }
            });
          db.collection("products")
            .doc(productId)
            .collection("comments")
            .get()
            .then(function(result) {
              if (result.size > 0) {
                $("#commentCount").html(result.size);
              } else {
                $("#commentCount").html("0");
              }
            });

          return productId;
        })
        .then(function(productId) {
          var nowDataCount = 0;
          $("#productDetailCommentZone").empty();
          db.collection("products")
            .doc(productId)
            .collection("comments")
            .orderBy("createTime", "desc")
            .limit(3)
            .get()
            .then(function(commentGetResults) {
              if (commentGetResults.size > 0) {
                commentGetResults.forEach(commentGetResult => {
                  nowDataCount++;
                  var commentlist = "";
                  commentlist =
                    `
                    <ons-list-item>
                      <div class="left">
                        <img
                          id="commentImageProduct_` +
                    nowDataCount +
                    `"
                          class="list-item__thumbnail"
                          src="img/userSampleImageMan.png"
                          style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                        />
                      </div>
                      <div class="center" style="width:50%;">
                        <span id="commentUserNameProduct_` +
                    nowDataCount +
                    `"class="list-item__title"></span>
                        <span class="list-item__subtitle">
                          <ons-card id="commentProduct_` +
                    nowDataCount +
                    `">
                          </ons-card>
                        </span>
                      </div>
                    </ons-list-item>
                  `;
                  $("#productDetailCommentZone").append(commentlist);
                  productDetailCommenIndicate(
                    commentGetResult.data().userId,
                    commentGetResult.data().comment,
                    commentGetResult.data().createTime,
                    nowDataCount
                  );
                });
                hideLoad();
              } else {
                hideLoad();
              }
            })
            .catch(function(error) {
              console.log(error);
              alert("コメント取得失敗");
              hideLoad();
            });
        })
        .catch(function(error) {
          hideLoad();
          console.log("Error getting document:", error);
        });
    }
    function productDetailCommenIndicate(
      commentUserId,
      comment,
      createTime,
      nowDataCount
    ) {
      //「月」を取得する
      var createTime = new Date(createTime * 1000);
      var MM = createTime.getMonth() + 1;
      //「日」を取得する
      var DD = createTime.getDate();
      //「時」を取得する
      var hh = createTime.getHours();
      //「分」を取得する
      var mm = createTime.getMinutes();
      var time = MM + "月" + DD + "日 " + hh + ":" + mm;

      var docRef = db.collection("users").doc(commentUserId);
      docRef
        .get()
        .then(function(doc) {
          var commentUserName = doc.data().username;
          firebase
            .storage()
            .ref()
            .child("profilePicture/" + commentUserId)
            .getDownloadURL()
            .then(function(url) {
              return url;
            })
            .catch(function() {
              url = "img/userSampleImageMan.png";
              return url;
            })
            .then(function(url) {
              $("#commentImageProduct_" + nowDataCount).attr("src", url);
              $("#commentUserNameProduct_" + nowDataCount).html(
                commentUserName
              );
              $("#commentProduct_" + nowDataCount).html(
                comment +
                  `<br><br><span style="font-size:0.85em;margin-top:5px;"><i class="far fa-clock" style="margin-right:5px;"></i>` +
                  time +
                  `</span>`
              );
            })
            .catch(function(error) {
              console.log("Error getting document:", error);
              hideLoad();
            });
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
          hideLoad();
        });
    }

    function myProductEdit(productData, productDocumentUid) {
      var productData = JSON.parse(productData);
      myNavigator.bringPageTop("html/product/syuppinEditPage.html");

      document.addEventListener(
        "init",
        function(event) {
          if (event.target.matches("#syuppinEditPage")) {
            $("#productDocumentUid").val(productDocumentUid);
            //初期値で入れておく
            $("#syuppinCategory1Edit").val(productData.category1);
            $("#syuppinCategory2Edit").val(productData.category2);
            $("#syuppinCategory3Edit").val(productData.category3);
            $("#syuppinTitleEdit").val(productData.title);
            $("#syuppinExplanationEdit").val(productData.explanation);
            $("#howToTalkEdit").val(productData.howtotalk);
            $("#howToTalkOtherEdit").val(productData.howtotalkother);
            $("#syuppinTimeEdit").val(productData.time);
            $("#syuppinPriceEdit").val(productData.price);
            if (productData.category3 == "") {
              $("#syuppinCategoryEdit").html(
                productData.category1 +
                  " ><br>" +
                  productData.category2 +
                  "&emsp;"
              );
            } else {
              $("#syuppinCategoryEdit").html(
                productData.category1 +
                  " ><br>" +
                  productData.category2 +
                  " ><br>" +
                  productData.category3 +
                  "&emsp;"
              );
            }
            riekiCalc();
          }
        },
        false
      );
    }
  </script>
</ons-page>
