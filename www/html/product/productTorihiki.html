<ons-page id="productTorihikiPage">
  <style>
    .hyouka {
      display: -ms-flex;
      display: -webkit-flex;
      display: -moz-flex;
      display: -o-flex;
      display: flex;
      margin: 0 auto;

      flex-direction: -ms-row-reverse;
      flex-direction: -webkit-row-reverse;
      flex-direction: -moz-row-reverse;
      flex-direction: -o-row-reverse;
      flex-direction: row-reverse;

      justify-content: -ms-right;
      justify-content: -webkit-right;
      justify-content: -moz-right;
      justify-content: -o-right;
      justify-content: right;
    }
    .hyouka input[type="radio"] {
      display: none;
    }
    .hyouka input[type="radio"] {
      display: none;
    }
    .hyouka label {
      position: relative;
      padding: 10px 0px 20px 0px;
      color: #bbb;
      cursor: pointer;
      font-size: 30px;
    }

    .hyouka label:hover,
    .hyouka label:hover ~ label,
    .hyouka input[type="radio"]:checked ~ label {
      color: #ffd43b;
    }
    #productTorihikiComment {
      background-image: none;
      background-color: #eee;
      padding-bottom: 50px;
    }

    #productTorihikiPage ons-list p {
      margin-top: 0px;
      margin-bottom: 0px;
    }

    #productTorihikiComment ons-card {
      margin-left: 0px;
      margin-top: 0px;
    }

    #productTorihikiComment .list-item__title {
      font-size: 0.8em;
    }
    #productTorihikiPage .list-item__center {
      background-image: none;
      padding-top: 5px;
      padding-bottom: 5px;
    }

    #productTorihikiPage ons-list-header {
      font-size: 0.9em;
      padding-top: 0.25em;
      padding-bottom: 0.25em;
    }
  </style>
  <ons-toolbar>
    <div class="left" id="toolbar-title">
      <ons-back-button></ons-back-button>
    </div>
    <div class="center" id="toolbar-title">取引画面</div>
  </ons-toolbar>
  <ons-bottom-toolbar style="line-height: 35px;height:80px">
    <ons-row style="padding-top:5px;">
      <ons-col
        width="80%"
        style="text-align: center;font-size:1.0em;"
        vertical-align="center"
      >
        <ons-input
          id="torihikiCommentInput"
          style="background-color: #efeff4;width:90%;"
          placeholder="コメント入力欄"
        >
        </ons-input>
      </ons-col>
      <ons-col width="20%" style="text-align: center;" vertical-align="center">
        <ons-button
          class="large-button-orange"
          style="font-size:1.0em;"
          onclick="torihikiSubmit()"
          >送信
        </ons-button>
      </ons-col>
    </ons-row>
  </ons-bottom-toolbar>
  <div class="content">
    <ons-list>
      <ons-list-header>
        評価
      </ons-list-header>
      <ons-list-item>
        <ons-row style="position: relative;">
          <div class="hyouka">
            <input id="hoshi1" type="radio" name="hoshi" value="5" />
            <label for="hoshi1">★</label>
            <input id="hoshi2" type="radio" name="hoshi" value="4" />
            <label for="hoshi2">★</label>
            <input id="hoshi3" type="radio" name="hoshi" value="3" />
            <label for="hoshi3">★</label>
            <input id="hoshi4" type="radio" name="hoshi" value="2" />
            <label for="hoshi4">★</label>
            <input id="hoshi5" type="radio" name="hoshi" value="1" />
            <label for="hoshi5">★</label>
          </div>
        </ons-row>
        <ons-row>
          <ons-col vertical-align="center" style="text-align: left;">
            コメント
          </ons-col>
        </ons-row>
        <ons-row>
          <ons-col vertical-align="center">
            <textarea
              id="reviewComment"
              class="textarea textarea--transparent"
              rows="5"
              placeholder=""
            ></textarea>
          </ons-col>
        </ons-row>
        <ons-row>
          <ons-button
            id="reviewSubmitButton"
            onclick="reviewSubmit()"
            modifier="large"
            class="large-button-orange"
            style="margin-top:1em;margin-bottom:1em;"
            >評価する</ons-button
          >
        </ons-row>
      </ons-list-item>
      <ons-list id="productTorihikiComment">
        <ons-list-header>
          トーク画面
        </ons-list-header>
        <div id="torihikiCommentList"></div>
      </ons-list>
    </ons-list>
  </div>
  <input type="hidden" id="torihikiPageProductId" />
  <input type="hidden" id="torihikiPageProductUserId" />
  <input type="hidden" id="torihikiPageNagotiationId" />
  <input type="hidden" id="nowDataCountInput" />
  <script>
    document.addEventListener(
      "destroy",
      function(event) {
        if (event.target.matches("#productTorihikiPage")) {
          giftDetailJump($("#torihikiPageProductId").val());
        }
      },
      false
    );
    setTimeout(function() {
      $("#torihikiPageProductId").val($("#productDetailId").val());
      torihikiIndicate();
      let productTorihikiPage = document.querySelector("#productTorihikiPage");
      original_main_height = productTorihikiPage.clientHeight;
    }, 100);

    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#productTorihikiPage").animate(
        { height: original_main_height - event.keyboardHeight + "px" },
        250
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#productTorihikiPage").animate(
        { height: original_main_height + "px" },
        250
      );
    });

    function reviewSubmit() {
      var reviewComment = $("#reviewComment").val();
      var reviewCount = $("input[name=hoshi]:checked").val();
      console.log(reviewComment);
      console.log(reviewCount);
      showLoad();
      var productId = $("#torihikiPageProductId").val();
      var negotiationId = $("#torihikiPageNagotiationId").val();
      var productUserId = $("#torihikiPageProductUserId").val();
      var user = firebase.auth().currentUser;
      var userId = user.uid;
      var createTime = new Date();

      db.collection("users")
        .doc(productUserId)
        .collection("reviews")
        .doc()
        .set(
          {
            createTime: new Date(),
            reviewComment: reviewComment,
            reviewCount: reviewCount,
            negotiationId: negotiationId
          },
          { merge: true }
        )
        .then(function() {
          console.log("success");
          hideLoad();
          $("#reviewComment").attr("readonly", true);
          $("#reviewSubmitButton").html("評価済み");
          $("#reviewSubmitButton")
            .removeClass("large-button-orange")
            .addClass("large-button-gray");
          $("input[name=hoshi]").prop("disabled", true);
        })
        .then(function() {
          db.collection("negotiations")
            .doc(negotiationId)
            .set(
              {
                status: "取引完了"
              },
              { merge: true }
            );
          ons.notification.alert({
            message: "取引評価が完了しました。"
          });
        })
        .catch(function(error) {
          console.log(error);
          hideLoad();
        });
    }

    function torihikiSubmit() {
      var commentInput = $("#torihikiCommentInput").val();
      if (commentInput == "") {
        ons.notification.alert({
          message: "コメントが未入力です"
        });
      } else {
        showLoad();
        var productId = $("#torihikiPageProductId").val();
        var negotiationId = $("#torihikiPageNagotiationId").val();
        var user = firebase.auth().currentUser;
        var userId = user.uid;
        var createTime = new Date();
        db.collection("negotiations")
          .doc(negotiationId)
          .collection("comments")
          .doc()
          .set(
            {
              comment: commentInput,
              createTime: createTime,
              userId: userId
            },
            { merge: true }
          )
          .then(docRef => {
            var createTime = firebase.firestore.Timestamp.fromDate(new Date());
            $("#torihikiCommentInput").val("");
            var nowDataCount = $("#nowDataCountInput").val() + 1;
            var commentlist = "";
            commentlist =
              `
                <ons-list-item>
                  <div class="left">
                    <img
                      id="torihikiCommentImage_` +
              nowDataCount +
              `"
                      class="list-item__thumbnail"
                      src="img/userSampleImageMan.png"
                      style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                    />
                  </div>
                  <div class="center" style="width:50%;">
                    <span id="torihikiCommentUserName_` +
              nowDataCount +
              `"class="list-item__title"></span>
                    <span class="list-item__subtitle">
                      <ons-card id="torihikiComment_` +
              nowDataCount +
              `">
                      </ons-card>
                    </span>
                  </div>
                </ons-list-item>
              `;
            $("#torihikiCommentList").prepend(commentlist);
            torihikiCommentIndicate(
              userId,
              commentInput,
              nowDataCount,
              nowDataCount,
              createTime
            );
          })
          .catch(function(error) {
            console.log(error);
            alert("コメント失敗");
          });
      }
    }
    function torihikiIndicate() {
      showLoad();
      var nowDataCount = 0;
      $("#torihikiCommentList").empty();
      var productId = $("#torihikiPageProductId").val();
      var user = firebase.auth().currentUser;
      var buyUserId = user.uid;

      db.collection("negotiations")
        .where("productId", "==", productId)
        .where("buyUserId", "==", buyUserId)
        .get()
        .then(function(negoResult) {
          if (negoResult.size > 0) {
            negoResult.forEach(nego => {
              $("#torihikiPageNagotiationId").val(nego.id);
              $("#torihikiPageProductUserId").val(nego.data().productUserId);
              if (nego.data().status == "取引完了") {
                var productUserId = nego.data().productUserId;
                var negotiationId = nego.id;
                console.log(productUserId, negotiationId);
                db.collection("users")
                  .doc(productUserId)
                  .collection("reviews")
                  .where("negotiationId", "==", negotiationId)
                  .get()
                  .then(function(reviewDetails) {
                    console.log(reviewDetails);
                    reviewDetails.forEach(reviewDetail => {
                      var reviewComment = reviewDetail.data().reviewComment;
                      var reviewCount = reviewDetail.data().reviewCount;
                      var reviewDate = reviewDetail.data().createTime;
                      $("#reviewComment").val(reviewComment);
                      $("input[name=hoshi]").val([reviewCount]);
                      $("#reviewComment").attr("readonly", true);
                      $("#reviewSubmitButton").html("評価済み");
                      $("#reviewSubmitButton")
                        .removeClass("large-button-orange")
                        .addClass("large-button-gray");
                      $("input[name=hoshi]").prop("disabled", true);
                    });
                  });
                db.collection("negotiations")
                  .doc(negotiationId)
                  .collection("comments")
                  .orderBy("createTime", "asc")
                  .get()
                  .then(function(torihikiComments) {
                    if (torihikiComments.size > 0) {
                      torihikiComments.forEach(torihikiComment => {
                        nowDataCount++;
                        var commentlist = "";
                        commentlist =
                          `
                          <ons-list-item>
                            <div class="left">
                              <img
                                id="torihikiCommentImage_` +
                          nowDataCount +
                          `"
                                class="list-item__thumbnail"
                                src="img/userSampleImageMan.png"
                                style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                              />
                            </div>
                            <div class="center" style="width:50%;">
                              <span id="torihikiCommentUserName_` +
                          nowDataCount +
                          `"class="list-item__title"></span>
                              <span class="list-item__subtitle">
                                <ons-card id="torihikiComment_` +
                          nowDataCount +
                          `">
                                </ons-card>
                              </span>
                            </div>
                          </ons-list-item>
                        `;
                        $("#torihikiCommentList").prepend(commentlist);
                        torihikiCommentIndicate(
                          torihikiComment.data().userId,
                          torihikiComment.data().comment,
                          nowDataCount,
                          torihikiComments.size,
                          torihikiComment.data().createTime
                        );
                      });
                    } else {
                      hideLoad();
                    }
                  })
                  .catch(function(error) {
                    console.log(error);
                    alert("コメント取得失敗");
                    hideLoad();
                  });
              }
            });
          }
        });
    }
    function torihikiCommentIndicate(
      commentUserId,
      comment,
      nowDataCount,
      size,
      createTime
    ) {
      //「月」を取得する
      var createTime = new Date(createTime * 1000);
      var MM = createTime.getMonth() + 1;
      //「日」を取得する
      var DD = createTime.getDate();
      //「時」を取得する
      var hh = createTime.getHours();
      //「分」を取得する
      var mm = createTime.getMinutes();
      var time = MM + "月" + DD + "日 " + hh + ":" + mm;
      var docRef = db.collection("users").doc(commentUserId);
      docRef
        .get()
        .then(function(doc) {
          var commentUserName = doc.data().username;
          firebase
            .storage()
            .ref()
            .child("profilePicture/" + commentUserId)
            .getDownloadURL()
            .then(function(url) {
              if (url == "") {
                url = "img/userSampleImageMan.png";
              }
              $("#torihikiCommentImage_" + nowDataCount).attr("src", url);
              $("#torihikiCommentUserName_" + nowDataCount).html(
                commentUserName
              );

              $("#torihikiComment_" + nowDataCount).html(
                comment +
                  `<br><br><span style="font-size:0.85em;margin-top:5px;"><i class="far fa-clock" style="margin-right:5px;"></i>` +
                  time +
                  `</span>`
              );
              if (nowDataCount == size) {
                hideLoad();
                $("#nowDataCountInput").val(nowDataCount);
              }
            })
            .catch(function(error) {
              console.log("Error getting document:", error);
              hideLoad();
            });
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
          hideLoad();
        });
    }
  </script>
</ons-page>
