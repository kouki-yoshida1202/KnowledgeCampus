<ons-page id="productTorihikiPage">
  <style>
    .hyouka {
      display: -ms-flex;
      display: -webkit-flex;
      display: -moz-flex;
      display: -o-flex;
      display: flex;
      margin: 0 auto;

      flex-direction: -ms-row-reverse;
      flex-direction: -webkit-row-reverse;
      flex-direction: -moz-row-reverse;
      flex-direction: -o-row-reverse;
      flex-direction: row-reverse;

      justify-content: -ms-right;
      justify-content: -webkit-right;
      justify-content: -moz-right;
      justify-content: -o-right;
      justify-content: right;
    }
    .hyouka input[type="radio"] {
      display: none;
    }
    .hyouka input[type="radio"] {
      display: none;
    }
    .hyouka label {
      position: relative;
      padding: 10px 0px 20px 0px;
      color: #bbb;
      cursor: pointer;
      font-size: 30px;
    }

    .hyouka label:hover,
    .hyouka label:hover ~ label,
    .hyouka input[type="radio"]:checked ~ label {
      color: #ffd43b;
    }
    #productTorihikiComment {
      background-image: none;
      background-color: #eee;
      padding-bottom: 50px;
    }

    #productTorihikiPage ons-list p {
      margin-top: 0px;
      margin-bottom: 0px;
    }

    #productTorihikiComment ons-card {
      margin-left: 0px;
      margin-top: 0px;
    }

    #productTorihikiComment .list-item__title {
      font-size: 0.8em;
    }
    #productTorihikiPage .list-item__center {
      background-image: none;
      padding-top: 5px;
      padding-bottom: 5px;
    }

    #productTorihikiPage ons-list-header {
      font-size: 0.9em;
      padding-top: 0.25em;
      padding-bottom: 0.25em;
    }
  </style>
  <ons-toolbar>
    <div class="left" id="toolbar-title">
      <ons-back-button></ons-back-button>
    </div>
    <div class="center" id="toolbar-title">取引画面</div>
  </ons-toolbar>
  <ons-bottom-toolbar
    id="torihikiBottomBar"
    style="line-height: 35px;height:50px"
  >
    <ons-row style="padding-top:5px;">
      <ons-col
        width="80%"
        style="text-align: center;font-size:1.0em;"
        vertical-align="center"
      >
        <ons-input
          id="torihikiCommentInput"
          style="background-color: #efeff4;width:90%;line-height: 31px;padding-top:0px;padding-bottom:0px;"
          placeholder="コメント入力欄"
        >
        </ons-input>
      </ons-col>
      <ons-col width="20%" style="text-align: center;" vertical-align="center">
        <ons-button
          class="large-button-orange"
          style="font-size:1.0em;padding-top:0px;padding-bottom:0px;height:33px;"
          onclick="torihikiSubmit()"
          >送信
        </ons-button>
      </ons-col>
    </ons-row>
  </ons-bottom-toolbar>
  <div class="content">
    <ons-list>
      <ons-list-header>
        評価<span style="margin-left:0.5em;font-size: 0.8em;"
          >(通話が完了したら相手を評価しましょう。)</span
        >
      </ons-list-header>
      <ons-list-item>
        <ons-row style="position: relative;">
          <div class="hyouka">
            <input id="hoshi1" type="radio" name="hoshi" value="5" />
            <label for="hoshi1">★</label>
            <input id="hoshi2" type="radio" name="hoshi" value="4" />
            <label for="hoshi2">★</label>
            <input id="hoshi3" type="radio" name="hoshi" value="3" />
            <label for="hoshi3">★</label>
            <input id="hoshi4" type="radio" name="hoshi" value="2" />
            <label for="hoshi4">★</label>
            <input id="hoshi5" type="radio" name="hoshi" value="1" />
            <label for="hoshi5">★</label>
          </div>
        </ons-row>
        <ons-row>
          <ons-col vertical-align="center" style="text-align: left;">
            コメント
          </ons-col>
        </ons-row>
        <ons-row>
          <ons-col vertical-align="center">
            <textarea
              id="reviewComment"
              class="textarea textarea--transparent"
              rows="5"
              placeholder=""
            ></textarea>
          </ons-col>
        </ons-row>
        <ons-row>
          <ons-button
            id="reviewSubmitButton"
            onclick="reviewSubmitCheck()"
            modifier="large"
            class="large-button-orange"
            style="margin-top:1em;margin-bottom:1em;"
            >評価する</ons-button
          >
        </ons-row>
      </ons-list-item>
      <ons-list id="productTorihikiComment">
        <ons-list-header>
          トーク画面
          <span style="margin-left:0.5em;font-size: 0.8em;"
            >(挨拶、通話日時の日程調整、通話URLなど)</span
          >
        </ons-list-header>
        <div id="torihikiCommentList"></div>
      </ons-list>
    </ons-list>
  </div>
  <ons-modal
    id="reviewCompleteModal"
    direction="up"
    style="background-color: rgba(0,0,0,0.9);"
  >
    <div style="text-align: center">
      <p style="color:white;font-weight: bold;">
        取引完了しました。<br />
        またのご利用をお待ちしております。
      </p>
      <div style="padding:0.5rem;margin-top:1rem;">
        <ons-button
          modifier="large"
          class="large-button-orange"
          onclick="window.location.href = 'index.html';"
          >ホーム画面へ</ons-button
        >
      </div>
    </div>
  </ons-modal>
  <input type="hidden" id="torihikiPageProductId" />
  <input type="hidden" id="torihikiPageProductUserId" />
  <input type="hidden" id="torihikiPagebuyUserId" />
  <input type="hidden" id="torihikiPageNagotiationId" />
  <input type="hidden" id="nowDataCountInput" />
  <script>
    setTimeout(function() {
      let productTorihikiPage = document.querySelector("#productTorihikiPage");
      original_main_height = productTorihikiPage.clientHeight;
      $("input[name=hoshi]").val([3]);
    }, 100);
    $("#reviewComment")
      .focusin(function(e) {
        $("#torihikiBottomBar").hide();
      })
      .focusout(function(e) {
        $("#torihikiBottomBar").show();
      });

    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#productTorihikiPage").animate(
        { height: original_main_height - event.keyboardHeight + 30 + "px" },
        100
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#productTorihikiPage").animate(
        { height: original_main_height + "px" },
        100
      );
    });
    var reviewSubmitCounter = 0;
    function reviewSubmitCheck() {
      var productUserId = $("#torihikiPageProductUserId").val();
      var buyUserId = $("#torihikiPagebuyUserId").val();
      var user = firebase.auth().currentUser;
      var myUserId = user.uid;
      ons.notification.confirm({
        message: "双方がレビューをすることで取引が完了します。よろしいですか？",
        title: "確認",
        buttonLabels: ["キャンセル", "OK"],
        callback: function(buttonIndex) {
          if (buttonIndex == 1 && reviewSubmitCounter == 0) {
            reviewSubmit();
            reviewSubmitCounter++;
          }
        }
      });
    }
    function reviewSubmit() {
      var reviewComment = $("#reviewComment").val();
      var reviewCount = $("input[name=hoshi]:checked").val();
      showLoad();
      var productId = $("#torihikiPageProductId").val();
      var negotiationId = $("#torihikiPageNagotiationId").val();
      var productUserId = $("#torihikiPageProductUserId").val();
      var buyUserId = $("#torihikiPagebuyUserId").val();
      var user = firebase.auth().currentUser;
      var myUserId = user.uid;
      var createTime = new Date();
      if (myUserId == productUserId) {
        var reviewSentUserId = buyUserId;
      } else if (myUserId == buyUserId) {
        var reviewSentUserId = productUserId;
      }
      db.collection("users")
        .doc(reviewSentUserId)
        .collection("reviews")
        .where("negotiationId", negotiationId)
        .where("writeUserId", myUserId)
        .get()
        .then(function(reviewExistCheck) {
          if (reviewExistCheck.size > 0) {
            ons.notification.alert({
              message: "同一商品に対して複数回評価をすることはできません"
            });
          } else {
            db.collection("users")
              .doc(reviewSentUserId)
              .collection("reviews")
              .doc()
              .set(
                {
                  createTime: new Date(),
                  reviewComment: reviewComment,
                  reviewCount: reviewCount,
                  negotiationId: negotiationId,
                  writeUserId: myUserId
                },
                { merge: true }
              )
              .then(function() {
                hideLoad();
                $("#reviewComment").attr("readonly", true);
                $("#reviewSubmitButton").html("評価済み");
                $("#reviewSubmitButton").get(0).onclick = "";
                $("#reviewSubmitButton")
                  .removeClass("large-button-orange")
                  .addClass("large-button-gray");
                $("input[name=hoshi]").prop("disabled", true);
              })
              .then(function() {
                db.collection("negotiations")
                  .doc(negotiationId)
                  .get()
                  .then(function(nego) {
                    var reviewStatusNow = nego.data().reviewStatus;
                    if (reviewStatusNow == "") {
                      if (myUserId == productUserId) {
                        var reviewStatus = "productUserOk";
                      } else if (myUserId == buyUserId) {
                        var reviewStatus = "buyUserOk";
                      }
                      var status = "取引中";
                    } else {
                      var reviewStatus = "complete";
                      var status = "取引完了";
                    }

                    db.collection("negotiations")
                      .doc(negotiationId)
                      .set(
                        {
                          reviewStatus: reviewStatus,
                          status: status
                        },
                        { merge: true }
                      )
                      .then(function() {
                        db.collection("users")
                          .doc(myUserId)
                          .get()
                          .then(function(users) {
                            var userName = users.data().username;
                            var push = new ncmb.Push();
                            push
                              .set("immediateDeliveryFlag", true)
                              .set(
                                "message",
                                userName + "さんから評価されました。"
                              )
                              .set("target", ["ios", "android"])
                              .set("searchCondition", {
                                userId: reviewSentUserId
                              })
                              .send();
                            // 通知Firebase

                            db.collection("notifications")
                              .doc()
                              .set(
                                {
                                  sendUserId: myUserId,
                                  catchUserId: reviewSentUserId,
                                  createTime: new Date(),
                                  message:
                                    userName + "さんから評価されました。",
                                  readStatus: "Unread",
                                  pushKind: "negotiation",
                                  productId: productId,
                                  buyUserId: buyUserId,
                                  productUserId: productUserId
                                },
                                { merge: true }
                              )
                              .then(function() {
                                $("#reviewCompleteModal").show();
                              });
                          });
                      });
                  })
                  .catch(function(error) {
                    console.log(error);
                  });
              })
              .catch(function(error) {
                console.log(error);
                hideLoad();
              });
          }
        })
        .catch(function(error) {
          console.log(error);
          hideLoad();
        });
    }

    function torihikiSubmit() {
      var commentInput = $("#torihikiCommentInput").val();
      if (commentInput.trim() == "") {
        ons.notification.alert({
          message: "コメントが未入力です"
        });
      } else {
        showLoad();
        var productId = $("#torihikiPageProductId").val();
        var negotiationId = $("#torihikiPageNagotiationId").val();
        var productUserId = $("#torihikiPageProductUserId").val();
        var buyUserId = $("#torihikiPagebuyUserId").val();
        var user = firebase.auth().currentUser;
        var userId = user.uid;
        if (userId == buyUserId) {
          var sendUserId = productUserId;
        } else {
          var sendUserId = buyUserId;
        }

        var createTime = new Date();
        db.collection("negotiations")
          .doc(negotiationId)
          .collection("comments")
          .doc()
          .set(
            {
              comment: commentInput,
              createTime: createTime,
              sendUserId: userId,
              catchUserId: sendUserId,
              readStatus: "Unread"
            },
            { merge: true }
          )
          .then(function() {
            var createTime = firebase.firestore.Timestamp.fromDate(new Date());
            $("#torihikiCommentInput").val("");
            var nowDataCount = $("#nowDataCountInput").val() + 1;
            var commentlist = "";
            commentlist =
              `
                <ons-list-item>
                  <div class="left">
                    <img
                      id="torihikiCommentImage_` +
              nowDataCount +
              `"
                      class="list-item__thumbnail"
                      src="img/userSampleImageMan.png"
                      style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                    />
                  </div>
                  <div class="center" style="width:50%;">
                    <span id="torihikiCommentUserName_` +
              nowDataCount +
              `"class="list-item__title"></span>
                    <span class="list-item__subtitle">
                      <ons-card id="torihikiComment_` +
              nowDataCount +
              `">
                      </ons-card>
                    </span>
                  </div>
                </ons-list-item>
              `;
            $("#torihikiCommentList").prepend(commentlist);
            torihikiCommentIndicate(
              userId,
              commentInput,
              nowDataCount,
              nowDataCount,
              createTime
            );
          })
          .then(function() {
            db.collection("users")
              .doc(user.uid)
              .get()
              .then(function(users) {
                var userName = users.data().username;
                var push = new ncmb.Push();
                push
                  .set("immediateDeliveryFlag", true)
                  .set(
                    "message",
                    userName + "さんから取引メッセージが届きました。"
                  )
                  .set("target", ["ios", "android"])
                  .set("searchCondition", {
                    userId: sendUserId
                  })
                  .send();
              });
          })
          .catch(function(error) {
            console.log(error);
            alert("コメント失敗");
          });
      }
    }
    function torihikiIndicate(productId, buyUserId, productUserId) {
      showLoad();
      var nowDataCount = 0;
      $("#torihikiCommentList").empty();

      db.collection("negotiations")
        .where("productId", "==", productId)
        .where("buyUserId", "==", buyUserId)
        .where("productUserId", "==", productUserId)
        .get()
        .then(function(negoResult) {
          if (negoResult.size > 0) {
            negoResult.forEach(nego => {
              var negotiationId = nego.id;
              var reviewStatus = nego.data().reviewStatus;
              $("#torihikiPageNagotiationId").val(negotiationId);

              var userId = firebase.auth().currentUser.uid;
              var productUserOk = "productUserOk";
              var buyUserOk = "buyUserOk";
              var reviewStatus = reviewStatus.normalize("NFC");
              var buyUserOk = buyUserOk.normalize("NFC");
              var productUserOk = productUserOk.normalize("NFC");
              if (userId == buyUserId && reviewStatus == buyUserOk) {
                reviewCompleteCheck(productUserId, negotiationId);
              } else if (
                userId == productUserId &&
                reviewStatus == productUserOk
              ) {
                reviewCompleteCheck(buyUserId, negotiationId);
              } else if (nego.data().status == "取引完了") {
                if (userId == productUserId) {
                  reviewCompleteCheck(buyUserId, negotiationId);
                } else if (userId == buyUserId) {
                  reviewCompleteCheck(productUserId, negotiationId);
                }
              }
              db.collection("negotiations")
                .doc(negotiationId)
                .collection("comments")
                .orderBy("createTime", "desc")
                .get()
                .then(function(torihikiComments) {
                  console.log(torihikiComments);
                  if (torihikiComments.size > 0) {
                    torihikiComments.forEach(torihikiComment => {
                      nowDataCount++;
                      var commentlist = "";
                      commentlist =
                        `
                          <ons-list-item>
                            <div class="left">
                              <img
                                id="torihikiCommentImage_` +
                        nowDataCount +
                        `"
                                class="list-item__thumbnail"
                                src="img/userSampleImageMan.png"
                                style="width:45px;height:45px;border-radius: 50%;object-fit:cover;"
                              />
                            </div>
                            <div class="center" style="width:50%;">
                              <span id="torihikiCommentUserName_` +
                        nowDataCount +
                        `"class="list-item__title"></span>
                              <span class="list-item__subtitle">
                                <ons-card id="torihikiComment_` +
                        nowDataCount +
                        `">
                                </ons-card>
                              </span>
                            </div>
                          </ons-list-item>
                        `;
                      $("#torihikiCommentList").append(commentlist);
                      torihikiCommentIndicate(
                        torihikiComment.data().sendUserId,
                        torihikiComment.data().comment,
                        nowDataCount,
                        torihikiComments.size,
                        torihikiComment.data().createTime
                      );
                    });
                  } else {
                    hideLoad();
                  }
                })
                .catch(function(error) {
                  console.log(error);
                  ons.notification.alert({
                    message:
                      "情報が取得できませんでした。通信環境をお確かめの上、再度お願いします。",
                    callback: function() {
                      window.location.href = "index.html";
                    }
                  });
                });
            });
          } else {
            hideLoad();
          }
        });
    }
    function torihikiCommentIndicate(
      commentUserId,
      comment,
      nowDataCount,
      size,
      createTime
    ) {
      console.log(commentUserId);
      //「月」を取得する
      var createTime = new Date(createTime * 1000);
      var MM = createTime.getMonth() + 1;
      //「日」を取得する
      var DD = createTime.getDate();
      //「時」を取得する
      var hh = createTime.getHours();
      //「分」を取得する
      var mm = createTime.getMinutes();
      if (hh < 10) {
        hh = "0" + hh;
      }
      if (mm < 10) {
        mm = "0" + mm;
      }
      var time = MM + "月" + DD + "日 " + hh + ":" + mm;
      db.collection("users")
        .doc(commentUserId)
        .get()
        .then(function(doc) {
          var commentUserName = doc.data().username;
          firebase
            .storage()
            .ref()
            .child("profilePicture/" + commentUserId)
            .getDownloadURL()
            .then(function(url) {
              return url;
            })
            .catch(function(error) {
              url = "img/userSampleImageMan.png";
              return url;
            })
            .then(function(url) {
              $("#torihikiCommentImage_" + nowDataCount).attr("src", url);
              $("#torihikiCommentImage_" + nowDataCount).click(function() {
                otherPageJump(commentUserId);
              });
              $("#torihikiCommentUserName_" + nowDataCount).html(
                commentUserName
              );

              $("#torihikiComment_" + nowDataCount).html(
                comment +
                  `<br><br><span style="font-size:0.85em;margin-top:5px;"><i class="far fa-clock" style="margin-right:5px;"></i>` +
                  time +
                  `</span>`
              );
              if (nowDataCount == size) {
                hideLoad();
                $("#nowDataCountInput").val(nowDataCount);
              }
            })
            .catch(function(error) {
              console.log("Error getting document:", error);
              hideLoad();
            });
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
          hideLoad();
        });
    }

    function reviewCompleteCheck(reviewGetUserId, negotiationId) {
      db.collection("users")
        .doc(reviewGetUserId)
        .collection("reviews")
        .where("negotiationId", "==", negotiationId)
        .get()
        .then(function(reviewDetails) {
          reviewDetails.forEach(reviewDetail => {
            var reviewComment = reviewDetail.data().reviewComment;
            var reviewCount = reviewDetail.data().reviewCount;
            var reviewDate = reviewDetail.data().createTime;
            $("#reviewComment").val(reviewComment);
            $("input[name=hoshi]").val([reviewCount]);
            $("#reviewComment").attr("readonly", true);
            $("#reviewSubmitButton").html("評価済み");
            $("#reviewSubmitButton").get(0).onclick = "";
            $("#reviewSubmitButton")
              .removeClass("large-button-orange")
              .addClass("large-button-gray");
            $("input[name=hoshi]").prop("disabled", true);
          });
        })
        .catch(function(error) {
          console.log(error);
          alert("コメント取得失敗");
          hideLoad();
        });
    }
  </script>
</ons-page>
