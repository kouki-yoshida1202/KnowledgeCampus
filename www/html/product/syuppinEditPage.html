<ons-page id="syuppinEditPage">
  <style>
    #syuppinEditPage .page__content {
      background-color: white !important;
    }
    #syuppinEditPage ons-list-item ons-col {
      font-size: 0.9em;
    }
  </style>
  <ons-toolbar>
    <div class="left">
      <ons-back-button></ons-back-button>
    </div>
    <div class="center" id="toolbar-title">
      変更画面
    </div>
  </ons-toolbar>
  <input type="hidden" id="productDocumentUid" />
  <div class="content">
    <ons-list-header>サービス名と説明</ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">カテゴリ</ons-col>
        <ons-col
          id="syuppinCategoryEdit"
          width="70%"
          vertical-align="center"
          style="text-align: right;padding-right:0.5em;"
          onclick="myNavigator.bringPageTop('html/syuppin/syuppinGenre1.html');"
        >
          (必須)　>
        </ons-col>
        <input type="hidden" id="syuppinCategory1Edit" />
        <input type="hidden" id="syuppinCategory2Edit" />
        <input type="hidden" id="syuppinCategory3Edit" />
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">タイトル</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-input id="syuppinTitleEdit" placeholder="(必須)"></ons-input>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col vertical-align="center" width="30%" style="text-align: left;">
          説明
        </ons-col>
        <ons-col vertical-align="center" width="70%" style="text-align: right;">
          <textarea
            id="syuppinExplanationEdit"
            class="textarea textarea--transparent"
            rows="5"
            placeholder="(必須)"
          ></textarea>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-header>
      <ons-row>
        <ons-col width="70%" vertical-align="center">手段/ツール</ons-col>
        <ons-col width="30%" vertical-align="center">
          ※オンラインに限る
        </ons-col>
      </ons-row>
    </ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">通話手段</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-select id="howToTalkEdit">
            <option value="Zoom">Zoom</option>
            <option value="Google Meet">Google Meet</option>
            <option value="Skype">Skype</option>
            <option value="Facetime">Facetime</option>
            <option value="その他">その他</option>
          </ons-select>
          <ons-input
            id="howToTalkOtherEdit"
            placeholder="通話手段をご記入ください"
            type="text"
            style="margin-top:3px;"
          ></ons-input>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-header>
      <ons-row>
        <ons-col width="100%" vertical-align="center">サービス時間</ons-col>
      </ons-row>
    </ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">時間</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-select id="syuppinTimeEdit">
            <option value="15分">15分</option>
            <option value="30分" selected>30分</option>
            <option value="45分">45分</option>
            <option value="60分">60分</option>
          </ons-select>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-header>
      <ons-row>
        <ons-col width="100%" vertical-align="center">販売価格</ons-col>
      </ons-row>
    </ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">価格</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-input
            id="syuppinPriceEdit"
            placeholder="¥3000"
            type="tel"
            style="margin-top:3px;"
            maxlength="5"
          ></ons-input>
        </ons-col>
      </ons-row>
      <ons-row style="margin-top:1rem;">
        <ons-col width="30%" vertical-align="center">販売手数料</ons-col>
        <ons-col
          id="syuppinTesuryoEdit"
          width="70%"
          vertical-align="center"
          style="text-align: right;"
        >
          ¥750(25%)
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%">販売利益</ons-col>
        <ons-col
          id="syuppinRiekiEdit"
          width="70%"
          vertical-align="center"
          style="text-align: right;font-weight: bold;font-size:1.5rem;"
          >¥2250</ons-col
        >
      </ons-row>
    </ons-list-item>
    <div style="padding:0.5rem;margin-top:1rem;">
      <ons-button
        modifier="large"
        class="large-button-orange"
        onclick="productSubmitCheckEdit('syuppin')"
        >出品</ons-button
      >
    </div>
    <div style="padding:0.5rem;">
      <ons-button
        modifier="large"
        class="large-button-gray"
        onclick="productSubmitCheckEdit('shitagaki')"
        >下書き保存</ons-button
      >
    </div>
    <div style="padding:0.5rem;margin-bottom:50px;">
      <ons-button
        modifier="large"
        class="large-button-gray"
        onclick="productDeleteCheck()"
        style="background: red;"
        >商品削除
      </ons-button>
    </div>
  </div>
  <script>
    $("#howToTalkOtherEdit").hide();
    $("#howToTalkEdit").change(function() {
      // 選択されているvalue属性値を取り出す
      var val = $(this).val();
      if (val == "その他") {
        $("#howToTalkOtherEdit").show();
      } else {
        $("#howToTalkOtherEdit").hide();
      }
    });

    $("#syuppinPriceEdit").keyup(function() {
      // 選択されているvalue属性値を取り出す
      riekiCalc();
    });

    function riekiCalc() {
      var price = $("#syuppinPriceEdit").val();
      if (price != "" && price != 0) {
        var tesuryo = Math.ceil(price * 0.25);
        $("#syuppinTesuryoEdit").html("¥" + tesuryo + "(25%)");
        $("#syuppinRiekiEdit").html("¥" + (price - tesuryo));
      } else {
        $("#syuppinTesuryoEdit").html("¥0(25%)");
        $("#syuppinRiekiEdit").html("¥0");
      }
    }
    function productSubmitCheckEdit(releasestatus) {
      var category1 = $("#syuppinCategory1Edit").val();
      var category2 = $("#syuppinCategory2Edit").val();
      var title = $("#syuppinTitleEdit").val();
      var explanation = $("#syuppinExplanationEdit").val();
      var howtotalk = $("#howToTalkEdit").val();
      var howtotalkother = $("#howToTalkOtherEdit").val();
      var time = $("#syuppinTimeEdit").val();
      var price = $("#syuppinPriceEdit").val();

      if (category1 == "" || category2 == "") {
        ons.notification.alert({
          title: "失敗",
          message: "カテゴリを選択してください"
        });
      } else if (title == "") {
        ons.notification.alert({
          title: "失敗",
          message: "タイトルを入力してください"
        });
      } else if (explanation == "") {
        ons.notification.alert({
          title: "失敗",
          message: "説明を入力してください"
        });
      } else if (howtotalk == "その他" && howtotalkother == "") {
        ons.notification.alert({
          title: "失敗",
          message: "通話手段を入力してください"
        });
      } else if (price == "") {
        ons.notification.alert({
          title: "失敗",
          message: "価格を入力してください"
        });
      } else {
        productSubmitEdit(releasestatus);
      }
    }
    function productSubmitEdit(releasestatus) {
      showLoad();
      var category1 = $("#syuppinCategory1Edit").val();
      var category2 = $("#syuppinCategory2Edit").val();
      var category3 = $("#syuppinCategory3Edit").val();
      var title = $("#syuppinTitleEdit").val();
      var explanation = $("#syuppinExplanationEdit").val();
      var howtotalk = $("#howToTalkEdit").val();
      var howtotalkother = $("#howToTalkOtherEdit").val();
      var time = $("#syuppinTimeEdit").val();
      var price = $("#syuppinPriceEdit").val();
      var productUid = getCurrentTime();
      var productDocumentUid = $("#productDocumentUid").val();

      var user = firebase.auth().currentUser;
      var setProductData = {
        productUid: productUid,
        createTime: new Date(),
        category1: category1,
        category2: category2,
        category3: category3,
        explanation: explanation,
        howtotalk: howtotalk,
        howtotalkother: howtotalkother,
        price: price,
        title: title,
        time: time,
        userId: user["uid"],
        releasestatus: releasestatus
      };
      // 商品変更
      db.collection("products")
        .doc(productDocumentUid)
        .set(setProductData, { merge: true })
        .then(function() {
          console.log("Document successfully written!");
          hideLoad();
          if (releasestatus == "syuppin") {
            var message = "商品を出品しました";
          } else if (releasestatus == "shitagaki") {
            var message = "下書き保存しました";
          }
          ons.notification.alert({
            title: "成功",
            message: message,
            callback: function() {
              window.location.href = "index.html";
            }
          });
        })
        .catch(function(error) {
          console.error("Error writing document: ", error);
          hideLoad();
          ons.notification.alert({
            title: "失敗",
            message: "出品に失敗しました。"
          });
        });
    }

    function productDeleteCheck() {
      ons.notification.confirm({
        message: "本当に削除しますか？",
        title: "確認",
        buttonLabels: ["キャンセル", "OK"],
        callback: function(buttonIndex) {
          if (buttonIndex == 1) {
            productDelete();
          }
        }
      });
    }

    function productDelete() {
      showLoad();
      var productDocumentUid = $("#productDocumentUid").val();
      db.collection("products")
        .doc(productDocumentUid)
        .delete()
        .then(function() {
          console.log("Document successfully deleted!");
          hideLoad();
          ons.notification.alert({
            title: "完了",
            message: "削除しました。",
            callback: function() {
              window.location.href = "index.html";
            }
          });
        })
        .catch(function(error) {
          console.error("Error removing document: ", error);
          hideLoad();
          ons.notification.alert({
            title: "失敗",
            message: "削除に失敗しました。"
          });
        });
    }
  </script>
</ons-page>
