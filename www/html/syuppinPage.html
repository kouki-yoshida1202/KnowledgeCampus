<ons-page id="syuppinPage">
  <style>
    #syuppinPage .page__content {
      background-color: white !important;
    }
    #syuppinPage ons-list-item ons-col {
      font-size: 0.9em;
    }
  </style>
  <ons-toolbar>
    <div class="center" id="toolbar-title">
      出品画面
    </div>
  </ons-toolbar>
  <div class="content">
    <ons-list-header>サービス名と説明</ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">カテゴリ</ons-col>
        <ons-col
          id="syuppinCategory"
          width="70%"
          vertical-align="center"
          style="text-align: right;padding-right:0.5em;"
          onclick="myNavigator.bringPageTop('html/syuppin/syuppinGenre1.html');"
        >
          (必須)　>
        </ons-col>
        <input type="hidden" id="syuppinCategory1" />
        <input type="hidden" id="syuppinCategory2" />
        <input type="hidden" id="syuppinCategory3" />
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">タイトル</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-input
            id="syuppinTitle"
            placeholder="(必須)"
            maxlength="20"
            type="text"
          ></ons-input>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col vertical-align="center" width="30%" style="text-align: left;">
          説明
        </ons-col>
        <ons-col vertical-align="center" width="70%" style="text-align: right;">
          <textarea
            id="syuppinExplanation"
            class="textarea textarea--transparent"
            rows="5"
            placeholder="(必須)"
          ></textarea>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-header>
      <ons-row>
        <ons-col width="70%" vertical-align="center">手段/ツール</ons-col>
        <ons-col width="30%" vertical-align="center">
          ※オンラインに限る
        </ons-col>
      </ons-row>
    </ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">通話手段</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-select id="howToTalk" class="howtoTalk">
            <option value="Zoom">Zoom</option>
            <option value="Google Meet">Google Meet</option>
            <option value="Skype">Skype</option>
            <option value="Facetime">Facetime</option>
            <option value="Google Duo">Google Duo</option>
            <!-- <option value="その他">その他</option> -->
          </ons-select>
          <ons-input
            id="howToTalkOther"
            placeholder="通話手段をご記入ください"
            type="text"
            style="margin-top:3px;"
          ></ons-input>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-header>
      <ons-row>
        <ons-col width="100%" vertical-align="center">サービス時間</ons-col>
      </ons-row>
    </ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">時間</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-select id="syuppinTime">
            <option value="15分">15分</option>
            <option value="30分" selected>30分</option>
            <option value="45分">45分</option>
            <option value="60分">60分</option>
          </ons-select>
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-header>
      <ons-row>
        <ons-col width="100%" vertical-align="center">販売価格</ons-col>
      </ons-row>
    </ons-list-header>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%" vertical-align="center">価格</ons-col>
        <ons-col width="70%" vertical-align="center">
          <ons-input
            id="syuppinPrice"
            placeholder="¥3000"
            type="tel"
            style="margin-top:3px;"
            maxlength="5"
          ></ons-input>
        </ons-col>
      </ons-row>
      <ons-row style="margin-top:1rem;">
        <ons-col width="30%" vertical-align="center">販売手数料</ons-col>
        <ons-col
          id="syuppinTesuryo"
          width="70%"
          vertical-align="center"
          style="text-align: right;"
        >
          ¥750(25%)
        </ons-col>
      </ons-row>
    </ons-list-item>
    <ons-list-item>
      <ons-row>
        <ons-col width="30%">販売利益</ons-col>
        <ons-col
          id="syuppinRieki"
          width="70%"
          vertical-align="center"
          style="text-align: right;font-weight: bold;font-size:1.5rem;"
          >¥2250</ons-col
        >
      </ons-row>
    </ons-list-item>
    <div style="padding:0.5rem;margin-top:1rem;">
      <ons-button
        modifier="large"
        class="large-button-orange"
        onclick="productSubmitCheck('syuppin');"
        >出品</ons-button
      >
    </div>
    <div style="padding:0.5rem;">
      <ons-button
        modifier="large"
        class="large-button-gray"
        onclick="productSubmitCheck('shitagaki');"
        >下書き保存</ons-button
      >
    </div>
    <div style="height:50px;width:300px;"></div>
  </div>
  <script>
    function testPush() {
      var title = $("#syuppinTitle").val();
      console.log(title);
    }
    setTimeout(function() {
      let syuppinPage = document.querySelector("#syuppinPage");
      original_main_height = syuppinPage.clientHeight;
    }, 100);

    //ソフトウェアキーボード表示処理
    window.addEventListener("keyboardWillShow", event => {
      //画面の高さをキーボードの高さを差し引いた値とする
      $("#syuppinPage").animate(
        { height: original_main_height - event.keyboardHeight + "px" },
        100
      );
    });

    //ソフトウェアキーボード非表示処理
    window.addEventListener("keyboardWillHide", () => {
      //画面の高さを元の高さに戻す
      $("#syuppinPage").animate({ height: original_main_height + "px" }, 100);
    });
    $("#howToTalkOther").hide();
    $(".howtoTalk").change(function() {
      // 選択されているvalue属性値を取り出す
      var val = $(this).val();
      if (val == "その他") {
        $("#howToTalkOther").show();
      } else {
        $("#howToTalkOther").hide();
      }
    });

    $("#syuppinPrice").keyup(function() {
      // 選択されているvalue属性値を取り出す
      var price = $(this).val();
      console.log(price);
      if (price != "" && price != 0) {
        var tesuryo = Math.ceil(price * 0.25);
        $("#syuppinTesuryo").html("¥" + tesuryo + "(25%)");
        $("#syuppinRieki").html("¥" + (price - tesuryo));
      } else {
        $("#syuppinTesuryo").html("¥0(25%)");
        $("#syuppinRieki").html("¥0");
      }
    });
    function productSubmitCheck(releasestatus) {
      var category1 = $("#syuppinCategory1").val();
      var category2 = $("#syuppinCategory2").val();
      var title = $("#syuppinTitle").val();
      var explanation = $("#syuppinExplanation").val();
      var howtotalk = $("#howToTalk").val();
      var howtotalkother = $("#howToTalkOther").val();
      var time = $("#syuppinTime").val();
      var price = $("#syuppinPrice").val();

      if (category1 == "" || category2 == "") {
        ons.notification.alert({
          title: "失敗",
          message: "カテゴリを選択してください"
        });
      } else if (title == "") {
        ons.notification.alert({
          title: "失敗",
          message: "タイトルを入力してください"
        });
      } else if (explanation == "") {
        ons.notification.alert({
          title: "失敗",
          message: "説明を入力してください"
        });
      } else if (howtotalk == "その他" && howtotalkother == "") {
        ons.notification.alert({
          title: "失敗",
          message: "通話手段を入力してください"
        });
      } else if (price == "") {
        ons.notification.alert({
          title: "失敗",
          message: "価格を入力してください"
        });
      } else if (price < 300) {
        ons.notification.alert({
          title: "失敗",
          message: "最低価格は300円から"
        });
      } else {
        productSubmit(releasestatus);
      }
    }
    function productSubmit(releasestatus) {
      showLoad();
      var category1 = $("#syuppinCategory1").val();
      var category2 = $("#syuppinCategory2").val();
      var category3 = $("#syuppinCategory3").val();
      var title = $("#syuppinTitle").val();
      var explanation = $("#syuppinExplanation")
        .val()
        .replace(/\r?\n/g, "<5060>");
      var howtotalk = $("#howToTalk").val();
      var howtotalkother = $("#howToTalkOther").val();
      var time = $("#syuppinTime").val();
      var price = $("#syuppinPrice").val();

      var user = firebase.auth().currentUser;
      var setProductData = {
        createTime: new Date(),
        updateTime: new Date(),
        category1: category1,
        category2: category2,
        category3: category3,
        explanation: explanation,
        howtotalk: howtotalk,
        howtotalkother: howtotalkother,
        price: price,
        title: title,
        time: time,
        userId: user["uid"],
        releasestatus: releasestatus
      };
      //新規出品
      db.collection("products")
        .doc()
        .set(setProductData)
        .then(function() {
          console.log("Document successfully written!");
          hideLoad();
          if (releasestatus == "syuppin") {
            var message = "商品を出品しました";
          } else if (releasestatus == "shitagaki") {
            var message = "下書き保存しました";
          }
          ons.notification.alert({
            title: "成功",
            message: message,
            callback: function() {
              window.location.href = "index.html";
            }
          });
        })
        .catch(function(error) {
          console.error("Error writing document: ", error);
          hideLoad();
          ons.notification.alert({
            title: "失敗",
            message: "出品に失敗しました。"
          });
        });
    }

    //先頭ゼロ付加
    function padZero(num) {
      return (num < 10 ? "0" : "") + num;
    }
  </script>
</ons-page>
