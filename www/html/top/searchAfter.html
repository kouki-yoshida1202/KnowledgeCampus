<ons-page id="searchAfterPage">
  <style>
    #searchAfterPage .popover__content {
      width: 320px;
    }
    #searchAfterPage .content p {
      margin-top: 3px;
      margin-bottom: 3px;
    }
    #searchAfterPage ons-card {
      text-align: center;
      padding: 0px;
      margin: 0px;
      height: 240px;
    }
    #searchAfterPage .mainReview {
      font-size: 0.8em;
      display: flex;
      justify-content: center;
    }
    .card-box {
      padding: 7px;
    }
  </style>
  <ons-toolbar>
    <div class="left">
      <ons-back-button> </ons-back-button>
    </div>
    <div
      class="center"
      id="searchAfterToolbar"
      style="display:flex;align-items: center;justify-content: center;"
    >
      検索
    </div>
    <div class="right">
      <i
        class="fas fa-filter fa-2x"
        style="margin: 0 auto;border-radius: 35px;padding:0px 18%;color:#515c6f;font-size:1.0em;"
        onclick="showSearchPopover(this);"
      ></i>
    </div>
  </ons-toolbar>
  <div
    class="content page__content"
    style="padding-top:2px;padding-bottom:30px;"
  >
    <div
      id="searchProduct"
      class="content"
      style="display: flex;justify-content: space-between;flex-wrap: wrap;padding-right:3%;padding-left:3%;"
    ></div>
  </div>

  <ons-popover direction="down" id="searchPopover" cancelable>
    <div style="padding: 10px; text-align: center;">
      <ons-row>
        <ons-col
          width="100%"
          style="text-align: right;"
          vertical-align="center"
        >
          <ons-icon
            icon="fa-times-circle"
            onclick="hideSearchPopover()"
          ></ons-icon>
        </ons-col>
      </ons-row>
      <!-- <ons-row style="padding:20px 10px;">
        <ons-col vertical-align="center" width="40%">
          ジャンル
        </ons-col>
        <ons-col vertical-align="center" width="60%" style="text-align: right;">
          <ons-select id="choose-sel" onchange="editSelects(event)">
            <option value="basic">すべて</option>
            <option value="material">就活</option>
            <option value="underbar">〜</option>
            <option value="underbar">〜</option>
            <option value="underbar">〜</option>
          </ons-select>
        </ons-col>
      </ons-row> -->
      <ons-row style="padding:20px 10px;">
        <ons-col vertical-align="center" width="40%">
          最低価格
        </ons-col>
        <ons-col vertical-align="center" width="60%" style="text-align: right;">
          <ons-input
            id="minPrice"
            placeholder="Min"
            maxlength="5"
            type="tel"
          ></ons-input>
        </ons-col>
      </ons-row>
      <ons-row style="padding:20px 10px;">
        <ons-col vertical-align="center" width="40%">
          最高価格
        </ons-col>
        <ons-col vertical-align="center" width="60%" style="text-align: right;">
          <ons-input
            id="maxPrice"
            placeholder="Max"
            maxlength="5"
            type="tel"
          ></ons-input>
        </ons-col>
      </ons-row>
      <ons-row style="padding:20px 10px;">
        <ons-col vertical-align="center" width="40%">
          並び順
        </ons-col>
        <ons-col vertical-align="center" width="60%" style="text-align: right;">
          <ons-select id="searchSort">
            <option value="newSort">新着順</option>
            <option value="rowSort">価格が安い順</option>
            <option value="highSort">価格が高い順</option>
          </ons-select>
        </ons-col>
      </ons-row>
      <p style="padding:10px;">
        <ons-button
          modifier="large"
          style="border-radius: 10px;background-color:#ff9831;font-size: 0.9em;"
          ripple
          onclick="searchReflesh();"
          >検索する
        </ons-button>
      </p>
    </div>
  </ons-popover>
  <input type="hidden" id="searchAfterPageCategory1" />
  <input type="hidden" id="searchAfterPageCategory2" />
  <input type="hidden" id="searchAfterPageCategory3" />
  <script>
    var showSearchPopover = function(target) {
      document.getElementById("searchPopover").show(target);
    };

    var hideSearchPopover = function() {
      document.getElementById("searchPopover").hide();
    };

    function searchReflesh() {
      showLoad();
      $("#searchProduct").empty();
      var minPrice = Number($("#minPrice").val());
      var maxPrice = Number($("#maxPrice").val());
      var searchSort = $("#searchSort").val();

      if (minPrice != "" && maxPrice != "" && minPrice > maxPrice) {
        ons.notification.alert({
          message: "最低価格が最高価格を上回っています。"
        });
        hideLoad();
      } else {
        if (minPrice == "") {
          minPrice = 0;
        }
        if (maxPrice == "") {
          maxPrice = 99999;
        }

        var category1 = $("#searchAfterPageCategory1").val();
        var category2 = $("#searchAfterPageCategory2").val();
        var category3 = $("#searchAfterPageCategory3").val();
        if (category2 == "All") {
          var productSearch = db
            .collection("products")
            .where("category1", "==", category1);
        } else if (category2 != "All" && category3 == "All") {
          var productSearch = db
            .collection("products")
            .where("category1", "==", category1)
            .where("category2", "==", category2);
        } else {
          var productSearch = db
            .collection("products")
            .where("category1", "==", category1)
            .where("category2", "==", category2)
            .where("category3", "==", category3);
        }
        if (searchSort == "newSort") {
          var productSearch = productSearch
            .orderBy("price")
            .orderBy("createTime", "desc")
            .startAt(minPrice)
            .endAt(maxPrice);
        } else if (searchSort == "rowSort") {
          var productSearch = productSearch
            .orderBy("price", "asc")
            .startAt(minPrice)
            .endAt(maxPrice);
        } else if (searchSort == "highSort") {
          var productSearch = productSearch
            .orderBy("price", "desc")
            .startAt(maxPrice)
            .endAt(minPrice);
        }
        productSearch
          .get()
          .then(function(productResults) {
            var nowDataCount = 0;
            if (productResults.size > 0) {
              hideSearchPopover();
              productResults.forEach(productResult => {
                nowDataCount++;
                productSearchGet(productResult, nowDataCount, productResults);
              });
            } else {
              ons.notification.alert({
                message: "1件も見つかりませんでした"
              });
            }
          })
          .catch(function(error) {
            console.log(error);
            hideLoad();
          });
      }
    }
  </script>
</ons-page>
