<ons-page id="searchBeforePage">
  <ons-toolbar>
    <div class="left">
      <ons-back-button></ons-back-button>
    </div>
    <div
      class="center"
      id="toolbar-title"
      style="display:flex;align-items: center;justify-content: center;"
    >
      カテゴリー検索
    </div>
  </ons-toolbar>
  <div class="content">
    <div style="width:100%;margin:0 auto;margin-top:20px;margin-bottom:30px;">
      <ons-list-item onclick="searchPageJump('学業','All');">
        <div class="center" style="font-weight:bold;font-size:1.2em;">
          <i
            class="fas fa-user-graduate fa-fw"
            style="font-size:1.2em;margin-right:0.5em;"
          ></i
          >学業
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('学業','講義');">
        <div class="center">
          講義
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('学業','受験');">
        <div class="center">
          受験
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('学業','語学');">
        <div class="center">
          語学
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('学業','その他');">
        <div class="center">
          その他
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <br />
      <ons-list-item onclick="searchPageJump('キャリア','All');">
        <div class="center" style="font-weight:bold;font-size:1.2em;">
          <i
            class="fas fa-level-up-alt fa-fw"
            style="font-size:1.2em;margin-right:0.5em;"
          ></i
          >キャリア
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('キャリア','就活');">
        <div class="center">
          就活
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('キャリア','インターン');">
        <div class="center">
          インターン
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('キャリア','資格');">
        <div class="center">
          資格
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('キャリア','転職');">
        <div class="center">
          転職
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('キャリア','その他');">
        <div class="center">
          その他
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <br />
      <ons-list-item onclick="searchPageJump('ビジネス','All');">
        <div class="center" style="font-weight:bold;font-size:1.2em;">
          <i
            class="fas fa-user-tie fa-fw"
            style="font-size:1.2em;margin-right:0.5em;"
          ></i
          >ビジネス
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','起業/経営');">
        <div class="center">
          起業/経営
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','マーケティング');">
        <div class="center">
          マーケティング
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','IT/プログラミング');">
        <div class="center">
          IT/プログラミング
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','投資(FX/株)');">
        <div class="center">
          投資(FX/株)
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','アフィリエイト');">
        <div class="center">
          アフィリエイト
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','ブログ');">
        <div class="center">
          ブログ
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','転売');">
        <div class="center">
          転売
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','ライブ配信');">
        <div class="center">
          ライブ配信
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','YouTuber');">
        <div class="center">
          YouTuber
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
      <ons-list-item onclick="searchPageJump('ビジネス','その他');">
        <div class="center">
          その他
        </div>
        <div class="right">
          >
        </div>
      </ons-list-item>
    </div>
  </div>
  <script>
    function searchPageJump(category1, category2) {
      showLoad();

      myNavigator.bringPageTop("html/top/searchAfter.html");
      $("#searchProduct").empty();
      var nowDataCount = 0;
      if (category2 == "All") {
        var products = db
          .collection("products")
          .where("category1", "==", category1);
        setTimeout(function() {
          $("#searchAfterToolbar").html(category1);
        }, 500);
      } else {
        var products = db
          .collection("products")
          .where("category1", "==", category1)
          .where("category2", "==", category2);
        setTimeout(function() {
          $("#searchAfterToolbar").html(category1 + " > " + category2);
        }, 500);
      }
      products
        .where("releasestatus", "==", "syuppin")
        .orderBy("createTime", "desc")
        .get()
        .then(results => {
          if (results.size > 0) {
            results.forEach(doc => {
              nowDataCount++;
              var product =
                `
              <div style="text-align: center;width:47%;padding:5px 1.5% 0px 1.5% !important;">
                <ons-card class="mainCard searchCard_` +
                nowDataCount +
                `" onclick="giftDetailJump('` +
                doc.id +
                `')" style="padding-top:15px;padding-bottom:10px;height:200px;">
                  <img class="user_icon_mainPage searchImage_` +
                nowDataCount +
                `"alt="" />
                  <p class="mainUserName searchUserName_` +
                nowDataCount +
                `"></p>
                  <p class="searchReview_` +
                nowDataCount +
                `"class="mainReview">
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  <img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>
                  (0)
                  </p>
                  <div style="display: flex;justify-content: center;align-items: center;height:38px;margin-top:7px;margin-bottom:7px;border-left:3px solid #ff9831;">
                  <p class="mainPageItemText searchTitle_` +
                nowDataCount +
                `"></p></div>
                  <p>
                    <span class="salaly searchSalalyTime_` +
                nowDataCount +
                `"></span>
                    <span class="howto searchHowTo_` +
                nowDataCount +
                `"></span>
                  </p>
                </ons-card>
              </div>
            `;
              $("#searchProduct").append(product);

              productSearchIndicate(
                doc.id,
                doc.data(),
                nowDataCount,
                results.size
              );
            });
          } else {
            hideLoad();
          }
        })
        .catch(error => {
          console.log(`データの取得に失敗しました (${error})`);
          hideLoad();
        });
    }

    function productSearchIndicate(docId, data, nowDataCount, size) {
      var userId = data.userId;
      var docRef = db.collection("users").doc(userId);
      docRef
        .get()
        .then(function(doc) {
          if (doc.exists) {
            var url = "";
            var user = firebase.auth().currentUser;
            var username = doc.data().username;
            firebase
              .storage()
              .ref()
              .child("profilePicture/" + data.userId)
              .getDownloadURL()
              .then(url => {
                // 画像取得できた
                return url;
              })
              .catch(function() {
                // 画像取得できないとき
                url = "img/userSampleImageMan.png";
                return url;
              })
              .then(function(url) {
                $(".searchUserName_" + nowDataCount).html(doc.data().username);
                $(".searchImage_" + nowDataCount).attr("src", url);
                $(".searchTitle_" + nowDataCount).html(data.title);
                $(".searchSalalyTime_" + nowDataCount).html(
                  "¥" + data.price + "/" + data.time
                );
                $(".searchHowTo_" + nowDataCount).html(data.howtotalk);
                reviewControl(data.userId).then(function(result) {
                  $(".searchReview_" + nowDataCount).empty();
                  for (var i = 1; i < 6; i++) {
                    if (i > result[1]) {
                      var star =
                        '<img src="img/starOff.png" alt="" style="height:14px;margin-right:3px;"/>';
                    } else {
                      var star =
                        '<img src="img/starOn.png" alt=""style="height:14px;margin-right:3px;"/>';
                    }
                    $(".searchReview_" + nowDataCount).append(star);
                  }
                  $(".searchReview_" + nowDataCount).append(
                    "(" + result[0] + ")"
                  );
                });
                if (nowDataCount == size) {
                  setTimeout(function() {
                    hideLoad();
                    syoryaku(".mainPageItemText");
                    syoryakuName(".mainUserName");
                  }, 1000);
                  $("#searchProduct").height(210 * Math.ceil(nowDataCount / 2));
                }
              });
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        })
        .catch(function(error) {
          console.log("Error getting document:", error);
        });
    }
  </script>
</ons-page>
