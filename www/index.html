<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src * knowledgecampus data: gap: https://ssl.gstatic.com;img-src * 'self' blob: data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'"
    />
    <script src="components/loader.js"></script>
    <script src="lib/onsenui/js/onsenui.min.js"></script>
    <script src="lib/onsenui/js/bower.js"></script>

    <link rel="stylesheet" href="components/loader.css" />
    <link rel="stylesheet" href="lib/onsenui/css/onsenui.css" />
    <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:400,700|Noto+Sans+JP:400,700"
      rel="stylesheet"
    />
    <script src="lib/onsenui/js/loadingoverlay.min.js"></script>
    <script src="../node_modules/compressorjs/dist/compressor.js"></script>

    <script></script>
    <style></style>
  </head>
  <body>
    <ons-navigator id="myNavigator"></ons-navigator>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
    https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-storage.js"></script>
    <script>
      //ncmbのAPIキーの設定とSDKの初期化
      var appKey =
        "7e4e7a3c249ee77301994716f3a8830d1f713804cb2379a550e0814acb215ed1";
      var clientKey =
        "cba0bb9821169b593d88ebb8a7828f79638c911da3008212739e13b9189ff608";
      var ncmb = new NCMB(appKey, clientKey);
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyA56OkCzhlaMNwunHOsxXbS5z7mJBzMSFM",
        authDomain: "knowledgecampus-test.firebaseapp.com",
        databaseURL: "https://knowledgecampus-test.firebaseio.com",
        projectId: "knowledgecampus-test",
        storageBucket: "knowledgecampus-test.appspot.com",
        messagingSenderId: "1036117855994",
        appId: "1:1036117855994:web:7a317f24ce2905014b4343",
        measurementId: "G-YQLTPSJSVH"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
      var db = firebase.firestore();
      var storage = firebase.storage();
      ons.ready(function() {
        var myNavigator = document.getElementById("myNavigator");

        if (window.localStorage.getItem("loggedIn") != 1) {
          // 初回起動の場合
          window.localStorage.setItem("loggedIn", 1);
          console.log("1st time");
          myNavigator.pushPage("html/firstPage.html");
        } else {
          //2回目以降
          console.log("running this for more than one time");

          // ログインチェック
          db.collection("mentenance")
            .doc("mente")
            .get()
            .then(function(mente) {
              var text = mente.data().text;
              if (text != "") {
                myNavigator.pushPage("html/loginPage.html");
                setTimeout(function() {
                  ons.notification.alert({
                    message: text
                  });
                  $("ons-button").attr("disabled", true);
                }, 1000);
              } else {
                firebase.auth().onAuthStateChanged(user => {
                  if (user) {
                    if (!user.emailVerified) {
                      // メアド確認終わってない
                      myNavigator.pushPage("html/loginPage.html");
                    } else {
                      // メアド確認終わってる
                      myNavigator.pushPage("html/homePage.html");
                    }
                  } else {
                    myNavigator.pushPage("html/loginPage.html");
                  }
                });
              }
            });
        }
      });

      if (ons.platform.isIPhoneX()) {
        document.documentElement.setAttribute("onsflag-iphonex-portrait", "");
        document.documentElement.setAttribute("onsflag-iphonex-landscape", "");
      }
      function showLoad() {
        $("body").LoadingOverlay("show", {
          image: "",
          fontawesome: "fa fa-spinner fa-spin fa-small"
        });
        setTimeout(function() {
          $("body").LoadingOverlay("hide");
        }, 5000);
      }

      function hideLoad() {
        $("body").LoadingOverlay("hide");
      }
      function AutoLink(str) {
        var regexp_url = /((h?)(ttps?:\/\/[a-zA-Z0-9.\-_@:/~?%&;=+#',()*!]+))/g; // ']))/;
        var regexp_makeLink = function(all, url, h, href) {
          return (
            `<a style="color:#0799d7" onclick="window.open('` +
            url +
            `', '_system', 'location = yes')">` +
            url +
            `</a>`
          );
        };
        console.log(str);
        str = String(str);
        return str.replace(regexp_url, regexp_makeLink);
      }
      function handleOpenURL(url) {
        // alert("handle呼ばれた");
        setTimeout(function() {
          var strValue = decodeURIComponent(url);
          var urlPrm = [];
          strValue = strValue.replace("knowledgecampus://", "");
          var urlSearch = strValue.substring(1).split("&");
          for (i = 0; urlSearch[i]; i++) {
            var kv = urlSearch[i].split("=");
            urlPrm[kv[0]] = kv[1];
          }
          var productId = urlPrm.productIdComplete;
          var productUserId = urlPrm.productUserIdComplete;
          var buyUserId = urlPrm.buyUserIdComplete;

          db.collection("users")
            .doc(buyUserId)
            .get()
            .then(function(users) {
              var userName = users.data().username;
              var push = new ncmb.Push();
              push
                .set("immediateDeliveryFlag", true)
                .set("message", userName + "さんが商品を購入しました。")
                .set("target", ["ios", "android"])
                .set("searchCondition", {
                  userId: productUserId
                })
                .send();
              // 通知Firebase

              db.collection("notifications")
                .doc()
                .set(
                  {
                    sendUserId: buyUserId,
                    catchUserId: productUserId,
                    createTime: new Date(),
                    message: userName + "さんが商品を購入しました。",
                    readStatus: "Unread",
                    pushKind: "negotiation",
                    productId: productId,
                    buyUserId: buyUserId,
                    productUserId: productUserId
                  },
                  { merge: true }
                );
            });
          db.collection("users")
            .doc(productUserId)
            .get()
            .then(function(users) {
              var userName = users.data().username;
              var push = new ncmb.Push();
              push
                .set("immediateDeliveryFlag", true)
                .set(
                  "message",
                  userName +
                    "さんの商品を購入しました。トーク画面で挨拶しましょう！"
                )
                .set("target", ["ios", "android"])
                .set("searchCondition", {
                  userId: buyUserId
                })
                .send();
              // 通知Firebase

              db.collection("notifications")
                .doc()
                .set(
                  {
                    sendUserId: buyUserId,
                    catchUserId: buyUserId,
                    createTime: new Date(),
                    message:
                      userName +
                      "さんの商品を購入しました。トーク画面で挨拶しましょう！",
                    readStatus: "Unread",
                    pushKind: "negotiation",
                    productId: productId,
                    buyUserId: buyUserId,
                    productUserId: productUserId
                  },
                  { merge: true }
                );
            });
          giftDetailJump(productId);
        }, 100);
      }

      // dataURIをBlobに変換する関数
      function toBlob(dataURI) {
        const byteString = atob(dataURI.split(",")[1]);
        const mimeType = dataURI.match(/(:)([a-z\/]+)(;)/)[2];
        for (
          var i = 0, l = byteString.length, content = new Uint8Array(l);
          l > i;
          i++
        ) {
          content[i] = byteString.charCodeAt(i);
        }
        return new Blob([content], {
          type: mimeType
        });
      }

      function jikanCulc(create_date) {
        //「月」を取得する
        var createTime = new Date(create_date * 1000);
        var MM = createTime.getMonth() + 1;
        //「日」を取得する
        var DD = createTime.getDate();
        //「時」を取得する
        var hh = createTime.getHours();
        //「分」を取得する
        var mm = createTime.getMinutes();
        if (hh < 10) {
          hh = "0" + hh;
        }
        if (mm < 10) {
          mm = "0" + mm;
        }
        var time = MM + "月" + DD + "日 " + hh + ":" + mm;
        return time;
      }
    </script>
  </body>
</html>
